{"version":3,"file":"login.js","names":["store","solidLogicSingleton","profile","loadPreferences","loadProfile","typeIndex","getScopedAppInstances","getRegistrations","loadAllTypeIndexes","getScopedAppsFromIndex","deleteTypeIndexRegistration","ensureLoggedIn","context","me","authn","currentUser","saveUser","Promise","resolve","checkUser","then","webId","debug","log","div","dom","box","loginStatusBox","webIdUri","appendChild","ensureLoadedPreferences","complain","message","statusArea","widgets","errorMessageBlock","preferencesFile","ensureLoadedProfile","progressDisplay","parentNode","removeChild","UnauthorizedError","m2","alert","CrossOriginForbiddenError","window","location","origin","preferencesFileError","SameOriginForbiddenError","warn","NotEditableError","WebOperationError","FetchError","status","Error","publicProfile","logInContext","findAppInstances","theClass","isPublic","items","filter","item","scope","label","instances","map","instance","scopeLabel","mine","sameTerm","agent","name","utils","registrationControl","registrationStatements","renderScopeCheckbox","statements","index","noun","buildCheckboxForm","form","registrations","reg","length","newThing","st","ns","solid","createElement","innerHTML","scopes","msg","textContent","setAttribute","tbody","children","BlankNode","row","renderScopeHeadingRow","backgroundColor","cell","style","backgoundColor","header","textAlign","registrationList","options","table","firstChild","headingRow","type","display","personTR","deleteFunction","paddingLeft","getDefaultSignInButtonStyle","signInOrSignUpBox","setUserCallback","signInButtonStyle","buttonStyle","magicClassName","signInPopUpButton","authSession","onLogin","webIdURI","uri","divs","getElementsByClassName","i","parent","e","addEventListener","offline","offlineTestID","renderSignInPopup","signupButton","_event","signupMgr","Signup","signup","issuerPopup","body","issuerPopupBox","issuerPopupBoxTopMenu","issuerPopupBoxLabel","innerText","issuerPopupBoxCloseButton","remove","loginToIssuer","issuerUri","preLoginRedirectHash","URL","href","hash","localStorage","setItem","login","redirectUrl","oidcIssuer","issuerTextContainer","issuerTextInputContainer","issuerTextLabel","issuerTextInput","value","getItem","issuerTextGoButton","issuerButtonContainer","issuerBottonLabel","getSuggestedIssuers","forEach","issuerInfo","issuerButton","listener","setIt","newidURI","refresh","logoutButtonHandler","oldMe","logout","err","logoutButton","logoutLabel","nick","any","foaf","signOutButton","clearElement","trackSession","onLogout","issuer","wellKnownUri","pathname","fetch","toString","wellKnownResult","json","openidConfiguration","end_session_endpoint","credentials","reload","selectWorkspace","appDetails","callbackWS","appPathSegment","say","s","background","figureOutBase","ws","newBaseNode","space","newBaseString","split","slice","now","Date","getTime","displayOptions","makeNewWorkspace","padding","encodeURI","askName","newBase","newWs","newData","updater","update","id","w","each","undefined","storages","concat","ldp","file","includes","toLowerCase","p","commentStyle","baseField","textInputStyle","size","autocomplete","button","replace","x","holds","rdf","col1","col2","col3","tr","comment","cellStyle","deselectedStyle","anyValue","ui","reduce","a","b","charCodeAt","bgcolor","target","rdfs","disabled","trLast","newAppInstance","callback","gotWS","base","getUserRoles","doc","filterAvailablePanes","panes","userRoles","pane","isMatchingAudience","audience","isMatch","audienceRole","find","role","equals"],"sources":["../../src/login/login.ts"],"sourcesContent":["/* eslint-disable camelcase */\n/**\n * Signing in, signing up, profile and preferences reloading\n * Type index management\n *\n * Many functions in this module take a context object which\n * holds various RDF symbols, add to it, and return a promise of it.\n *\n * * `me`                RDF symbol for the user's WebID\n * * `publicProfile`     The user's public profile, iff loaded\n * * `preferencesFile`   The user's personal preference file, iff loaded\n * * `index.public`      The user's public type index file\n * * `index.private`     The user's private type index file\n *\n * Not RDF symbols:\n * * `noun`            A string in english for the type of thing -- like \"address book\"\n * * `instance`        An array of nodes which are existing instances\n * * `containers`      An array of nodes of containers of instances\n * * `div`             A DOM element where UI can be displayed\n * * `statusArea`      A DOM element (opt) progress stuff can be displayed, or error messages\n * *\n * * Vocabulary:  \"load\" loads a file if it exists;\n * *  'Ensure\" CREATES the file if it does not exist (if it can) and then loads it.\n * @packageDocumentation\n */\nimport { PaneDefinition } from 'pane-registry'\nimport { BlankNode, NamedNode, st } from 'rdflib'\n// eslint-disable-next-line camelcase\nimport { Quad_Object } from 'rdflib/lib/tf-types'\nimport {\n  AppDetails,\n  AuthenticationContext,\n  authn,\n  authSession,\n  CrossOriginForbiddenError,\n  FetchError,\n  getSuggestedIssuers,\n  NotEditableError,\n  offlineTestID,\n  SameOriginForbiddenError,\n  solidLogicSingleton,\n  UnauthorizedError,\n  WebOperationError\n} from 'solid-logic'\nimport * as debug from '../debug'\nimport { alert } from '../log'\nimport * as ns from '../ns.js'\nimport { Signup } from '../signup/signup.js'\nimport { buttonStyle, commentStyle, textInputStyle } from '../style'\nimport * as utils from '../utils'\nimport * as widgets from '../widgets'\n\nconst store = solidLogicSingleton.store\n\nconst {\n  loadPreferences,\n  loadProfile\n} = solidLogicSingleton.profile\n\nconst {\n  getScopedAppInstances,\n  getRegistrations,\n  loadAllTypeIndexes,\n  getScopedAppsFromIndex,\n  deleteTypeIndexRegistration\n} = solidLogicSingleton.typeIndex\n\n/**\n * Resolves with the logged in user's WebID\n *\n * @param context\n */\n// used to be logIn\nexport function ensureLoggedIn (context: AuthenticationContext): Promise<AuthenticationContext> {\n  const me = authn.currentUser()\n  if (me) {\n    authn.saveUser(me, context)\n    return Promise.resolve(context)\n  }\n\n  return new Promise((resolve) => {\n    authn.checkUser().then((webId) => {\n      // Already logged in?\n      if (webId) {\n        debug.log(`logIn: Already logged in as ${webId}`)\n        return resolve(context)\n      }\n      if (!context.div || !context.dom) {\n        return resolve(context)\n      }\n      const box = loginStatusBox(context.dom, (webIdUri) => {\n        authn.saveUser(webIdUri, context)\n        resolve(context) // always pass growing context\n      })\n      context.div.appendChild(box)\n    })\n  })\n}\n\n/**\n * Loads preference file\n * Do this after having done log in and load profile\n *\n * @private\n *\n * @param context\n */\n// used to be logInLoadPreferences\nexport async function ensureLoadedPreferences (\n  context: AuthenticationContext\n): Promise<AuthenticationContext> {\n  if (context.preferencesFile) return Promise.resolve(context) // already done\n\n  const statusArea = context.statusArea || context.div || null\n  let progressDisplay\n  function complain (message) {\n    message = `ensureLoadedPreferences: ${message}`\n    if (statusArea) {\n      // statusArea.innerHTML = ''\n      statusArea.appendChild(widgets.errorMessageBlock(context.dom, message))\n    }\n    debug.log(message)\n    // reject(new Error(message))\n  }\n  try {\n    context = await ensureLoadedProfile(context)\n\n    // console.log('back in Solid UI after logInLoadProfile', context)\n    const preferencesFile = await loadPreferences(context.me as NamedNode)\n    if (progressDisplay) {\n      progressDisplay.parentNode.removeChild(progressDisplay)\n    }\n    context.preferencesFile = preferencesFile\n  } catch (err) {\n    let m2: string\n    if (err instanceof UnauthorizedError) {\n      m2 =\n        'Ooops - you are not authenticated (properly logged in) to for me to read your preference file.  Try loggin out and logging in?'\n      alert(m2)\n    } else if (err instanceof CrossOriginForbiddenError) {\n      m2 = `Unauthorized: Assuming preference file blocked for origin ${window.location.origin}`\n      context.preferencesFileError = m2\n      return context\n    } else if (err instanceof SameOriginForbiddenError) {\n      m2 =\n        'You are not authorized to read your preference file. This may be because you are using an untrusted web app.'\n      debug.warn(m2)\n      return context\n    } else if (err instanceof NotEditableError) {\n      m2 =\n        'You are not authorized to edit your preference file. This may be because you are using an untrusted web app.'\n      debug.warn(m2)\n      return context\n    } else if (err instanceof WebOperationError) {\n      m2 =\n        'You are not authorized to edit your preference file. This may be because you are using an untrusted web app.'\n      debug.warn(m2)\n    } else if (err instanceof FetchError) {\n      m2 = `Strange: Error ${err.status} trying to read your preference file.${err.message}`\n      alert(m2)\n    } else {\n      throw new Error(`(via loadPrefs) ${err}`)\n    }\n  }\n  return context\n}\n\n/**\n * Logs the user in and loads their WebID profile document into the store\n *\n * @param context\n *\n * @returns Resolves with the context after login / fetch\n */\n// used to be logInLoadProfile\nexport async function ensureLoadedProfile (\n  context: AuthenticationContext\n): Promise<AuthenticationContext> {\n  if (context.publicProfile) {\n    return context\n  } // already done\n  try {\n    const logInContext = await ensureLoggedIn(context)\n    if (!logInContext.me) {\n      throw new Error('Could not log in')\n    }\n    context.publicProfile = await loadProfile(logInContext.me)\n  } catch (err) {\n    if (context.div && context.dom) {\n      context.div.appendChild(widgets.errorMessageBlock(context.dom, err.message))\n    }\n    throw new Error(`Can't log in: ${err}`)\n  }\n  return context\n}\n\n/**\n  * Returns promise of context with arrays of symbols\n  *\n  * leaving the `isPublic` param undefined will bring in community index things, too\n  */\nexport async function findAppInstances (\n  context: AuthenticationContext,\n  theClass: NamedNode,\n  isPublic?: boolean\n): Promise<AuthenticationContext> {\n  let items = context.me ? await getScopedAppInstances(theClass, context.me) : []\n  if (isPublic === true) { // old API - not recommended!\n    items = items.filter(item => item.scope.label === 'public')\n  } else if (isPublic === false) {\n    items = items.filter(item => item.scope.label === 'private')\n  }\n  context.instances = items.map(item => item.instance)\n  return context\n}\n\nexport function scopeLabel (context, scope) {\n  const mine = context.me && context.me.sameTerm(scope.agent)\n  const name = mine ? '' : utils.label(scope.agent) + ' '\n  return `${name}${scope.label}`\n}\n/**\n * UI to control registration of instance\n */\nexport async function registrationControl (\n  context: AuthenticationContext,\n  instance,\n  theClass\n): Promise<AuthenticationContext | void> {\n  function registrationStatements (index) {\n    const registrations = getRegistrations(instance, theClass)\n    const reg = registrations.length ? registrations[0] : widgets.newThing(index)\n    return [\n      st(reg, ns.solid('instance'), instance, index),\n      st(reg, ns.solid('forClass'), theClass, index)\n    ]\n  }\n\n  function renderScopeCheckbox (scope) {\n    const statements = registrationStatements(scope.index)\n    const name = scopeLabel(context, scope)\n    const label = `${name} link to this ${context.noun}`\n    return widgets.buildCheckboxForm(\n      context.dom,\n      solidLogicSingleton.store,\n      label,\n      null,\n      statements,\n      form,\n      scope.index\n    )\n  }\n  /// / body of registrationControl\n  const dom = context.dom\n  if (!dom || !context.div) {\n    throw new Error('registrationControl: need dom and div')\n  }\n  const box = dom.createElement('div')\n  context.div.appendChild(box)\n  context.me = authn.currentUser() // @@\n  const me = context.me\n  if (!me) {\n    box.innerHTML = '<p style=\"margin:2em;\">(Log in to save a link to this)</p>'\n    return context\n  }\n\n  let scopes // @@ const\n  try {\n    scopes = await loadAllTypeIndexes(me)\n  } catch (e) {\n    let msg\n    if (context.div && context.preferencesFileError) {\n      msg = '(Lists of stuff not available)'\n      context.div.appendChild(dom.createElement('p')).textContent = msg\n    } else if (context.div) {\n      msg = `registrationControl: Type indexes not available: ${e}`\n      context.div.appendChild(widgets.errorMessageBlock(context.dom, e))\n    }\n    debug.log(msg)\n    return context\n  }\n\n  box.innerHTML = '<table><tbody></tbody></table>' // tbody will be inserted anyway\n  box.setAttribute('style', 'font-size: 120%; text-align: right; padding: 1em; border: solid gray 0.05em;')\n  const tbody = box.children[0].children[0]\n  const form = new BlankNode() // @@ say for now\n\n  for (const scope of scopes) {\n    const row = tbody.appendChild(dom.createElement('tr'))\n    row.appendChild(renderScopeCheckbox(scope)) // @@ index\n  }\n  return context\n}\n\nexport function renderScopeHeadingRow (context, store, scope) {\n  const backgroundColor = { private: '#fee', public: '#efe' }\n  const { dom } = context\n  const name = scopeLabel(context, scope)\n  const row = dom.createElement('tr')\n  const cell = row.appendChild(dom.createElement('td'))\n  cell.setAttribute('colspan', '3')\n  cell.style.backgoundColor = backgroundColor[scope.label] || 'white'\n  const header = cell.appendChild(dom.createElement('h3'))\n  header.textContent = name + ' links'\n  header.style.textAlign = 'left'\n  return row\n}\n/**\n  * UI to List at all registered things\n  */\nexport async function registrationList (context: AuthenticationContext, options: {\n  private?: boolean\n  public?: boolean\n  type?: NamedNode\n}): Promise<AuthenticationContext> {\n  const dom = context.dom as HTMLDocument\n  const div = context.div as HTMLElement\n\n  const box = dom.createElement('div')\n  div.appendChild(box)\n  context.me = authn.currentUser() // @@\n  if (!context.me) {\n    box.innerHTML = '<p style=\"margin:2em;\">(Log in list your stuff)</p>'\n    return context\n  }\n\n  const scopes = await loadAllTypeIndexes(context.me) // includes community indexes\n\n  // console.log('@@ registrationList ', scopes)\n  box.innerHTML = '<table><tbody></tbody></table>' // tbody will be inserted anyway\n  box.setAttribute('style', 'font-size: 120%; text-align: right; padding: 1em; border: solid #eee 0.5em;')\n  const table = box.firstChild as HTMLElement\n  const tbody = table.firstChild as HTMLElement\n\n  for (const scope of scopes) { // need some predicate for listing/adding agents\n    const headingRow = renderScopeHeadingRow(context, store, scope)\n    tbody.appendChild(headingRow)\n    const items = await getScopedAppsFromIndex(scope, options.type || null) // any class\n    if (items.length === 0) headingRow.style.display = 'none'\n    // console.log(`registrationList: @@ instance items for class ${options.type || 'undefined' }:`, items)\n    for (const item of items) {\n      const row = widgets.personTR(dom, ns.solid('instance'), item.instance, {\n        deleteFunction: async () => {\n          await deleteTypeIndexRegistration(item)\n          tbody.removeChild(row)\n        }\n      })\n      row.children[0].style.paddingLeft = '3em'\n\n      tbody.appendChild(row)\n    }\n  }\n  return context\n} // registrationList\n\nfunction getDefaultSignInButtonStyle (): string {\n  return 'padding: 1em; border-radius:0.5em; font-size: 100%;'\n}\n\n/**\n * Bootstrapping identity\n * (Called by `loginStatusBox()`)\n *\n * @param dom\n * @param setUserCallback\n *\n * @returns\n */\nfunction signInOrSignUpBox (\n  dom: HTMLDocument,\n  setUserCallback: (user: string) => void,\n  options: {\n    buttonStyle?: string;\n  } = {}\n): HTMLElement {\n  options = options || {}\n  const signInButtonStyle = options.buttonStyle || getDefaultSignInButtonStyle()\n\n  // @@ TODO Remove the need to cast HTML element to any\n  const box: any = dom.createElement('div')\n  const magicClassName = 'SolidSignInOrSignUpBox'\n  debug.log('widgets.signInOrSignUpBox')\n  box.setUserCallback = setUserCallback\n  box.setAttribute('class', magicClassName);\n  (box as any).style = 'display:flex;' // @@ fix all typecasts like this\n\n  // Sign in button with PopUP\n  const signInPopUpButton = dom.createElement('input') // multi\n  box.appendChild(signInPopUpButton)\n  signInPopUpButton.setAttribute('type', 'button')\n  signInPopUpButton.setAttribute('value', 'Log in')\n  signInPopUpButton.setAttribute('style', `${signInButtonStyle}background-color: #eef;`)\n\n  authSession.onLogin(() => {\n    const me = authn.currentUser()\n    // const sessionInfo = authSession.info\n    // if (sessionInfo && sessionInfo.isLoggedIn) {\n    if (me) {\n      // const webIdURI = sessionInfo.webId\n      const webIdURI = me.uri\n      // setUserCallback(webIdURI)\n      const divs = dom.getElementsByClassName(magicClassName)\n      debug.log(`Logged in, ${divs.length} panels to be serviced`)\n      // At the same time, satisfy all the other login boxes\n      for (let i = 0; i < divs.length; i++) {\n        const div: any = divs[i]\n        // @@ TODO Remove the need to manipulate HTML elements\n        if (div.setUserCallback) {\n          try {\n            div.setUserCallback(webIdURI)\n            const parent = div.parentNode\n            if (parent) {\n              parent.removeChild(div)\n            }\n          } catch (e) {\n            debug.log(`## Error satisfying login box: ${e}`)\n            div.appendChild(widgets.errorMessageBlock(dom, e))\n          }\n        }\n      }\n    }\n  })\n\n  signInPopUpButton.addEventListener(\n    'click',\n    () => {\n      const offline = offlineTestID()\n      if (offline) return setUserCallback(offline.uri)\n\n      renderSignInPopup(dom)\n    },\n    false\n  )\n\n  // Sign up button\n  const signupButton = dom.createElement('input')\n  box.appendChild(signupButton)\n  signupButton.setAttribute('type', 'button')\n  signupButton.setAttribute('value', 'Sign Up for Solid')\n  signupButton.setAttribute('style', `${signInButtonStyle}background-color: #efe;`)\n\n  signupButton.addEventListener(\n    'click',\n    function (_event) {\n      const signupMgr = new Signup()\n      signupMgr.signup().then(function (uri) {\n        debug.log('signInOrSignUpBox signed up ' + uri)\n        setUserCallback(uri)\n      })\n    },\n    false\n  )\n  return box\n}\n\nexport function renderSignInPopup (dom: HTMLDocument) {\n  /**\n   * Issuer Menu\n   */\n  const issuerPopup = dom.createElement('div')\n  issuerPopup.setAttribute(\n    'style',\n    'position: fixed; top: 0; left: 0; right: 0; bottom: 0; display: flex; justify-content: center; align-items: center;'\n  )\n  dom.body.appendChild(issuerPopup)\n  const issuerPopupBox = dom.createElement('div')\n  issuerPopupBox.setAttribute(\n    'style',\n    `\n      background-color: white;\n      box-shadow: 0px 1px 4px rgba(0, 0, 0, 0.2);\n      -webkit-box-shadow: 0px 1px 4px rgba(0, 0, 0, 0.2);\n      -moz-box-shadow: 0px 1px 4px rgba(0, 0, 0, 0.2);\n      -o-box-shadow: 0px 1px 4px rgba(0, 0, 0, 0.2);\n      border-radius: 4px;\n      min-width: 400px;\n      padding: 10px;\n    `\n  )\n  issuerPopup.appendChild(issuerPopupBox)\n  const issuerPopupBoxTopMenu = dom.createElement('div')\n  issuerPopupBoxTopMenu.setAttribute(\n    'style',\n    `\n      border-bottom: 1px solid #DDD;\n      display: flex;\n      flex-direction: row;\n      align-items: center;\n      justify-content: space-between;\n    `\n  )\n  issuerPopupBox.appendChild(issuerPopupBoxTopMenu)\n  const issuerPopupBoxLabel = dom.createElement('label')\n  issuerPopupBoxLabel.setAttribute('style', 'margin-right: 5px; font-weight: 800')\n  issuerPopupBoxLabel.innerText = 'Select an identity provider'\n  const issuerPopupBoxCloseButton = dom.createElement('button')\n  issuerPopupBoxCloseButton.innerHTML =\n    '<img src=\"https://solidos.github.io/solid-ui/src/icons/noun_1180156.svg\" style=\"width: 2em; height: 2em;\" title=\"Cancel\">'\n  issuerPopupBoxCloseButton.setAttribute('style', 'background-color: transparent; border: none;')\n  issuerPopupBoxCloseButton.addEventListener('click', () => {\n    issuerPopup.remove()\n  })\n  issuerPopupBoxTopMenu.appendChild(issuerPopupBoxLabel)\n  issuerPopupBoxTopMenu.appendChild(issuerPopupBoxCloseButton)\n\n  const loginToIssuer = async (issuerUri: string) => {\n    try {\n      // Save hash\n      const preLoginRedirectHash = new URL(window.location.href).hash\n      if (preLoginRedirectHash) {\n        window.localStorage.setItem('preLoginRedirectHash', preLoginRedirectHash)\n      }\n      window.localStorage.setItem('loginIssuer', issuerUri)\n      // Login\n      await authSession.login({\n        redirectUrl: window.location.href,\n        oidcIssuer: issuerUri\n      })\n    } catch (err) {\n      alert(err.message)\n    }\n  }\n\n  /**\n   * Text-based idp selection\n   */\n  const issuerTextContainer = dom.createElement('div')\n  issuerTextContainer.setAttribute(\n    'style',\n    `\n      border-bottom: 1px solid #DDD;\n      display: flex;\n      flex-direction: column;\n      padding-top: 10px;\n    `\n  )\n  const issuerTextInputContainer = dom.createElement('div')\n  issuerTextInputContainer.setAttribute(\n    'style',\n    `\n      display: flex;\n      flex-direction: row;\n    `\n  )\n  const issuerTextLabel = dom.createElement('label')\n  issuerTextLabel.innerText = 'Enter the URL of your identity provider:'\n  issuerTextLabel.setAttribute('style', 'color: #888')\n  const issuerTextInput = dom.createElement('input')\n  issuerTextInput.setAttribute('type', 'text')\n  issuerTextInput.setAttribute(\n    'style',\n    'margin-left: 0 !important; flex: 1; margin-right: 5px !important'\n  )\n  issuerTextInput.setAttribute('placeholder', 'https://example.com')\n  issuerTextInput.value = localStorage.getItem('loginIssuer') || ''\n  const issuerTextGoButton = dom.createElement('button')\n  issuerTextGoButton.innerText = 'Go'\n  issuerTextGoButton.setAttribute('style', 'margin-top: 12px; margin-bottom: 12px;')\n  issuerTextGoButton.addEventListener('click', () => {\n    loginToIssuer(issuerTextInput.value)\n  })\n  issuerTextContainer.appendChild(issuerTextLabel)\n  issuerTextInputContainer.appendChild(issuerTextInput)\n  issuerTextInputContainer.appendChild(issuerTextGoButton)\n  issuerTextContainer.appendChild(issuerTextInputContainer)\n  issuerPopupBox.appendChild(issuerTextContainer)\n\n  /**\n   * Button-based idp selection\n   */\n  const issuerButtonContainer = dom.createElement('div')\n  issuerButtonContainer.setAttribute(\n    'style',\n    `\n      display: flex;\n      flex-direction: column;\n      padding-top: 10px;\n    `\n  )\n  const issuerBottonLabel = dom.createElement('label')\n  issuerBottonLabel.innerText = 'Or pick an identity provider from the list below:'\n  issuerBottonLabel.setAttribute('style', 'color: #888')\n  issuerButtonContainer.appendChild(issuerBottonLabel)\n  getSuggestedIssuers().forEach((issuerInfo) => {\n    const issuerButton = dom.createElement('button')\n    issuerButton.innerText = issuerInfo.name\n    issuerButton.setAttribute('style', 'height: 38px; margin-top: 10px')\n    issuerButton.addEventListener('click', () => {\n      loginToIssuer(issuerInfo.uri)\n    })\n    issuerButtonContainer.appendChild(issuerButton)\n  })\n  issuerPopupBox.appendChild(issuerButtonContainer)\n}\n\n/**\n * Login status box\n *\n * A big sign-up/sign in box or a logout box depending on the state\n *\n * @param dom\n * @param listener\n *\n * @returns\n */\nexport function loginStatusBox (\n  dom: HTMLDocument,\n  listener: ((uri: string | null) => void) | null = null,\n  options: {\n    buttonStyle?: string;\n  } = {}\n): HTMLElement {\n  // 20190630\n  let me = offlineTestID()\n  // @@ TODO Remove the need to cast HTML element to any\n  const box: any = dom.createElement('div')\n\n  function setIt (newidURI) {\n    if (!newidURI) {\n      return\n    }\n\n    // const uri = newidURI.uri || newidURI\n    // me = sym(uri)\n    me = authn.saveUser(newidURI)\n    box.refresh()\n    if (listener) listener(me!.uri)\n  }\n\n  function logoutButtonHandler (_event) {\n    const oldMe = me\n    authSession.logout().then(\n      function () {\n        const message = `Your WebID was ${oldMe}. It has been forgotten.`\n        me = null\n        try {\n          alert(message)\n        } catch (e) {\n          window.alert(message)\n        }\n        box.refresh()\n        if (listener) listener(null)\n      },\n      (err) => {\n        alert('Fail to log out:' + err)\n      }\n    )\n  }\n\n  function logoutButton (me, options) {\n    const signInButtonStyle = options.buttonStyle || getDefaultSignInButtonStyle()\n    let logoutLabel = 'WebID logout'\n    if (me) {\n      const nick =\n        solidLogicSingleton.store.any(me, ns.foaf('nick')) ||\n        solidLogicSingleton.store.any(me, ns.foaf('name'))\n      if (nick) {\n        logoutLabel = 'Logout ' + nick.value\n      }\n    }\n    const signOutButton = dom.createElement('input')\n    // signOutButton.className = 'WebIDCancelButton'\n    signOutButton.setAttribute('type', 'button')\n    signOutButton.setAttribute('value', logoutLabel)\n    signOutButton.setAttribute('style', `${signInButtonStyle}background-color: #eee;`)\n    signOutButton.addEventListener('click', logoutButtonHandler, false)\n    return signOutButton\n  }\n\n  box.refresh = function () {\n    me = authn.currentUser()\n    if ((me && box.me !== me.uri) || (!me && box.me)) {\n      widgets.clearElement(box)\n      if (me) {\n        box.appendChild(logoutButton(me, options))\n      } else {\n        box.appendChild(signInOrSignUpBox(dom, setIt, options))\n      }\n    }\n    box.me = me ? me.uri : null\n  }\n  box.refresh()\n\n  function trackSession () {\n    me = authn.currentUser()\n    box.refresh()\n  }\n  trackSession()\n\n  authSession.onLogin(trackSession)\n  authSession.onLogout(trackSession)\n  box.me = '99999' // Force refresh\n  box.refresh()\n  return box\n}\n\nauthSession.onLogout(async () => {\n  const issuer = window.localStorage.getItem('loginIssuer')\n  if (issuer) {\n    try {\n      const wellKnownUri = new URL(issuer)\n      wellKnownUri.pathname = '/.well-known/openid-configuration'\n      const wellKnownResult = await fetch(wellKnownUri.toString())\n      if (wellKnownResult.status === 200) {\n        const openidConfiguration = await wellKnownResult.json()\n        if (openidConfiguration && openidConfiguration.end_session_endpoint) {\n          await fetch(openidConfiguration.end_session_endpoint, { credentials: 'include' })\n        }\n      }\n    } catch (err) {\n      // Do nothing\n    }\n  }\n  window.location.reload()\n})\n\n/**\n * Workspace selection etc\n * See https://github.com/solidos/userguide/issues/16\n */\n\n/**\n * Returns a UI object which, if it selects a workspace,\n * will callback(workspace, newBase).\n * See https://github.com/solidos/userguide/issues/16 for more info on workspaces.\n *\n * If necessary, will get an account, preference file, etc. In sequence:\n *\n *   - If not logged in, log in.\n *   - Load preference file\n *   - Prompt user for workspaces\n *   - Allows the user to just type in a URI by hand\n *\n * Calls back with the workspace and the base URI\n *\n * @param dom\n * @param appDetails\n * @param callbackWS\n */\nexport function selectWorkspace (\n  dom: HTMLDocument,\n  appDetails: AppDetails,\n  callbackWS: (workspace: string | null, newBase: string) => void\n): HTMLElement {\n  const noun = appDetails.noun\n  const appPathSegment = appDetails.appPathSegment\n\n  const me = offlineTestID()\n  const box = dom.createElement('div')\n  const context: AuthenticationContext = { me, dom, div: box }\n\n  function say (s, background) {\n    box.appendChild(widgets.errorMessageBlock(dom, s, background))\n  }\n\n  function figureOutBase (ws) {\n    const newBaseNode: NamedNode = solidLogicSingleton.store.any(\n      ws,\n      ns.space('uriPrefix')\n    ) as NamedNode\n    let newBaseString: string\n    if (!newBaseNode) {\n      newBaseString = ws.uri.split('#')[0]\n    } else {\n      newBaseString = newBaseNode.value\n    }\n    if (newBaseString.slice(-1) !== '/') {\n      debug.log(`${appPathSegment}: No / at end of uriPrefix ${newBaseString}`) // @@ paramater?\n      newBaseString = `${newBaseString}/`\n    }\n    const now = new Date()\n    newBaseString += `${appPathSegment}/id${now.getTime()}/` // unique id\n    return newBaseString\n  }\n\n  function displayOptions (context) {\n    // console.log('displayOptions!', context)\n    async function makeNewWorkspace (_event) {\n      const row = table.appendChild(dom.createElement('tr'))\n      const cell = row.appendChild(dom.createElement('td'))\n      cell.setAttribute('colspan', '3')\n      cell.style.padding = '0.5em'\n      const newBase = encodeURI(\n        await widgets.askName(\n          dom,\n          solidLogicSingleton.store,\n          cell,\n          ns.solid('URL'),\n          ns.space('Workspace'),\n          'Workspace'\n        )\n      )\n      const newWs = widgets.newThing(context.preferencesFile)\n      const newData = [\n        st(context.me, ns.space('workspace'), newWs, context.preferencesFile),\n        // eslint-disable-next-line camelcase\n        st(\n          newWs,\n          ns.space('uriPrefix'),\n          newBase as unknown as Quad_Object,\n          context.preferencesFile\n        )\n      ]\n      if (!solidLogicSingleton.store.updater) {\n        throw new Error('store has no updater')\n      }\n      await solidLogicSingleton.store.updater.update([], newData)\n      // @@ now refresh list of workspaces\n    }\n\n    // const status = ''\n    const id = context.me\n    const preferencesFile = context.preferencesFile\n    let newBase: any = null\n\n    // A workspace specifically defined in the private preference file:\n    let w: any = solidLogicSingleton.store.each(\n      id,\n      ns.space('workspace'),\n      undefined,\n      preferencesFile\n    ) // Only trust preference file here\n\n    // A workspace in a storage in the public profile:\n    const storages = solidLogicSingleton.store.each(id, ns.space('storage')) // @@ No provenance requirement at the moment\n    if (w.length === 0 && storages) {\n      say(\n        `You don't seem to have any workspaces. You have ${storages.length} storage spaces.`,\n        'white'\n      )\n      storages\n        .map(function (s: any) {\n          w = w.concat(solidLogicSingleton.store.each(s, ns.ldp('contains')))\n          return w\n        })\n        .filter((file) => {\n          return file.id ? ['public', 'private'].includes(file.id().toLowerCase()) : ''\n        })\n    }\n\n    if (w.length === 1) {\n      say(`Workspace used: ${w[0].uri}`, 'white') // @@ allow user to see URI\n      newBase = figureOutBase(w[0])\n      // callbackWS(w[0], newBase)\n      // } else if (w.length === 0) {\n    }\n\n    // Prompt for ws selection or creation\n    // say( w.length + \" workspaces for \" + id + \"Choose one.\");\n    const table = dom.createElement('table')\n    table.setAttribute('style', 'border-collapse:separate; border-spacing: 0.5em;')\n\n    // const popup = window.open(undefined, '_blank', { height: 300, width:400 }, false)\n    box.appendChild(table)\n\n    //  Add a field for directly adding the URI yourself\n\n    // const hr = box.appendChild(dom.createElement('hr')) // @@\n    box.appendChild(dom.createElement('hr')) // @@\n\n    const p = box.appendChild(dom.createElement('p'));\n    (p as any).style = commentStyle\n    p.textContent = `Where would you like to store the data for the ${noun}?\n    Give the URL of the folder where you would like the data stored.\n    It can be anywhere in solid world - this URI is just an idea.`\n    // @@ TODO Remove the need to cast baseField to any\n    const baseField: any = box.appendChild(dom.createElement('input'))\n    baseField.setAttribute('type', 'text');\n    (baseField as any).style = textInputStyle\n    baseField.size = 80 // really a string\n    baseField.label = 'base URL'\n    baseField.autocomplete = 'on'\n    if (newBase) {\n      // set to default\n      baseField.value = newBase\n    }\n\n    context.baseField = baseField\n\n    box.appendChild(dom.createElement('br')) // @@\n\n    const button = box.appendChild(dom.createElement('button'));\n    (button as any).style = buttonStyle\n    button.textContent = `Start new ${noun} at this URI`\n    button.addEventListener('click', function (_event) {\n      let newBase = baseField.value.replace(' ', '%20') // do not re-encode in general, as % encodings may exist\n      if (newBase.slice(-1) !== '/') {\n        newBase += '/'\n      }\n      callbackWS(null, newBase)\n    })\n\n    // Now go set up the table of spaces\n\n    // const row = 0\n    w = w.filter(function (x) {\n      return !solidLogicSingleton.store.holds(\n        x,\n        ns.rdf('type'), // Ignore master workspaces\n        ns.space('MasterWorkspace')\n      )\n    })\n    let col1, col2, col3, tr, ws, style, comment\n    const cellStyle = 'height: 3em; margin: 1em; padding: 1em white; border-radius: 0.3em;'\n    const deselectedStyle = `${cellStyle}border: 0px;`\n    // const selectedStyle = cellStyle + 'border: 1px solid black;'\n    for (let i = 0; i < w.length; i++) {\n      ws = w[i]\n      tr = dom.createElement('tr')\n      if (i === 0) {\n        col1 = dom.createElement('td')\n        col1.setAttribute('rowspan', `${w.length}`)\n        col1.textContent = 'Choose a workspace for this:'\n        col1.setAttribute('style', 'vertical-align:middle;')\n        tr.appendChild(col1)\n      }\n      col2 = dom.createElement('td')\n      style = solidLogicSingleton.store.anyValue(ws, ns.ui('style'))\n      if (!style) {\n        // Otherwise make up arbitrary colour\n        const hash = function (x) {\n          return x.split('').reduce(function (a, b) {\n            a = (a << 5) - a + b.charCodeAt(0)\n            return a & a\n          }, 0)\n        }\n        const bgcolor = `#${((hash(ws.uri) & 0xffffff) | 0xc0c0c0).toString(16)}` // c0c0c0  forces pale\n        style = `color: black ; background-color: ${bgcolor};`\n      }\n      col2.setAttribute('style', deselectedStyle + style)\n      tr.target = ws.uri\n      let label = solidLogicSingleton.store.any(ws, ns.rdfs('label'))\n      if (!label) {\n        label = ws.uri.split('/').slice(-1)[0] || ws.uri.split('/').slice(-2)[0]\n      }\n      col2.textContent = label || '???'\n      tr.appendChild(col2)\n      if (i === 0) {\n        col3 = dom.createElement('td')\n        col3.setAttribute('rowspan', `${w.length}1`)\n        // col3.textContent = '@@@@@ remove';\n        col3.setAttribute('style', 'width:50%;')\n        tr.appendChild(col3)\n      }\n      table.appendChild(tr)\n\n      comment = solidLogicSingleton.store.any(ws, ns.rdfs('comment'))\n      comment = comment ? comment.value : 'Use this workspace'\n      col2.addEventListener(\n        'click',\n        function (_event) {\n          col3.textContent = comment ? comment.value : ''\n          col3.setAttribute('style', deselectedStyle + style)\n          const button = dom.createElement('button')\n          button.textContent = 'Continue'\n          // button.setAttribute('style', style);\n          const newBase = figureOutBase(ws)\n          baseField.value = newBase // show user proposed URI\n\n          button.addEventListener(\n            'click',\n            function (_event) {\n              button.disabled = true\n              callbackWS(ws, newBase)\n              button.textContent = '---->'\n            },\n            true\n          ) // capture vs bubble\n          col3.appendChild(button)\n        },\n        true\n      ) // capture vs bubble\n    }\n\n    // last line with \"Make new workspace\"\n    const trLast = dom.createElement('tr')\n    col2 = dom.createElement('td')\n    col2.setAttribute('style', cellStyle)\n    col2.textContent = '+ Make a new workspace'\n    col2.addEventListener('click', makeNewWorkspace)\n    trLast.appendChild(col2)\n    table.appendChild(trLast)\n  } // displayOptions\n\n  // console.log('kicking off async operation')\n  ensureLoadedPreferences(context) // kick off async operation\n    .then(displayOptions)\n    .catch((err) => {\n      // console.log(\"err from async op\")\n      box.appendChild(widgets.errorMessageBlock(context.dom, err))\n    })\n\n  return box // return the box element, while login proceeds\n} // selectWorkspace\n\n/**\n * Creates a new instance of an app.\n *\n * An instance of an app could be e.g. an issue tracker for a given project,\n * or a chess game, or calendar, or a health/fitness record for a person.\n *\n * Note that this use of the term 'app' refers more to entries in the user's\n * type index than to actual software applications that use the personal data\n * to which these entries point.\n *\n * @param dom\n * @param appDetails\n * @param callback\n *\n * @returns A div with a button in it for making a new app instance\n */\nexport function newAppInstance (\n  dom: HTMLDocument,\n  appDetails: AppDetails,\n  callback: (workspace: string | null, newBase: string) => void\n): HTMLElement {\n  const gotWS = function (ws, base) {\n    // log.debug(\"newAppInstance: Selected workspace = \" + (ws? ws.uri : 'none'))\n    callback(ws, base)\n  }\n  const div = dom.createElement('div')\n  const b = dom.createElement('button')\n  b.setAttribute('type', 'button')\n  div.appendChild(b)\n  b.innerHTML = `Make new ${appDetails.noun}`\n  b.addEventListener(\n    'click',\n    (_event) => {\n      div.appendChild(selectWorkspace(dom, appDetails, gotWS))\n    },\n    false\n  )\n  div.appendChild(b)\n  return div\n}\n/**\n * Retrieves whether the currently logged in user is a power user\n * and/or a developer\n */\nexport async function getUserRoles (): Promise<Array<NamedNode>> {\n  try {\n    const { me, preferencesFile, preferencesFileError } = await ensureLoadedPreferences({})\n    if (!preferencesFile || preferencesFileError) {\n      throw new Error(preferencesFileError)\n    }\n    return solidLogicSingleton.store.each(\n      me,\n      ns.rdf('type'),\n      null,\n      preferencesFile.doc()\n    ) as NamedNode[]\n  } catch (error) {\n    debug.warn('Unable to fetch your preferences - this was the error: ', error)\n  }\n  return []\n}\n\n/**\n * Filters which panes should be available, based on the result of [[getUserRoles]]\n */\nexport async function filterAvailablePanes (\n  panes: Array<PaneDefinition>\n): Promise<Array<PaneDefinition>> {\n  const userRoles = await getUserRoles()\n  return panes.filter((pane) => isMatchingAudience(pane, userRoles))\n}\n\nfunction isMatchingAudience (pane: PaneDefinition, userRoles: Array<NamedNode>): boolean {\n  const audience = pane.audience || []\n  return audience.reduce(\n    (isMatch, audienceRole) => isMatch && !!userRoles.find((role) => role.equals(audienceRole)),\n    true as boolean\n  )\n}\n"],"mappings":"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"}