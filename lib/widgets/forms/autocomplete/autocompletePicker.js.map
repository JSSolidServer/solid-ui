{"version":3,"sources":["../../../../src/widgets/forms/autocomplete/autocompletePicker.ts"],"names":["AUTOCOMPLETE_THRESHOLD","AUTOCOMPLETE_ROWS","AUTOCOMPLETE_ROWS_STRETCH","AUTOCOMPLETE_DEBOUNCE_MS","setVisible","element","visible","style","visibility","renderAutoComplete","dom","acOptions","decoration","callback","complain","finish","gotIt","acceptButtonHandler","cancelButtonHandler","nameMatch","clearList","inputEventHHandler","loadBindingsAndFilterByLanguage","filterByName","refreshList","initialize","currentObject","searchInput","value","currentName","foundName","lastFilter","undefined","foundObject","deleteButton","acceptButton","editButton","cancelButton","inputEventHandlerLock","rowForBinding","binding","row","createElement","setStyle","setAttribute","color","allDisplayed","textContent","name","object","subject","nameTerm","addEventListener","_event","debug","log","languagePrefs","filter","trim","toLowerCase","length","numberOfRows","startsWith","lastBindings","slimmed","loadedEnough","table","appendChild","bindings","targetClass","defaultPreferedLangages","queryParams","AUTOCOMPLETE_LIMIT","runningTimeout","clearTimeout","setTimeout","children","removeChild","lastChild","candidate","parts","split","j","word","indexOf","permanent","div","parentNode","disbaled","termType","objectURIBase","kb","sym","message","errorRow","err","Error","widgets","errorMessageBlock","padding","head","cell","size","textInputSize","searchInputStyle","textInputStyle","event","keyCode"],"mappings":"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","sourcesContent":["/* Create and edit data using public data\n**\n** As the data source is passed as a parameter, all kinds of APIa and query services can be used\n**\n*/\nimport * as debug from '../../../debug'\nimport * as style from '../../../style'\nimport * as widgets from '../../../widgets'\nimport { kb } from '../../../logic'\nimport { NamedNode, Literal } from 'rdflib'\nimport { queryPublicDataByName, bindingToTerm, AUTOCOMPLETE_LIMIT, QueryParameters } from './publicData'\nimport { filterByLanguage, getPreferredLanguages, defaultPreferedLangages } from './language'\n\nconst AUTOCOMPLETE_THRESHOLD = 4 // don't check until this many characters typed\nconst AUTOCOMPLETE_ROWS = 20 // 20?\nconst AUTOCOMPLETE_ROWS_STRETCH = 40\nconst AUTOCOMPLETE_DEBOUNCE_MS = 300\n\n/*\nAutocomplete happens in 6 phases:\n  1. The search string is too small to bother\n  2. The search string is big enough, and we have not loaded the array\n  3. The search string is big enough, and we have loaded array up to the limit\n       Display them and wait for more user input\n  4. The search string is big enough, and we have loaded array NOT to the limit\n     but including all matches.   No more fetches.\n     If user gets more precise, wait for them to select one - or reduce to a single\n  5. Single one selected. Optionally waiting for accept button to be pressed, or can change string and go to 5 or 2\n  6. Locked with a value. Press 'edit' button to return to 5\n*/\n\nexport type AutocompleteDecoration = {\n  acceptButton?: HTMLElement,\n  cancelButton: HTMLElement, // Must have cancel button\n  editButton?: HTMLElement,\n  deleteButton?: HTMLElement\n}\nexport type AutocompleteOptions = {\n     targetClass?: NamedNode,\n     currentObject?: NamedNode,\n     currentName?: Literal,\n     queryParams: QueryParameters,\n     size?: number,\n     permanent?: boolean\n}\n\ninterface Callback1 {\n  (_subject: NamedNode, _name: Literal): any;\n}\n\n/*\nfunction assertString (x):string {\n  if (typeof x !== 'string') {\n    throw new Error('Expected this to be a string: ' + x)\n  }\n  return x\n}\nfunction assertNN (x):NamedNode {\n  if (!(x instanceof NamedNode)) {\n    throw new Error('Expected this to be a string: ' + x)\n  }\n  return x\n}\n*/\nexport function setVisible (element:HTMLElement, visible:boolean) {\n  element.style.visibility = visible ? 'visible' : 'collapse'\n}\n\n// The core of the autocomplete UI\nexport async function renderAutoComplete (dom: HTMLDocument,\n  acOptions:AutocompleteOptions,\n  decoration: AutocompleteDecoration,\n  callback: Callback1) {\n  function complain (message) {\n    const errorRow = table.appendChild(dom.createElement('tr'))\n    debug.log(message)\n    const err = new Error(message)\n    errorRow.appendChild(widgets.errorMessageBlock(dom, err, 'pink'))\n    // errorMessageBlock will log the stack to the console\n    style.setStyle(errorRow, 'autocompleteRowStyle')\n    errorRow.style.padding = '1em'\n  }\n  /*\n  function remove (ele?: HTMLElement) {\n    if (ele && ele.parentNode) {\n      ele.parentNode.removeChild(ele)\n    }\n  }\n  */\n  function finish (object, name) {\n    debug.log('Auto complete: finish! ' + object)\n    if (object.termType === 'Literal' && acOptions.queryParams.objectURIBase) {\n      object = kb.sym(acOptions.queryParams.objectURIBase.value + object.value)\n    }\n    // remove(decoration.cancelButton)\n    // remove(decoration.acceptButton)\n    // remove(div)\n    clearList()\n    callback(object, name)\n  }\n  async function gotIt (object:NamedNode | Literal, name: Literal) {\n    if (decoration.acceptButton) {\n      (decoration.acceptButton as any).disbaled = false\n      setVisible(decoration.acceptButton, true) // now wait for confirmation\n      searchInput.value = name.value // complete it\n      foundName = name\n      foundObject = object\n      debug.log('Auto complete: name: ' + name)\n      debug.log('Auto complete: waiting for accept ' + object)\n      clearList() // This may be an option - nice and clean but does not allow change of mind\n      return\n    }\n    setVisible(decoration.cancelButton, true)\n    finish(object, name)\n  }\n\n  async function acceptButtonHandler (_event) {\n    if (foundName && searchInput.value === foundName.value) { // still\n      finish(foundObject, foundName)\n    } else {\n      // (decoration.acceptButton as any).disabled = true\n    }\n  }\n\n  async function cancelButtonHandler (_event) {\n    debug.log('Auto complete: Canceled by user! ')\n    if (acOptions.permanent) {\n      initialize()\n    } else {\n      if (div.parentNode) {\n        div.parentNode.removeChild(div)\n      }\n    }\n  }\n\n  function nameMatch (filter:string, candidate: string):boolean {\n    const parts = filter.split(' ') // Each name part must be somewhere\n    for (let j = 0; j < parts.length; j++) {\n      const word = parts[j]\n      if (candidate.toLowerCase().indexOf(word) < 0) return false\n    }\n    return true\n  }\n\n  /*\n  function thinOut (filter) {\n    let hits = 0\n    let pick = undefined as NamedNode | Literal | undefined\n    let pickedName = undefined as Literal | undefined\n    for (let j = table.children.length - 1; j > 0; j--) { // backwards as we are removing rows\n      const row = table.children[j]\n      if (nameMatch(filter, row.textContent || '')) {\n        hits += 1\n        pick = (row as any).solidSubject as NamedNode | Literal\n        pickedName = (row as any).solidName as Literal\n        // pick = kb.sym(assertString(row.getAttribute('subject')))\n        // pickedName = row.textContent as string\n        ;(row as any).style.display = ''\n        // ;(row as any).style.color = 'blue' // @@ chose color\n        ;(row as any).style.color = allDisplayed ? '#080' : '#088' // green means 'you should find it here'\n      } else {\n        ;(row as any).style.display = 'none'\n      }\n    }\n    if (hits === 1) { // Maybe require green confirmation button be clicked?\n      debug.log(`  auto complete elimination:  \"${filter}\" -> \"${pickedName}\"`)\n      if (pick && pickedName) { // @@ for TS only.\n        gotIt(pick, pickedName)\n      }\n    }\n  }\n*/\n  function clearList () {\n    while (table.children.length > 1) {\n      table.removeChild(table.lastChild as Node)\n    }\n  }\n\n  async function inputEventHHandler (_event) {\n    setVisible(decoration.cancelButton, true) // only allow cancel when there is something to cancel\n    if (runningTimeout) {\n      clearTimeout(runningTimeout)\n    }\n    setTimeout(refreshList, AUTOCOMPLETE_DEBOUNCE_MS)\n  }\n\n  async function loadBindingsAndFilterByLanguage (filter, languagePrefs) {\n    let bindings\n    try {\n      bindings = await queryPublicDataByName(filter, targetClass as any,\n        languagePrefs || defaultPreferedLangages, acOptions.queryParams)\n    } catch (err) {\n      complain('Error querying db of organizations: ' + err)\n      inputEventHandlerLock = false\n      return\n    }\n    loadedEnough = bindings.length < AUTOCOMPLETE_LIMIT\n    if (loadedEnough) {\n      lastFilter = filter\n    } else {\n      lastFilter = undefined\n    }\n    clearList()\n    const slimmed = filterByLanguage(bindings, languagePrefs)\n    return slimmed\n  }\n\n  function filterByName (filter, bindings) {\n    return bindings.filter(binding => nameMatch(filter, binding.name.value))\n  }\n\n  async function refreshList () {\n    function rowForBinding (binding) {\n      const row = dom.createElement('tr')\n      style.setStyle(row, 'autocompleteRowStyle')\n      row.setAttribute('style', 'padding: 0.3em;')\n      row.style.color = allDisplayed ? '#080' : '#088' // green means 'you should find it here'\n      row.textContent = binding.name.value\n      const object = bindingToTerm(binding.subject)\n      const nameTerm = bindingToTerm(binding.name)\n      row.addEventListener('click', async _event => {\n        debug.log('       click row textContent: ' + row.textContent)\n        debug.log('       click name: ' + nameTerm.value)\n        if (object && nameTerm) {\n          gotIt(object, nameTerm as Literal)\n        }\n      })\n      return row\n    } // rowForBinding\n\n    if (inputEventHandlerLock) {\n      debug.log(`Ignoring \"${searchInput.value}\" because of lock `)\n      return\n    }\n    debug.log(`Setting lock at \"${searchInput.value}\"`)\n\n    inputEventHandlerLock = true\n    const languagePrefs = await getPreferredLanguages()\n    const filter = searchInput.value.trim().toLowerCase()\n    if (filter.length < AUTOCOMPLETE_THRESHOLD) { // too small\n      clearList()\n      // candidatesLoaded = false\n      numberOfRows = AUTOCOMPLETE_ROWS\n    } else {\n      if (!allDisplayed || !lastFilter || !filter.startsWith(lastFilter)) {\n        debug.log(`   Querying database at \"$(filter}\" cf last \"${lastFilter}\".`)\n        lastBindings = await loadBindingsAndFilterByLanguage(filter, languagePrefs) // freesh query\n      }\n      // Trim table as earach gets tighter:\n      const slimmed = filterByName(filter, lastBindings)\n      if (loadedEnough && slimmed.length <= AUTOCOMPLETE_ROWS_STRETCH) {\n        numberOfRows = slimmed.length // stretch if it means we get all items\n      }\n      allDisplayed = loadedEnough && slimmed.length <= numberOfRows\n      debug.log(` Filter:\"${filter}\" lastBindings: ${lastBindings.length}, slimmed to ${slimmed.length}; rows: ${numberOfRows}, Enough? ${loadedEnough}, All displayed? ${allDisplayed}`)\n\n      clearList()\n      for (const binding of slimmed) {\n        table.appendChild(rowForBinding(binding))\n      }\n      if (slimmed.length === 1) {\n        gotIt(bindingToTerm(slimmed[0].subject), bindingToTerm(slimmed[0].name) as Literal)\n      }\n    } // else\n    inputEventHandlerLock = false\n  } // refreshList\n\n  function initialize () {\n    if (acOptions.currentObject) { // If have existing value then jump into the endgame of the autocomplete\n      searchInput.value = acOptions.currentName ? acOptions.currentName.value : '??? wot no name for ' + acOptions.currentObject\n      foundName = acOptions.currentName\n      lastFilter = acOptions.currentName ? acOptions.currentName.value : undefined\n      foundObject = acOptions.currentObject\n    } else {\n      searchInput.value = ''\n      lastFilter = undefined\n      foundObject = undefined\n    }\n    if (decoration.deleteButton) {\n      setVisible(decoration.deleteButton, !!acOptions.currentObject)\n    }\n\n    if (decoration.acceptButton) {\n      setVisible(decoration.acceptButton, false) // hide until input complete\n    }\n    if (decoration.editButton) {\n      setVisible(decoration.editButton, true)\n    }\n    setVisible(decoration.cancelButton, false) // only allow cancel when there is something to cancel\n    inputEventHandlerLock = false\n    clearList()\n  } // initialiize\n\n  // const queryParams: QueryParameters = acOptions.queryParams\n  const targetClass = acOptions.targetClass\n  if (!targetClass) throw new Error('need  class')\n  if (decoration.acceptButton) {\n    decoration.acceptButton.addEventListener('click', acceptButtonHandler, false)\n  }\n  if (decoration.cancelButton) {\n    decoration.cancelButton.addEventListener('click', cancelButtonHandler, false)\n  }\n\n  // var candidatesLoaded = false\n  let lastBindings\n  let loadedEnough = false\n  const runningTimeout = undefined as any\n  let inputEventHandlerLock = false\n  let allDisplayed = false\n  let lastFilter = undefined as (string | undefined)\n  let numberOfRows = AUTOCOMPLETE_ROWS // this gets slimmed down\n  const div = dom.createElement('div')\n  let foundName = undefined as (Literal | undefined)// once found accepted string must match this\n  let foundObject = undefined as (NamedNode | Literal | undefined)\n  const table = div.appendChild(dom.createElement('table'))\n  table.setAttribute('style', 'max-width: 30em; margin: 0.5em;')\n  const head = table.appendChild(dom.createElement('tr'))\n  style.setStyle(head, 'autocompleteRowStyle') // textInputStyle or\n  const cell = head.appendChild(dom.createElement('td'))\n  const searchInput = cell.appendChild(dom.createElement('input'))\n  searchInput.setAttribute('type', 'text')\n\n  initialize()\n\n  const size = acOptions.size || style.textInputSize || 20\n  searchInput.setAttribute('size', size)\n\n  const searchInputStyle = style.textInputStyle || // searchInputStyle ?\n    'border: 0.1em solid #444; border-radius: 0.5em; width: 100%; font-size: 100%; padding: 0.1em 0.6em' // @\n  searchInput.setAttribute('style', searchInputStyle)\n  searchInput.addEventListener('keyup', function (event) {\n    if (event.keyCode === 13) {\n      acceptButtonHandler(event)\n    }\n  }, false)\n\n  searchInput.addEventListener('input', inputEventHHandler)\n  return div\n} // renderAutoComplete\n\n// ENDS\n"],"file":"autocompletePicker.js"}