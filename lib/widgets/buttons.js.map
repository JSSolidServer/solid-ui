{"version":3,"sources":["../../src/widgets/buttons.ts"],"names":["utils","require","error","dragAndDrop","cancelIconURI","iconBase","checkIconURI","getStatusArea","context","box","statusArea","div","dom","document","body","getElementsByTagName","createElement","insertBefore","firstElementChild","complain","err","ele","debug","log","appendChild","errorMessageBlock","alert","clearElement","firstChild","removeChild","extractLogURI","fullURI","logPos","search","rulPos","substring","shortDate","str","noTime","month","nowZ","Date","toISOString","slice","parseInt","e","formatDateTime","date","format","split","map","s","k","width","Milliseconds","FullYear","d","Month","join","timestamp","shortTime","setName","element","x","kb","store","findName","name","any","ns","vcard","foaf","value","sameTerm","textContent","label","uri","fetcher","nowOrWhenFetched","doc","undefined","_ok","imagesOf","each","sioc","concat","iconForClass","tempSite","p","indexOf","Error","q","findImageFromURI","iconDir","length","startsWith","findImage","thing","rdf","image","trySetImage","iconForClassMap","explitImage","setAttribute","typeIcon","style","classIconStyle","schemeIcon","types","findTypeURIs","typeURI","setImage","pref","id","theClass","happy","ok","faviconOrDefault","iconStyle","isOrigin","parts","res","deleteButtonWithCheck","container","noun","deleteFunction","minusIconURI","img","title","deleteButtonElt","addEventListener","_event","cancelButtonElt","buttonStyle","sureButtonElt","getButtonStyle","options","color","buttonColor","backgroundColor","fontColor","borderColor","hoverBackgroundColor","hoverFontColor","needsBorder","border","cursor","padding","transition","outline","button","iconURI","text","handler","innerText","toLocaleUpperCase","head","textButton","classes","classList","add","cancelButton","continueButton","askName","predicate","Promise","resolve","_reject","form","prompt","namefield","textInputStyle","select","gotName","parentNode","trim","keyCode","focus","linkIcon","subject","anchor","originalIconBase","personTR","pred","obj","tr","td1","td2","td3","link","draggable","makeDraggable","refreshTree","root","refresh","i","children","attachmentList","modify","promptIcon","wf","attachmentOuter","attachmentOne","attachmentLeft","attachmentRight","attachmentTable","deleteAttachment","target","updater","update","errorBody","_xhr","createNewRow","theTarget","opt","things","sort","syncTableToArray","droppedURIHandler","uris","ins","u","push","droppedFileHandler","files","uploadFolder","theFile","destURI","sym","paperclip","fhandler","makeDropTarget","buttonDiv","fileUploadButtonDiv","openHrefInOutlineMode","preventDefault","stopPropagation","getTarget","getAttribute","window","outlineManager","GotoSubject","panes","getOutliner","defaultAnnotationStore","hash","slash","lastIndexOf","allClassURIs","set","statementsMatching","st","object","rdfs","c","propertyTriage","possibleProperties","dp","op","no","nd","nu","pi","predicateIndex","termType","ps","toNT","linkButton","b","removeButton","selectorPanel","type","inverse","possible","callbackFunction","linkCallback","selectorPanelRefresh","list","style0","selected","innerHTML","refreshItem","item","setStyle","already","iconDiv","connectIcon","f","index","twoLine","widgetForClass","nav","a","event","twoLineDefault","twoLineWidgetForClass","widget","sup","findSuperClassesNT","cl","fromNT","twoLineTransaction","failed","enc","y","qu","escapeForXML","twoLineTrip","dc","cal","addStyleSheet","href","links","querySelectorAll","isAudio","file","isImage","isVideo","kind","dcCLasses","audio","video","what","typeURIs","prefix","Util","mediaTypeClass","t","input","buttonElt","click","line"],"mappings":"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","sourcesContent":["import { IndexedFormula, NamedNode, st, sym, uri, Util } from 'rdflib'\nimport { iconBase, originalIconBase } from '../iconBase'\nimport store from '../store'\nimport ns from '../ns'\nimport style from '../style'\nimport * as debug from '../debug'\nimport { info } from '../log'\nimport { getClasses } from '../jss'\nimport { uploadFiles } from './dragAndDrop.js'\n\n/**\n * UI Widgets such as buttons\n * @packageDocumentation\n */\n\n/* global alert */\n\nconst utils = require('../utils')\n\nconst error = require('./error')\nconst dragAndDrop = require('./dragAndDrop')\n\nconst cancelIconURI = iconBase + 'noun_1180156.svg' // black X\nconst checkIconURI = iconBase + 'noun_1180158.svg' // green checkmark; Continue\n\nexport type StatusAreaContext = {\n  statusArea?: HTMLElement\n  div?: HTMLElement\n  dom?: HTMLDocument\n}\nexport type ButtonType = 'Primary' | 'Secondary'\n\nexport type ButtonWidgetOptions = {\n  buttonColor?: ButtonType,\n  needsBorder?: boolean\n}\nfunction getStatusArea (context?: StatusAreaContext) {\n  var box = (context && context.statusArea) || (context && context.div) || null\n  if (box) return box\n  let dom = context && context.dom\n  if (!dom && typeof document !== 'undefined') {\n    dom = document\n  }\n  if (dom) {\n    var body = dom.getElementsByTagName('body')[0]\n    box = dom.createElement('div')\n    body.insertBefore((box as unknown as HTMLElement), body.firstElementChild)\n    if (context) {\n      context.statusArea = (box as unknown as HTMLElement)\n    }\n    return box\n  }\n  return null\n}\n\n/**\n * Display an error message block\n */\nexport function complain (context?: StatusAreaContext, err?: string) {\n  if (!err) return // only if error\n  var ele = getStatusArea(context)\n  debug.log('Complaint: ' + err)\n  if (ele) ele.appendChild(error.errorMessageBlock((context && context.dom) || document, err))\n  else alert(err)\n}\n\n/**\n * Remove all the children of an HTML element\n */\nexport function clearElement (ele: HTMLElement) {\n  while (ele.firstChild) {\n    ele.removeChild(ele.firstChild)\n  }\n  return ele\n}\n\n/**\n * To figure out the log URI from the full URI used to invoke the reasoner\n */\nexport function extractLogURI (fullURI) {\n  var logPos = fullURI.search(/logFile=/)\n  var rulPos = fullURI.search(/&rulesFile=/)\n  return fullURI.substring(logPos + 8, rulPos)\n}\n\n/**\n * By default, converts e.g. '2020-02-19T19:35:28.557Z' to '19:35'\n * if today is 19 Feb 2020, and to 'Feb 19' if not.\n * @@@ TODO This needs to be changed to local time\n * @param noTime Return a string like 'Feb 19' even if it's today.\n */\nexport function shortDate (str?: string, noTime?: boolean): string {\n  if (!str) return '???'\n  var month = [\n    'Jan',\n    'Feb',\n    'Mar',\n    'Apr',\n    'May',\n    'Jun',\n    'Jul',\n    'Aug',\n    'Sep',\n    'Oct',\n    'Nov',\n    'Dec'\n  ]\n  try {\n    var nowZ = new Date().toISOString()\n    // var nowZ = $rdf.term(now).value\n    // var n = now.getTimezoneOffset() // Minutes\n    if (str.slice(0, 10) === nowZ.slice(0, 10) && !noTime) {\n      return str.slice(11, 16)\n    }\n    if (str.slice(0, 4) === nowZ.slice(0, 4)) {\n      return (\n        month[parseInt(str.slice(5, 7), 10) - 1] +\n        ' ' +\n        parseInt(str.slice(8, 10), 10)\n      )\n    }\n    return str.slice(0, 10)\n  } catch (e) {\n    return 'shortdate:' + e\n  }\n}\n\n/**\n * Format a date and time\n * @param date for instance `new Date()`\n * @param format  for instance '{FullYear}-{Month}-{Date}T{Hours}:{Minutes}:{Seconds}.{Milliseconds}'\n * @returns for instance '2000-01-15T23:14:23.002'\n */\nexport function formatDateTime (date: Date, format: string): string {\n  return format\n    .split('{')\n    .map(function (s) {\n      var k = s.split('}')[0]\n      var width = { Milliseconds: 3, FullYear: 4 }\n      var d = { Month: 1 }\n      return s\n        ? ('000' + (date['get' + k]() + (d[k] || 0))).slice(-(width[k] || 2)) + s.split('}')[1]\n        : ''\n    })\n    .join('')\n}\n\n/**\n * Get a string representation of the current time\n * @returns for instance '2000-01-15T23:14:23.002'\n */\nexport function timestamp (): string {\n  return formatDateTime(\n    new Date(),\n    '{FullYear}-{Month}-{Date}T{Hours}:{Minutes}:{Seconds}.{Milliseconds}'\n  )\n}\n\n/**\n * Get a short string representation of the current time\n * @returns for instance '23:14:23.002'\n */\nexport function shortTime (): string {\n  return formatDateTime(\n    new Date(),\n    '{Hours}:{Minutes}:{Seconds}.{Milliseconds}'\n  )\n}\n\n// ///////////////////// Handy UX widgets\n\n/**\n * Sets the best name we have and looks up a better one\n */\nexport function setName (element: HTMLElement, x: NamedNode) {\n  var kb = store\n  var findName = function (x) {\n    var name =\n      kb.any(x, ns.vcard('fn')) ||\n      kb.any(x, ns.foaf('name')) ||\n      kb.any(x, ns.vcard('organization-name'))\n    return name ? name.value : null\n  }\n  var name = x.sameTerm(ns.foaf('Agent')) ? 'Everyone' : findName(x)\n  element.textContent = name || utils.label(x)\n  if (!name && x.uri) {\n    // Note this is only a fetch, not a lookUP of all sameAs etc\n    kb.fetcher.nowOrWhenFetched(x.doc(), undefined, function (_ok) {\n      element.textContent = findName(x) || utils.label(x) // had: (ok ? '' : '? ') +\n    })\n  }\n}\n\n/**\n * Set of suitable images\n * See also [[findImage]]\n * @param x The thing for which we want to find an image\n * @param kb The RDF store to look in\n * @returns It goes looking for triples in `kb`,\n *          `(subject: x), (predicate: see list below) (object: image-url)`\n *          to find any image linked from the thing with one of the following\n *          predicates (in order):\n *          * ns.sioc('avatar')\n *          * ns.foaf('img')\n *          * ns.vcard('logo')\n *          * ns.vcard('hasPhoto')\n *          * ns.vcard('photo')\n *          * ns.foaf('depiction')\n\n */\nexport function imagesOf (x: NamedNode | null, kb: IndexedFormula): any[] {\n  return kb\n    .each(x, ns.sioc('avatar'))\n    .concat(kb.each(x, ns.foaf('img')))\n    .concat(kb.each(x, ns.vcard('logo')))\n    .concat(kb.each(x, ns.vcard('hasPhoto')))\n    .concat(kb.each(x, ns.vcard('photo')))\n    .concat(kb.each(x, ns.foaf('depiction')))\n}\n\n/**\n * Best logo or avatar or photo etc to represent someone or some group etc\n */\nexport const iconForClass = {\n  // Potentially extendable by other apps, panes, etc\n  // Relative URIs to the iconBase\n  'solid:AppProviderClass': 'noun_144.svg', //  @@ classs name should not contain 'Class'\n  'solid:AppProvider': 'noun_15177.svg', // @@\n  'solid:Pod': 'noun_Cabinet_1434380.svg',\n  'vcard:Group': 'noun_339237.svg',\n  'vcard:Organization': 'noun_143899.svg',\n  'vcard:Individual': 'noun_15059.svg',\n  'schema:Person': 'noun_15059.svg',\n  'foaf:Person': 'noun_15059.svg',\n  'foaf:Agent': 'noun_98053.svg',\n  'acl:AuthenticatedAgent': 'noun_99101.svg',\n  'prov:SoftwareAgent': 'noun_Robot_849764.svg', // Bot\n  'vcard:AddressBook': 'noun_15695.svg',\n  'trip:Trip': 'noun_581629.svg',\n  'meeting:LongChat': 'noun_1689339.svg',\n  'meeting:Meeting': 'noun_66617.svg',\n  'meeting:Project': 'noun_1036577.svg',\n  'ui:Form': 'noun_122196.svg',\n  'rdfs:Class': 'class-rectangle.svg', // For RDF developers\n  'rdf:Property': 'property-diamond.svg',\n  'owl:Ontology': 'noun_classification_1479198.svg',\n  'wf:Tracker': 'noun_122196.svg',\n  'wf:Task': 'noun_17020_gray-tick.svg',\n  'wf:Open': 'noun_17020_sans-tick.svg',\n  'wf:Closed': 'noun_17020.svg'\n}\n\n/**\n * Returns the origin of the URI of a NamedNode\n */\nfunction tempSite (x: NamedNode) {\n  // use only while one in rdflib fails with origins 2019\n  var str = x.uri.split('#')[0]\n  var p = str.indexOf('//')\n  if (p < 0) throw new Error('This URI does not have a web site part (origin)')\n  var q = str.indexOf('/', p + 2)\n  if (q < 0) {\n    // no third slash?\n    return str.slice(0) + '/' // Add slash to a bare origin\n  } else {\n    return str.slice(0, q + 1)\n  }\n}\n\n/**\n * Find an image for this thing as a class\n */\nexport function findImageFromURI (x: NamedNode | string): string | null {\n  const iconDir = iconBase\n\n  // Special cases from URI scheme:\n  if (typeof x !== 'string' && x.uri) {\n    if (\n      x.uri.split('/').length === 4 &&\n      !x.uri.split('/')[1] &&\n      !x.uri.split('/')[3]\n    ) {\n      return iconDir + 'noun_15177.svg' // App -- this is an origin\n    }\n    // Non-HTTP URI types imply types\n    if (x.uri.startsWith('message:') || x.uri.startsWith('mid:')) {\n      // message: is apple bug-- should be mid:\n      return iconDir + 'noun_480183.svg' // envelope  noun_567486\n    }\n    if (x.uri.startsWith('mailto:')) {\n      return iconDir + 'noun_567486.svg' // mailbox - an email desitination\n    }\n    // For HTTP(s) documents, we could look at the MIME type if we know it.\n    if (x.uri.startsWith('https:') && x.uri.indexOf('#') < 0) {\n      return tempSite(x) + 'favicon.ico' // was x.site().uri + ...\n      // Todo: make the document icon a fallback for if the favicon does not exist\n      // todo: pick up a possible favicon for the web page itself from a link\n      // was: return iconDir + 'noun_681601.svg' // document - under solid assumptions\n    }\n    return null\n  }\n\n  return iconDir + 'noun_10636_grey.svg' // Grey Circle -  some thing\n}\n\n/**\n * Find something we have as explicit image data for the thing\n * See also [[imagesOf]]\n * @param thing The thing for which we want to find an image\n * @returns The URL of a globe icon if thing equals `ns.foaf('Agent')`\n *          or `ns.rdf('Resource')`. Otherwise, it goes looking for\n *          triples in `store`,\n *          `(subject: thing), (predicate: see list below) (object: image-url)`\n *          to find any image linked from the thing with one of the following\n *          predicates (in order):\n *          * ns.sioc('avatar')\n *          * ns.foaf('img')\n *          * ns.vcard('logo')\n *          * ns.vcard('hasPhoto')\n *          * ns.vcard('photo')\n *          * ns.foaf('depiction')\n */\nexport function findImage (thing: NamedNode): string {\n  const kb = store\n  const iconDir = iconBase\n  if (thing.sameTerm(ns.foaf('Agent')) || thing.sameTerm(ns.rdf('Resource'))) {\n    return iconDir + 'noun_98053.svg' // Globe\n  }\n  const image =\n    kb.any(thing, ns.sioc('avatar')) ||\n    kb.any(thing, ns.foaf('img')) ||\n    kb.any(thing, ns.vcard('logo')) ||\n    kb.any(thing, ns.vcard('hasPhoto')) ||\n    kb.any(thing, ns.vcard('photo')) ||\n    kb.any(thing, ns.foaf('depiction'))\n  return image ? image.uri : null\n}\n\n/**\n * Do the best you can with the data available\n *\n * @return {Boolean} Are we happy with this icon?\n * Sets src AND STYLE of the image.\n */\nfunction trySetImage (element, thing, iconForClassMap) {\n  const kb = store\n\n  const explitImage = findImage(thing)\n  if (explitImage) {\n    element.setAttribute('src', explitImage)\n    return true\n  }\n  // This is one of the classes we know about - the class itself?\n  const typeIcon = iconForClassMap[thing.uri]\n  if (typeIcon) {\n    element.setAttribute('src', typeIcon)\n    element.style = style.classIconStyle\n    // element.style.border = '0.1em solid green;'\n    // element.style.backgroundColor = '#eeffee' // pale green\n    return true\n  }\n  const schemeIcon = findImageFromURI(thing)\n  if (schemeIcon) {\n    element.setAttribute('src', schemeIcon)\n    return true // happy with this -- don't look it up\n  }\n\n  // Do we have a generic icon for something in any class its in?\n  const types = kb.findTypeURIs(thing)\n  for (var typeURI in types) {\n    if (iconForClassMap[typeURI]) {\n      element.setAttribute('src', iconForClassMap[typeURI])\n      return false // maybe we can do better\n    }\n  }\n  element.setAttribute('src', iconBase + 'noun_10636_grey.svg') // Grey Circle -  some thing\n  return false // we can do better\n}\n\n/**\n * ToDo: Also add icons for *properties* like  home, work, email, range, domain, comment,\n */\nexport function setImage (element: HTMLElement, thing: NamedNode) { // 20191230a\n  const kb = store\n\n  var iconForClassMap = {}\n  for (var k in iconForClass) {\n    const pref = k.split(':')[0]\n    const id = k.split(':')[1]\n    const theClass = ns[pref](id)\n    iconForClassMap[theClass.uri] = uri.join(iconForClass[k], iconBase)\n  }\n\n  const happy = trySetImage(element, thing, iconForClassMap)\n  if (!happy && thing.uri) {\n    kb.fetcher.nowOrWhenFetched(thing.doc(), undefined, (ok) => {\n      if (ok) {\n        trySetImage(element, thing, iconForClassMap)\n      }\n    })\n  }\n}\n\n// If a web page then a favicon with a fallback to\n// See eg http://stackoverflow.com/questions/980855/inputting-a-default-image\nfunction faviconOrDefault (dom: HTMLDocument, x: NamedNode) {\n  var image = dom.createElement('img')\n  ;(image as any).style = style.iconStyle\n  var isOrigin = function (x) {\n    if (!x.uri) return false\n    var parts = x.uri.split('/')\n    return parts.length === 3 || (parts.length === 4 && parts[3] === '')\n  }\n  image.setAttribute(\n    'src',\n    iconBase + (isOrigin(x) ? 'noun_15177.svg' : 'noun_681601.svg') // App symbol vs document\n  )\n  if (x.uri && x.uri.startsWith('https:') && x.uri.indexOf('#') < 0) {\n    var res = dom.createElement('object') // favico with a fallback of a default image if no favicon\n    res.setAttribute('data', tempSite(x) + 'favicon.ico')\n    res.setAttribute('type', 'image/x-icon')\n    res.appendChild(image) // fallback\n    return res\n  } else {\n    setImage(image, x)\n    return image\n  }\n}\n\n/**\n * Delete button with a check you really mean it\n * @@ Supress check if command key held down?\n */\nexport function deleteButtonWithCheck (\n  dom: HTMLDocument,\n  container: HTMLElement,\n  noun: string,\n  deleteFunction: () => any\n) {\n  var minusIconURI = iconBase + 'noun_2188_red.svg' // white minus in red #cc0000 circle\n\n  // var delButton = dom.createElement('button')\n\n  var img = dom.createElement('img')\n  img.setAttribute('src', minusIconURI) //  plus sign\n  img.setAttribute('style', 'margin: 0.2em; width: 1em; height:1em')\n  img.title = 'Remove this ' + noun\n  var deleteButtonElt = img\n\n  container.appendChild(deleteButtonElt)\n  container.setAttribute('class', 'hoverControl') // See tabbedtab.css (sigh global CSS)\n  deleteButtonElt.setAttribute('class', 'hoverControlHide')\n  // delButton.setAttribute('style', 'color: red; margin-right: 0.3em; foat:right; text-align:right')\n  deleteButtonElt.addEventListener(\n    'click',\n    function (_event) {\n      container.removeChild(deleteButtonElt) // Ask -- are you sure?\n      var cancelButtonElt = dom.createElement('button')\n      // cancelButton.textContent = 'cancel'\n      cancelButtonElt.setAttribute('style', style.buttonStyle)\n      var img = cancelButtonElt.appendChild(dom.createElement('img'))\n      img.setAttribute('src', cancelIconURI)\n      img.setAttribute('style', style.buttonStyle)\n\n      container.appendChild(cancelButtonElt).addEventListener(\n        'click',\n        function (_event) {\n          container.removeChild(sureButtonElt)\n          container.removeChild(cancelButtonElt)\n          container.appendChild(deleteButtonElt)\n        },\n        false\n      )\n      var sureButtonElt = dom.createElement('button')\n      sureButtonElt.textContent = 'Delete ' + noun\n      sureButtonElt.setAttribute('style', style.buttonStyle)\n      container.appendChild(sureButtonElt).addEventListener(\n        'click',\n        function (_event) {\n          container.removeChild(sureButtonElt)\n          container.removeChild(cancelButtonElt)\n          deleteFunction()\n        },\n        false\n      )\n    },\n    false\n  )\n  return deleteButtonElt\n}\n\n/**\n * Get the button style, based on options.\n * See https://design.inrupt.com/atomic-core/?cat=Atoms#Buttons\n */\nfunction getButtonStyle (options: ButtonWidgetOptions = {}) {\n  // default to primary color\n  const color: string = (options.buttonColor === 'Secondary') ? '#01c9ea' : '#7c4dff'\n  let backgroundColor: string = color\n  let fontColor: string = '#ffffff'\n  let borderColor: string = color\n  // default to primary color\n  let hoverBackgroundColor: string = (options.buttonColor === 'Secondary') ? '#37cde6' : '#9f7dff'\n  let hoverFontColor: string = fontColor\n  if (options.needsBorder) {\n    backgroundColor = '#ffffff'\n    fontColor = color\n    borderColor = color\n    hoverBackgroundColor = color\n    hoverFontColor = backgroundColor\n  }\n\n  return {\n    'background-color': `${backgroundColor}`,\n    color: `${fontColor}`,\n    'font-family': 'Raleway, Roboto, sans-serif',\n    'border-radius': '0.25em',\n    'border-color': `${borderColor}`,\n    border: '1px solid',\n    cursor: 'pointer',\n    'font-size': '.8em',\n    'text-decoration': 'none',\n    padding: '0.5em 4em',\n    transition: '0.25s all ease-in-out',\n    outline: 'none',\n    '&:hover': {\n      'background-color': `${hoverBackgroundColor}`,\n      color: `${hoverFontColor}`,\n      transition: '0.25s all ease-in-out'\n    }\n  }\n}\n\n/*  Make a button\n *\n * @param dom - the DOM document object\n * @Param iconURI - the URI of the icon to use (if any)\n * @param text - the tooltip text or possibly button contents text\n * @param handler <function> - A handler to called when button is clicked\n *\n * @returns <dDomElement> - the button\n */\nexport function button (dom: HTMLDocument, iconURI: string | undefined, text: string,\n  handler?: (event: any) => void,\n  options: ButtonWidgetOptions = { buttonColor: 'Primary', needsBorder: false }) {\n  var button = dom.createElement('button')\n  button.setAttribute('type', 'button')\n  // button.innerHTML = text  // later, user preferences may make text preferred for some\n  if (iconURI) {\n    var img = button.appendChild(dom.createElement('img'))\n    img.setAttribute('src', iconURI)\n    img.setAttribute('style', 'width: 2em; height: 2em;') // trial and error. 2em disappears\n    img.title = text\n    button.setAttribute('style', style.buttonStyle)\n  } else {\n    button.innerText = text.toLocaleUpperCase()\n    const style = getButtonStyle(options)\n    const { classes } = getClasses(dom.head, {\n      textButton: style\n    })\n\n    button.classList.add(classes.textButton)\n  }\n  if (handler) {\n    button.addEventListener('click', handler, false)\n  }\n  return button\n}\n\n/*  Make a cancel button\n *\n * @param dom - the DOM document object\n * @param handler <function> - A handler to called when button is clicked\n *\n * @returns <dDomElement> - the button\n */\nexport function cancelButton (dom: HTMLDocument, handler: (event: any) => void) {\n  return button(dom, cancelIconURI, 'Cancel', handler)\n}\n\n/*  Make a continue button\n *\n * @param dom - the DOM document object\n * @param handler <function> - A handler to called when button is clicked\n *\n * @returns <dDomElement> - the button\n */\nexport function continueButton (dom: HTMLDocument, handler: (event: any) => void) {\n  return button(dom, checkIconURI, 'Continue', handler)\n}\n\n/* Grab a name for a new thing\n *\n * Form to get the name of a new thing before we create it\n * @params theClass  Misspelt to avoid clashing with the JavaScript keyword\n * @returns: a promise of (a name or null if cancelled)\n */\nexport function askName (\n  dom: HTMLDocument,\n  kb: IndexedFormula,\n  container: HTMLDivElement,\n  predicate?: NamedNode,\n  theClass?: NamedNode,\n  noun?: string) {\n  // eslint-disable-next-line promise/param-names\n  return new Promise(function (resolve, _reject) {\n    var form = dom.createElement('div') // form is broken as HTML behaviour can resurface on js error\n    // classLabel = utils.label(ns.vcard('Individual'))\n    predicate = predicate || ns.foaf('name') // eg 'name' in user's language\n    noun = noun || (theClass ? utils.label(theClass) : '  ') // eg 'folder' in users's language\n    var prompt = noun + ' ' + utils.label(predicate) + ': '\n    form.appendChild(dom.createElement('p')).textContent = prompt\n    var namefield = dom.createElement('input')\n    namefield.setAttribute('type', 'text')\n    namefield.setAttribute('size', '100')\n    namefield.setAttribute('maxLength', '2048') // No arbitrary limits\n    namefield.setAttribute('style', style.textInputStyle)\n    namefield.select() // focus next user input\n    form.appendChild(namefield)\n    container.appendChild(form)\n\n    // namefield.focus()\n\n    function gotName () {\n      ((form as HTMLElement).parentNode as HTMLElement).removeChild(form)\n      resolve(namefield.value.trim())\n    }\n\n    namefield.addEventListener('keyup', function (e) {\n      if (e.keyCode === 13) {\n        gotName()\n      }\n    }, false)\n\n    form.appendChild(dom.createElement('br'))\n\n    form.appendChild(cancelButton(dom, function (_event) {\n      ((form as HTMLElement).parentNode as HTMLElement).removeChild(form)\n      resolve(null)\n    }))\n\n    form.appendChild(continueButton(dom, function (_event) {\n      gotName()\n    }))\n    namefield.focus()\n  }) // Promise\n}\n\n// ////////////////////////////////////////////////////////////////\n\n/**\n * A little link icon\n */\nexport function linkIcon (dom: HTMLDocument, subject: NamedNode, iconURI?: string): HTMLElement {\n  var anchor = dom.createElement('a')\n  anchor.setAttribute('href', subject.uri)\n  if (subject.uri.startsWith('http')) {\n    // If diff web page\n    anchor.setAttribute('target', '_blank') // open in a new tab or window\n  } // as mailboxes and mail messages do not need new browser window\n  var img = anchor.appendChild(dom.createElement('img'))\n  img.setAttribute(\n    'src',\n    iconURI || originalIconBase + 'go-to-this.png'\n  )\n  img.setAttribute('style', 'margin: 0.3em;')\n  return anchor\n}\n\n/**\n * A TR to represent a draggable person, etc in a list\n *\n * pred is unused param at the moment\n */\nexport function personTR (dom: HTMLDocument, pred: NamedNode, obj: NamedNode, options: any): HTMLTableRowElement {\n  var tr = dom.createElement('tr')\n  options = options || {}\n  // tr.predObj = [pred.uri, obj.uri]   moved to acl-control\n  var td1 = tr.appendChild(dom.createElement('td'))\n  var td2 = tr.appendChild(dom.createElement('td'))\n  var td3 = tr.appendChild(dom.createElement('td'))\n\n  // var image = td1.appendChild(dom.createElement('img'))\n  var image = faviconOrDefault(dom, obj)\n\n  td1.setAttribute('style', 'vertical-align: middle; width:2.5em; padding:0.5em; height: 2.5em;')\n  td2.setAttribute('style', 'vertical-align: middle; text-align:left;')\n  td3.setAttribute('style', 'vertical-align: middle; width:2em; padding:0.5em; height: 4em;')\n  td1.appendChild(image)\n\n  setName(td2, obj)\n  if (options.deleteFunction) {\n    deleteButtonWithCheck(dom, td3, options.noun || 'one', options.deleteFunction)\n  }\n  if (obj.uri) {\n    // blank nodes need not apply\n    if (options.link !== false) {\n      var anchor = td3.appendChild(linkIcon(dom, obj))\n      anchor.classList.add('HoverControlHide')\n      td3.appendChild(dom.createElement('br'))\n    }\n    if (options.draggable !== false) {\n      // default is on\n      image.setAttribute('draggable', 'false') // Stop the image being dragged instead - just the TR\n      dragAndDrop.makeDraggable(tr, obj)\n    }\n  }\n  ;(tr as any).subject = obj\n  return tr\n}\n\n/**\n * Refresh a DOM tree recursively\n */\nexport function refreshTree (root: any): void {\n  if (root.refresh) {\n    root.refresh()\n    return\n  }\n  for (var i = 0; i < root.children.length; i++) {\n    refreshTree(root.children[i])\n  }\n}\n\n/**\n * Options argument for [[attachmentList]] function\n */\nexport type attachmentListOptions = {\n  doc?: NamedNode\n  modify?: boolean\n  promptIcon?: string\n  predicate?: NamedNode\n  uploadFolder?: NamedNode\n  noun?: string\n}\n\n/**\n * Component that displays a list of resources, for instance\n * the attachments of a message, or the various documents related\n * to a meeting.\n * Accepts dropping URLs onto it to add attachments to it.\n */\nexport function attachmentList (dom: HTMLDocument, subject: NamedNode, div: HTMLElement, options: attachmentListOptions = {}) {\n  // options = options || {}\n  var doc = options.doc || subject.doc()\n  if (options.modify === undefined) options.modify = true\n  var modify = options.modify\n  var promptIcon: string = options.promptIcon || (iconBase + 'noun_748003.svg' as string) //    target\n  // var promptIcon = options.promptIcon || (iconBase + 'noun_25830.svg') //  paperclip\n  var predicate = options.predicate || ns.wf('attachment')\n  var noun = options.noun || 'attachment'\n\n  var kb = store\n  var attachmentOuter = div.appendChild(dom.createElement('table'))\n  attachmentOuter.setAttribute('style', 'margin-top: 1em; margin-bottom: 1em;')\n  var attachmentOne = attachmentOuter.appendChild(dom.createElement('tr'))\n  var attachmentLeft = attachmentOne.appendChild(dom.createElement('td'))\n  var attachmentRight = attachmentOne.appendChild(dom.createElement('td'))\n  var attachmentTable = attachmentRight.appendChild(dom.createElement('table'))\n  attachmentTable.appendChild(dom.createElement('tr')) // attachmentTableTop\n\n  var deleteAttachment = function (target) {\n    kb.updater.update(st(subject, predicate, target, doc), [], function (\n      uri,\n      ok,\n      errorBody,\n      _xhr\n    ) {\n      if (ok) {\n        refresh()\n      } else {\n        complain(undefined, 'Error deleting one: ' + errorBody)\n      }\n    })\n  }\n  var createNewRow = function (target) {\n    var theTarget = target\n    var opt: any = { noun: noun }\n    if (modify) {\n      opt.deleteFunction = function () {\n        deleteAttachment(theTarget)\n      }\n    }\n    return personTR(dom, predicate, target, opt)\n  }\n  var refresh = ((attachmentTable as any).refresh = function () {\n    var things = kb.each(subject, predicate)\n    things.sort()\n    utils.syncTableToArray(attachmentTable, things, createNewRow)\n  })\n  ;(attachmentOuter as any).refresh = refresh // Participate in downstream changes\n  refresh()\n\n  function droppedURIHandler (uris) {\n    var ins: any = []\n    uris.map(function (u) {\n      var target = sym(u) // Attachment needs text label to disinguish I think not icon.\n      debug.log('Dropped on attachemnt ' + u) // icon was: iconBase + 'noun_25830.svg'\n      ins.push(st(subject, predicate, target, doc))\n    })\n    kb.updater.update([], ins, function (uri, ok, errorBody, _xhr) {\n      if (ok) {\n        refresh()\n      } else {\n        complain(undefined, 'Error adding one: ' + errorBody)\n      }\n    })\n  }\n\n  function droppedFileHandler (files) {\n    uploadFiles(\n      kb.fetcher,\n      files,\n      options.uploadFolder?.uri, // Files\n      options.uploadFolder?.uri, // Pictures\n      function (theFile, destURI) {\n        const ins = [st(subject, predicate, kb.sym(destURI), doc)]\n        kb.updater.update([], ins, function (uri, ok, errorBody, _xhr) {\n          if (ok) {\n            refresh()\n          } else {\n            complain(undefined, 'Error adding link to uploaded file: ' + errorBody)\n          }\n        })\n      }\n    )\n  }\n\n  if (modify) {\n    // const buttonStyle = 'width; 2em; height: 2em; margin: 0.5em; padding: 0.1em;'\n    const paperclip = button(dom, promptIcon, 'Drop attachments here')\n    // paperclip.style = buttonStyle // @@ needed?  default has white background\n    attachmentLeft.appendChild(paperclip)\n    const fhandler = options.uploadFolder ? droppedFileHandler : null\n    dragAndDrop.makeDropTarget(paperclip, droppedURIHandler, fhandler) // beware missing the wire of the paparclip!\n    dragAndDrop.makeDropTarget(attachmentLeft, droppedURIHandler, fhandler) // just the outer won't do it\n\n    if (options.uploadFolder) { // Addd an explicit file upload button as well\n      const buttonDiv = fileUploadButtonDiv(dom, droppedFileHandler)\n      attachmentLeft.appendChild(buttonDiv)\n      // buttonDiv.children[1].style =  buttonStyle\n    }\n  }\n  return attachmentOuter\n}\n\n// /////////////////////////////////////////////////////////////////////////////\n\n/**\n * Event Handler for links within solid apps.\n *\n * Note that native links have constraints in Firefox, they\n * don't work with local files for instance (2011)\n */\nexport function openHrefInOutlineMode (e: Event) {\n  e.preventDefault()\n  e.stopPropagation()\n  var target = utils.getTarget(e)\n  var uri = target.getAttribute('href')\n  if (!uri) return debug.log('openHrefInOutlineMode: No href found!\\n')\n  const dom = window.document\n  if ((dom as any).outlineManager) {\n    // @@ TODO Remove the use of document as a global object\n    ;(dom as any).outlineManager.GotoSubject(store.sym(uri), true, undefined, true, undefined)\n  } else if (window && (window as any).panes && (window as any).panes.getOutliner) {\n    // @@ TODO Remove the use of window as a global object\n    ;(window as any).panes\n      .getOutliner()\n      .GotoSubject(store.sym(uri), true, undefined, true, undefined)\n  } else {\n    debug.log('ERROR: Can\\'t access outline manager in this config')\n  }\n  // dom.outlineManager.GotoSubject(store.sym(uri), true, undefined, true, undefined)\n}\n\n/**\n * Make a URI in the Tabulator.org annotation store out of the URI of the thing to be annotated.\n *\n * @@ Todo: make it a personal preference.\n */\nexport function defaultAnnotationStore (subject) {\n  if (subject.uri === undefined) return undefined\n  var s = subject.uri\n  if (s.slice(0, 7) !== 'http://') return undefined\n  s = s.slice(7) // Remove\n  var hash = s.indexOf('#')\n  if (hash >= 0) s = s.slice(0, hash)\n  // Strip trailing\n  else {\n    var slash = s.lastIndexOf('/')\n    if (slash < 0) return undefined\n    s = s.slice(0, slash)\n  }\n  return store.sym('http://tabulator.org/wiki/annnotation/' + s)\n}\n\n/**\n * Retrieve all RDF class URIs from solid-ui's RDF store\n * @returns an object `ret` such that `Object.keys(ret)` is\n * the list of all class URIs.\n */\nexport function allClassURIs (): { [uri: string]: boolean } {\n  var set = {}\n  store\n    .statementsMatching(undefined, ns.rdf('type'), undefined)\n    .map(function (st) {\n      if (st.object.uri) set[st.object.uri] = true\n    })\n  store\n    .statementsMatching(undefined, ns.rdfs('subClassOf'), undefined)\n    .map(function (st) {\n      if (st.object.uri) set[st.object.uri] = true\n      if (st.subject.uri) set[st.subject.uri] = true\n    })\n  store\n    .each(undefined, ns.rdf('type'), ns.rdfs('Class'))\n    .map(function (c) {\n      if (c.uri) set[c.uri] = true\n    })\n  return set\n}\n\n/**\n * Figuring which properties we know about\n *\n * When the user inputs an RDF property, like for a form field\n * or when specifying the relationship between two arbitrary things,\n * then er can prompt them with properties the session knows about\n *\n * TODO: Look again by catching this somewhere. (On the kb?)\n * TODO: move to diff module? Not really a button.\n * @param {Store} kb The quadstore to be searched.\n */\n\nexport function propertyTriage (kb: IndexedFormula): any {\n  var possibleProperties: any = {}\n  // if (possibleProperties === undefined) possibleProperties = {}\n  // var kb = store\n  var dp = {}\n  var op = {}\n  var no = 0\n  var nd = 0\n  var nu = 0\n  var pi = (kb as any).predicateIndex // One entry for each pred\n  for (var p in pi) {\n    var object = pi[p][0].object\n    if (object.termType === 'Literal') {\n      dp[p] = true\n      nd++\n    } else {\n      op[p] = true\n      no++\n    }\n  } // If nothing discovered, then could be either:\n  var ps = kb.each(undefined, ns.rdf('type'), ns.rdf('Property'))\n  for (var i = 0; i < ps.length; i++) {\n    p = ps[i].toNT()\n    // log.debug('propertyTriage: unknown: ' + p)\n    if (!op[p] && !dp[p]) {\n      dp[p] = true\n      op[p] = true\n      nu++\n    }\n  }\n  possibleProperties.op = op\n  possibleProperties.dp = dp\n  info(`propertyTriage: ${no} non-lit, ${nd} literal. ${nu} unknown.`)\n  return possibleProperties\n}\n\n/**\n * General purpose widgets\n */\n\n/**\n * A button for jumping\n */\nexport function linkButton (dom: HTMLDocument, object: NamedNode): HTMLElement {\n  var b = dom.createElement('button')\n  b.setAttribute('type', 'button')\n  b.textContent = 'Goto ' + utils.label(object)\n  b.addEventListener('click', function (_event) {\n    // b.parentNode.removeChild(b)\n    ;(dom as any).outlineManager.GotoSubject(object, true, undefined, true, undefined)\n  }, true)\n  return b\n}\n\n/**\n * A button to remove some other element from the page\n */\nexport function removeButton (dom: HTMLDocument, element: HTMLElement) {\n  var b = dom.createElement('button')\n  b.setAttribute('type', 'button')\n  b.textContent = '✕' // MULTIPLICATION X\n  b.addEventListener('click', function (_event) {\n    ;(element as any).parentNode.removeChild(element)\n  }, true)\n  return b\n}\n\n//      Description text area\n//\n// Make a box to demand a description or display existing one\n//\n// @param dom - the document DOM for the user interface\n// @param kb - the graph which is the knowledge base we are working with\n// @param subject - a term, the subject of the statement(s) being edited.\n// @param predicate - a term, the predicate of the statement(s) being edited\n// @param store - The web document being edited\n// @param callbackFunction - takes (boolean ok, string errorBody)\n\n// /////////////////////////////////////// Random I/O widgets /////////////\n\n// ////              Column Header Buttons\n//\n//  These are for selecting different modes, sources,styles, etc.\n//\n/*\nbuttons.headerButtons = function (dom, kb, name, words) {\n    var box = dom.createElement('table')\n    var i, word, s = '<tr>'\n    box.setAttribute('style', 'width: 90%; height: 1.5em')\n    for (i=0; i<words.length; i++) {\n        s += '<td><input type=\"radio\" name=\"' + name + '\" id=\"' + words[i] + '\" value='\n    }\n    box.innerHTML = s + '</tr>'\n\n}\n*/\n// ////////////////////////////////////////////////////////////\n//\n//     selectorPanel\n//\n//  A vertical panel for selecting connections to left or right.\n//\n//   @param inverse means this is the object rather than the subject\n//\nexport function selectorPanel (\n  dom: HTMLDocument,\n  kb: IndexedFormula,\n  type: NamedNode,\n  predicate: NamedNode,\n  inverse: boolean,\n  possible: NamedNode[],\n  options: { connectIcon?: string },\n  callbackFunction: (x: NamedNode, e: Event, selected: boolean) => void,\n  linkCallback: (x: NamedNode, e: Event, inverse: boolean, setStyleFunction: () => void) => void\n) {\n  return selectorPanelRefresh(\n    dom.createElement('div'),\n    dom,\n    kb,\n    type,\n    predicate,\n    inverse,\n    possible,\n    options,\n    callbackFunction,\n    linkCallback\n  )\n}\n\nexport function selectorPanelRefresh (\n  list: HTMLElement,\n  dom: HTMLDocument,\n  kb: IndexedFormula,\n  type: NamedNode,\n  predicate: NamedNode,\n  inverse: boolean,\n  possible: NamedNode[],\n  options: { connectIcon?: string },\n  callbackFunction: (x: NamedNode, e: Event, selected: boolean) => void,\n  linkCallback: (x: NamedNode, e: Event, inverse: boolean, setStyleFunction: () => void) => void\n) {\n  var style0 =\n    'border: 0.1em solid #ddd; border-bottom: none; width: 95%; height: 2em; padding: 0.5em;'\n  var selected: any = null\n  list.innerHTML = ''\n\n  var refreshItem = function (box: HTMLElement, x: NamedNode) {\n    // Scope to hold item and x\n    var item, image\n\n    var setStyle = function () {\n      var already = inverse\n        ? kb.each(undefined, predicate, x)\n        : kb.each(x, predicate)\n      iconDiv.setAttribute('class', already.length === 0 ? 'hideTillHover' : '') // See tabbedtab.css\n      image.setAttribute(\n        'src',\n        options.connectIcon || iconBase + 'noun_25830.svg'\n      )\n      image.setAttribute('title', already.length ? already.length : 'attach')\n    }\n    var f = index.twoLine.widgetForClass(type)\n    item = f(dom, x)\n    item.setAttribute('style', style0)\n\n    var nav = dom.createElement('div')\n    nav.setAttribute('class', 'hideTillHover') // See tabbedtab.css\n    nav.setAttribute('style', 'float:right; width:10%')\n\n    var a = dom.createElement('a')\n    a.setAttribute('href', x.uri)\n    a.setAttribute('style', 'float:right')\n    nav.appendChild(a).textContent = '>'\n    box.appendChild(nav)\n\n    var iconDiv = dom.createElement('div')\n    iconDiv.setAttribute(\n      'style',\n      (inverse ? 'float:left;' : 'float:right;') + ' width:30px;'\n    )\n    image = dom.createElement('img')\n    setStyle()\n    iconDiv.appendChild(image)\n    box.appendChild(iconDiv)\n\n    item.addEventListener('click', function (event) {\n      if (selected === item) {\n        // deselect\n        item.setAttribute('style', style0)\n        selected = null\n      } else {\n        if (selected) selected.setAttribute('style', style0)\n        item.setAttribute(\n          'style',\n          style0 + 'background-color: #ccc; color:black;'\n        )\n        selected = item\n      }\n      callbackFunction(x, event, selected === item)\n      setStyle()\n    }, false)\n\n    image.addEventListener('click', function (event) {\n      linkCallback(x, event, inverse, setStyle)\n    }, false)\n\n    box.appendChild(item)\n    return box\n  }\n\n  for (var i = 0; i < possible.length; i++) {\n    var box = dom.createElement('div')\n    list.appendChild(box)\n    refreshItem(box, possible[i])\n  }\n  return list\n}\n\n// ###########################################################################\n//\n//      Small compact views of things\n//\nexport let index: any = {}\n// ///////////////////////////////////////////////////////////////////////////\n// We need these for anything which is a subject of an attachment.\n//\n// These should be moved to type-dependeent UI code. Related panes maybe\n\nfunction twoLineDefault (dom: HTMLDocument, x: NamedNode): HTMLElement {\n  // Default\n  var box = dom.createElement('div')\n  box.textContent = utils.label(x)\n  return box\n}\n\n/**\n * Find a function that can create a widget for a given class\n * @param c The RDF class for which we want a widget generator function\n */\nfunction twoLineWidgetForClass (c: NamedNode): (dom: HTMLDocument, x: NamedNode) => HTMLElement {\n  var widget = index.twoLine[c.uri]\n  var kb = store\n  if (widget) return widget\n  var sup = kb.findSuperClassesNT(c)\n  for (var cl in sup) {\n    widget = index.twoLine[kb.fromNT(cl).uri]\n    if (widget) return widget\n  }\n  return index.twoLine['']\n}\n\n/**\n * Display a transaction\n * @param x Should have attributes through triples in store:\n *          * ns.qu('payee') -> a named node\n *          * ns.qu('date) -> a literal\n *          * ns.qu('amount') -> a literal\n */\nfunction twoLineTransaction (dom: HTMLDocument, x: NamedNode): HTMLElement {\n  var failed = ''\n  var enc = function (p) {\n    var y = store.any(x, ns.qu(p))\n    if (!y) failed += '@@ No value for ' + p + '! '\n    return y ? utils.escapeForXML(y.value) : '?' // @@@@\n  }\n  var box = dom.createElement('table')\n  box.innerHTML = `\n      <tr>\n      <td colspan=\"2\"> ${enc('payee')}</td>\n      < /tr>\n      < tr >\n      <td>${enc('date').slice(0, 10)}</td>\n      <td style = \"text-align: right;\">${enc('amount')}</td>\n      </tr>`\n  if (failed) {\n    box.innerHTML = `\n      <tr>\n        <td><a href=\"${utils.escapeForXML(x.uri)}\">${utils.escapeForXML(failed)}</a></td>\n      </tr>`\n  }\n  return box\n}\n\n/**\n * Display a trip\n * @param x Should have attributes through triples in store:\n *          * ns.dc('title') -> a literal\n *          * ns.cal('dtstart') -> a literal\n *          * ns.cal('dtend') -> a literal\n */\nfunction twoLineTrip (\n  dom: HTMLDocument,\n  x: NamedNode\n): HTMLElement {\n  var enc = function (p) {\n    var y = store.any(x, p)\n    return y ? utils.escapeForXML(y.value) : '?'\n  }\n  var box = dom.createElement('table')\n  box.innerHTML = `\n    <tr>\n      <td colspan=\"2\">${enc(ns.dc('title'))}</td>\n    </tr>\n    <tr style=\"color: #777\">\n      <td>${enc(ns.cal('dtstart'))}</td>\n      <td>${enc(ns.cal('dtend'))}</td>\n    </tr>`\n  return box\n}\n\n/**\n * Stick a stylesheet link the document if not already there\n */\nexport function addStyleSheet (dom: HTMLDocument, href: string): void {\n  var links = dom.querySelectorAll('link')\n  for (var i = 0; i < links.length; i++) {\n    if (\n      (links[i].getAttribute('rel') || '') === 'stylesheet' &&\n      (links[i].getAttribute('href') || '') === href\n    ) {\n      return\n    }\n  }\n  var link = dom.createElement('link')\n  link.setAttribute('rel', 'stylesheet')\n  link.setAttribute('type', 'text/css')\n  link.setAttribute('href', href)\n  dom.getElementsByTagName('head')[0].appendChild(link)\n}\n\n// Figure (or guess) whether this is an image, etc\n//\nexport function isAudio (file?: NamedNode) {\n  return isImage(file, 'audio')\n}\nexport function isVideo (file?: NamedNode) {\n  return isImage(file, 'video')\n}\n/**\n *\n */\nexport function isImage (file?: NamedNode, kind?: string): boolean {\n  var dcCLasses = {\n    audio: 'http://purl.org/dc/dcmitype/Sound',\n    image: 'http://purl.org/dc/dcmitype/Image',\n    video: 'http://purl.org/dc/dcmitype/MovingImage'\n  }\n  var what = kind || 'image'\n  // See https://github.com/linkeddata/rdflib.js/blob/e367d5088c/src/formula.ts#L554\n  //\n  var typeURIs = store.findTypeURIs(file)\n  // See https://github.com/linkeddata/rdflib.js/blob/d5000f/src/utils-js.js#L14\n  // e.g.'http://www.w3.org/ns/iana/media-types/audio'\n  var prefix: string = Util.mediaTypeClass(what + '/*').uri.split('*')[0]\n  for (var t in typeURIs) {\n    if (t.startsWith(prefix)) return true\n  }\n  if (dcCLasses[what] in typeURIs) return true\n  return false\n}\n\n/**\n * File upload button\n * @param dom The DOM aka document\n * @param  droppedFileHandler Same handler function as drop, takes array of file objects\n * @returns {Element} - a div with a button and a inout in it\n * The input is hidden, as it is uglky - the user clicks on the nice icons and fires the input.\n */\n// See https://developer.mozilla.org/en-US/docs/Web/API/File/Using_files_from_web_applications\nexport function fileUploadButtonDiv (\n  dom: HTMLDocument,\n  droppedFileHandler: (files: FileList) => void\n) {\n  const div = dom.createElement('div')\n  const input = div.appendChild(dom.createElement('input'))\n  input.setAttribute('type', 'file')\n  input.setAttribute('multiple', 'true')\n  input.addEventListener(\n    'change',\n    (event: any) => {\n      debug.log('File drop event: ', event)\n      if (event.files) {\n        droppedFileHandler(event.files)\n      } else if (event.target && event.target.files) {\n        droppedFileHandler(event.target.files)\n      } else {\n        alert('Sorry no files .. internal error?')\n      }\n    },\n    false\n  )\n\n  ;(input as any).style = 'display:none'\n  const buttonElt = div.appendChild(\n    button(\n      dom,\n      iconBase + 'noun_Upload_76574_000000.svg',\n      'Upload files',\n      _event => {\n        input.click()\n      }\n    )\n  )\n  dragAndDrop.makeDropTarget(buttonElt, null, droppedFileHandler) // Can also just drop on button\n  return div\n}\n\nindex = {\n  line: { // Approx 80em\n  },\n  twoLine: { // Approx 40em * 2.4em\n    '': twoLineDefault,\n    'http://www.w3.org/2000/10/swap/pim/qif#Transaction': twoLineTransaction,\n    'http://www.w3.org/ns/pim/trip#Trip': twoLineTrip,\n    widgetForClass: twoLineWidgetForClass\n  }\n}\n"],"file":"buttons.js"}