{"version":3,"file":"media-capture.js","names":["cameraIcon","icons","iconBase","retakeIcon","canvasWidth","canvasHeight","controlStyle","contentType","cameraCaptureControl","dom","store","getImageDoc","doneCallback","div","createElement","destination","imageBlob","player","canvas","table","appendChild","mainTR","main","setAttribute","buttons","widgets","cancelButton","addEventListener","_event","stopVideo","retakeButton","button","retake","style","visibility","shutterButton","grabCanvas","sendButton","continueButton","saveBlob","displayPlayer","navigator","mediaDevices","Error","getUserMedia","constraints","then","stream","srcObject","video","removeChild","context","getContext","drawImage","width","height","parentNode","toBlob","blob","msg","type","size","debug","log","reviewImage","getVideoTracks","forEach","track","stop","fetcher","webOperation","uri","data","_resp","err","alert","cameraButton","but","control","restoreButton","imageDoc"],"sources":["../../src/media/media-capture.ts"],"sourcesContent":["/// /////////////////////////////////////////////\n//\n//   Media input widget\n//\n//\n// Workflow:\n// The HTML5 functionality (on mobille) is to prompt for either\n// a realtime camera capture , OR a selection from images already ont the device\n// (eg camera roll).\n//\n// The solid alternative is to either take a phtoto\n// or access cemra roll (etc) OR to access solid cloud storage of favorite photo almbums.\n// (Especially latest taken ones)\n//\nimport * as debug from '../debug'\n\n/** @module mediaCapture */\n\nimport { icons } from '../iconBase'\nimport * as widgets from '../widgets'\nimport { IndexedFormula, NamedNode } from 'rdflib'\n\nconst cameraIcon = icons.iconBase + 'noun_Camera_1618446_000000.svg' // Get it from github\nconst retakeIcon = icons.iconBase + 'noun_479395.svg' // Get it from github\n\nconst canvasWidth = '640'\nconst canvasHeight = '480'\n\nconst controlStyle = `border-radius: 0.5em; margin: 0.8em; width: ${canvasWidth}; height:${canvasHeight};`\n// const controlStyle = 'border-radius: 0.5em; margin: 0.8em; width: 320; height:240;'\nconst contentType = 'image/png'\n\n/** A control to capture a picture using camera\n * @param {Docuemnt} dom - The Document object\n * @param {IndexedForumla} store - The quadstore to store data in\n * @param {NamedNode} getImageDoc() - NN of the image file to be created\n * @param {function} doneCallback - Called when a picture has been taken\n */\nexport function cameraCaptureControl (\n  dom: HTMLDocument,\n  store: IndexedFormula,\n  getImageDoc: () => NamedNode,\n  doneCallback: (imageDoc) => Promise<void>\n) {\n  const div = dom.createElement('div')\n  let destination, imageBlob, player, canvas\n\n  const table = div.appendChild(dom.createElement('table'))\n  const mainTR = table.appendChild(dom.createElement('tr'))\n  const main = mainTR.appendChild(dom.createElement('td'))\n  main.setAttribute('colspan', '4')\n\n  const buttons = table.appendChild(dom.createElement('tr'))\n\n  buttons\n    .appendChild(dom.createElement('td')) // Cancel button\n    .appendChild(widgets.cancelButton(dom))\n    .addEventListener('click', _event => {\n      stopVideo()\n      doneCallback(null)\n    })\n\n  const retakeButton = buttons\n    .appendChild(dom.createElement('td')) // Retake button\n    .appendChild(widgets.button(dom, retakeIcon, 'Retake'))\n  retakeButton.addEventListener('click', _event => {\n    retake()\n  })\n  retakeButton.style.visibility = 'collapse' // Hide for now\n\n  const shutterButton = buttons\n    .appendChild(dom.createElement('td')) // Trigger capture button\n    .appendChild(\n      widgets.button(dom, icons.iconBase + 'noun_10636.svg', 'Snap')\n    )\n  shutterButton.addEventListener('click', grabCanvas)\n  shutterButton.style.visibility = 'collapse' // Hide for now\n\n  const sendButton = buttons\n    .appendChild(dom.createElement('td')) // Confirm and save button\n    .appendChild(widgets.continueButton(dom)) // @@ or send icon??\n  sendButton.addEventListener('click', _event => {\n    saveBlob(imageBlob, destination)\n  })\n  sendButton.style.visibility = 'collapse' // Hide for now\n\n  function displayPlayer () {\n    player = main.appendChild(dom.createElement('video'))\n    player.setAttribute('controls', '1')\n    player.setAttribute('autoplay', '1')\n    player.setAttribute('style', controlStyle)\n    if (!navigator.mediaDevices) {\n      throw new Error('navigator.mediaDevices not available')\n    }\n    navigator.mediaDevices.getUserMedia(constraints).then(stream => {\n      player.srcObject = stream\n      shutterButton.style.visibility = 'visible' // Enable\n      sendButton.style.visibility = 'collapse'\n      retakeButton.style.visibility = 'collapse'\n    })\n  }\n\n  const constraints = {\n    video: true\n  }\n\n  function retake () {\n    main.removeChild(canvas)\n    displayPlayer() // Make new one as old one is stuck black\n  }\n\n  function grabCanvas () {\n    // Draw the video frame to the canvas.\n    canvas = dom.createElement('canvas')\n    canvas.setAttribute('width', canvasWidth)\n    canvas.setAttribute('height', canvasHeight)\n    canvas.setAttribute('style', controlStyle)\n    main.appendChild(canvas)\n\n    const context = canvas.getContext('2d')\n    context.drawImage(player, 0, 0, canvas.width, canvas.height)\n\n    player.parentNode.removeChild(player)\n\n    canvas.toBlob(blob => {\n      const msg = `got blob type ${blob.type} size ${blob.size}`\n      debug.log(msg)\n      destination = getImageDoc()\n      imageBlob = blob // save for review\n      reviewImage()\n      // alert(msg)\n    }, contentType) // toBlob\n  }\n\n  function reviewImage () {\n    sendButton.style.visibility = 'visible'\n    retakeButton.style.visibility = 'visible'\n    shutterButton.style.visibility = 'collapse' // Hide for now\n  }\n\n  function stopVideo () {\n    if (player && player.srcObject) {\n      player.srcObject.getVideoTracks().forEach(track => track.stop())\n    }\n  }\n  function saveBlob (blob, destination) {\n    const contentType = blob.type\n    // if (!confirm('Save picture to ' + destination + ' ?')) return\n    debug.log(\n      'Putting ' + blob.size + ' bytes of ' + contentType + ' to ' + destination\n    )\n    // @@ TODO Remove casting\n    ;(store as any).fetcher\n      .webOperation('PUT', destination.uri, {\n        data: blob,\n        contentType\n      })\n      .then(\n        _resp => {\n          debug.log('ok saved ' + destination)\n          stopVideo()\n          doneCallback(destination)\n        },\n        err => {\n          stopVideo()\n          alert(err)\n        }\n      )\n  }\n\n  // Attach the video stream to the video element and autoplay.\n  displayPlayer()\n  return div\n}\n\n/** A button to capture a picture using camera\n * @param {Docuemnt} dom - The Document object\n * @param {IndexedForumla} store - The quadstore to store data in\n * @param {fuunction} getImageDoc - returns NN of the image file to be created\n * @param {function<Node>} doneCallback - called with the image taken\n * @returns {DomElement} - A div element with the buton in it\n *\n * This expacts the buttton to a large control when it is pressed\n */\n\nexport function cameraButton (\n  dom: HTMLDocument,\n  store: IndexedFormula,\n  getImageDoc: () => NamedNode,\n  doneCallback: (imageDoc) => Promise<void>\n): HTMLElement {\n  const div = dom.createElement('div')\n  const but = widgets.button(dom, cameraIcon, 'Take picture')\n  let control\n  async function restoreButton (imageDoc) {\n    div.removeChild(control)\n    div.appendChild(but)\n    doneCallback(imageDoc)\n  }\n  div.appendChild(but)\n  but.addEventListener('click', _event => {\n    div.removeChild(but)\n    control = cameraCaptureControl(\n      dom,\n      store,\n      getImageDoc,\n      restoreButton\n    )\n    div.appendChild(control)\n  })\n  return div\n}\n"],"mappings":"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"}