{"version":3,"file":"thread.js","names":["UI","icons","ns","media","pad","style","utils","widgets","thread","dom","kb","subject","messageStore","options","store","doc","WF","$rdf","Namespace","DCT","newestFirst","messageBodyStyle","div","createElement","messageTable","me","updater","anchor","text","term","a","uri","setAttribute","addEventListener","openHrefInOutlineMode","textContent","mention","message","pre","appendChild","createTextNode","announce","log","warn","error","newMessageForm","form","lhs","middle","rhs","AJAR_date","sendMessage","field","disabled","appendMsg","value","dateStamp","sts","sendComplete","success","body","errorMessageBlock","bindings","literal","renderMessage","update","sendButton","turnOnInput","creatorAndDate","innerHTML","rows","e","keyCode","altKey","button","iconBase","buttonStyle","context","login","ensureLoggedIn","then","fieldValue","oldMsg","now","Date","timestamp","getTime","sym","push","Statement","mostRecentVersion","wf","msgBody","nick","sioc","foaf","person","s","any","label","td1","creator","date","nickAnchor","fetcher","nowOrWhenFetched","undefined","_ok","_body","syncMessages","about","displayed","ele","ele2","firstChild","nextSibling","AJAR_subject","messages","each","stored","forEach","m","addMessage","removeChild","msg","statementsMatching","_deleteMessage","connectedStatements","deletions","ok","fresh","content","dateString","tr","done","insertBefore","shortDate","td2","td3","delButton","_event","cancelButton","sureButton","query","Query","v","vs","x","vars","variable","pat","add","dct","doneQuery","refresh"],"sources":["../../src/chat/thread.js"],"sourcesContent":["/**\n * Contains the [[thread]] function\n * @packageDocumentation\n */\n\nimport { icons } from '../iconBase'\nimport { store } from 'solid-logic'\nimport { media } from '../media/index'\nimport * as ns from '../ns'\nimport * as login from '../login/login'\nimport * as pad from '../pad'\nimport * as $rdf from 'rdflib' // pull in first avoid cross-refs\nimport * as style from '../style'\nimport * as utils from '../utils'\nimport * as widgets from '../widgets'\n\nconst UI = { icons, ns, media, pad, style, utils, widgets }\n\n/**\n * HTML component for a chat thread\n */\nexport function thread (dom, kb, subject, messageStore, options) {\n  kb = kb || store\n  messageStore = messageStore.doc() // No hash\n  const ns = UI.ns\n  const WF = $rdf.Namespace('http://www.w3.org/2005/01/wf/flow#')\n  const DCT = $rdf.Namespace('http://purl.org/dc/terms/')\n\n  options = options || {}\n\n  const newestFirst = !!options.newestFirst\n\n  const messageBodyStyle =\n    'white-space: pre-wrap; width: 90%; font-size:100%; border: 0.07em solid #eee; padding: .2em 0.5em; margin: 0.1em 1em 0.1em 1em;'\n  // 'font-size: 100%; margin: 0.1em 1em 0.1em 1em;  background-color: white; white-space: pre-wrap; padding: 0.1em;'\n\n  const div = dom.createElement('div')\n  // eslint-disable-next-line prefer-const\n  let messageTable // Shared by initial build and addMessageFromBindings\n\n  let me\n\n  const updater = store.updater\n\n  const anchor = function (text, term) {\n    // If there is no link return an element anyway\n    const a = dom.createElement('a')\n    if (term && term.uri) {\n      a.setAttribute('href', term.uri)\n      a.addEventListener('click', UI.widgets.openHrefInOutlineMode, true)\n      a.setAttribute('style', 'color: #3B5998; text-decoration: none; ') // font-weight: bold\n    }\n    a.textContent = text\n    return a\n  }\n\n  const mention = function mention (message, style) {\n    const pre = dom.createElement('pre')\n    pre.setAttribute('style', style || 'color: grey')\n    div.appendChild(pre)\n    pre.appendChild(dom.createTextNode(message))\n    return pre\n  }\n\n  const announce = {\n    log: function (message) {\n      mention(message, 'color: #111;')\n    },\n    warn: function (message) {\n      mention(message, 'color: #880;')\n    },\n    error: function (message) {\n      mention(message, 'color: #800;')\n    }\n  }\n\n  /**\n   * Form for a new message\n   */\n  const newMessageForm = function () {\n    const form = dom.createElement('tr')\n    const lhs = dom.createElement('td')\n    const middle = dom.createElement('td')\n    const rhs = dom.createElement('td')\n    form.appendChild(lhs)\n    form.appendChild(middle)\n    form.appendChild(rhs)\n    form.AJAR_date = '9999-01-01T00:00:00Z' // ISO format for field sort\n\n    const sendMessage = function () {\n      // titlefield.setAttribute('class','pendingedit')\n      // titlefield.disabled = true\n      field.setAttribute('class', 'pendingedit')\n      field.disabled = true\n      const { message, dateStamp, sts } = appendMsg(field.value)\n\n      const sendComplete = function (uri, success, body) {\n        if (!success) {\n          form.appendChild(\n            UI.widgets.errorMessageBlock(dom, 'Error writing message: ' + body)\n          )\n        } else {\n          const bindings = {\n            '?msg': message,\n            '?content': store.literal(field.value),\n            '?date': dateStamp,\n            '?creator': me\n          }\n          renderMessage(bindings, false) // not green\n\n          field.value = '' // clear from out for reuse\n          field.setAttribute('class', '')\n          field.disabled = false\n        }\n      }\n      updater.update([], sts, sendComplete)\n    }\n    form.appendChild(dom.createElement('br'))\n\n    let field, sendButton\n    const turnOnInput = function () {\n      creatorAndDate(lhs, me, '', null)\n\n      field = dom.createElement('textarea')\n      middle.innerHTML = ''\n      middle.appendChild(field)\n      field.rows = 3\n      // field.cols = 40\n      field.setAttribute('style', messageBodyStyle + 'background-color: #eef;')\n\n      field.addEventListener(\n        'keyup',\n        function (e) {\n          // User preference?\n          if (e.keyCode === 13) {\n            if (!e.altKey) {\n              // Alt-Enter just adds a new line\n              sendMessage()\n            }\n          }\n        },\n        false\n      )\n\n      rhs.innerHTML = ''\n      sendButton = UI.widgets.button(\n        dom,\n        UI.icons.iconBase + 'noun_383448.svg',\n        'Send'\n      )\n      sendButton.setAttribute('style', UI.style.buttonStyle + 'float: right;')\n      sendButton.addEventListener('click', sendMessage, false)\n      rhs.appendChild(sendButton)\n    }\n\n    const context = { div: middle, dom }\n    login.ensureLoggedIn(context).then(context => {\n      me = context.me\n      turnOnInput()\n    })\n\n    return form\n  }\n\n  /* const sendMessage = function (oldMsg, options) { // alain\n    // titlefield.setAttribute('class','pendingedit')\n    // titlefield.disabled = true\n    field.setAttribute('class', 'pendingedit')\n    field.disabled = true\n    const sts = []\n    const now = new Date()\n    const timestamp = '' + now.getTime()\n    const dateStamp = $rdf.term(now)\n    // http://www.w3schools.com/jsref/jsref_obj_date.asp\n    const message = store.sym(messageStore.uri + '#' + 'Msg' + timestamp)\n\n    if (options === 'edit' || options === 'delete') {\n      sts.push(\n        new $rdf.Statement(mostRecentVersion(oldMsg), DCT('isReplacedBy'), message, messageStore)\n      )\n    } else {\n      sts.push(\n        new $rdf.Statement(subject, ns.wf('message'), message, messageStore)\n      )\n    }\n    // sts.push(new $rdf.Statement(message, ns.dc('title'), store.literal(titlefield.value), messageStore))\n    const msgBody = options !== 'delete' ? field.value : `message deleted\\nby ${nick(me)}`\n    sts.push(\n      new $rdf.Statement(\n        message,\n        ns.sioc('content'),\n        store.literal(msgBody),\n        messageStore\n      )\n    )\n    sts.push(\n      new $rdf.Statement(message, DCT('created'), dateStamp, messageStore)\n    )\n    if (me) {\n      sts.push(\n        new $rdf.Statement(message, ns.foaf('maker'), me, messageStore)\n      )\n    }\n\n    const sendComplete = function (uri, success, body) {\n      if (!success) {\n        form.appendChild(\n          UI.widgets.errorMessageBlock(dom, 'Error writing message: ' + body)\n        )\n      } else {\n        const bindings = {\n          '?msg': message,\n          '?content': store.literal(field.value),\n          '?date': dateStamp,\n          '?creator': me\n        }\n        renderMessage(bindings, false) // not green\n\n        field.value = '' // clear from out for reuse\n        field.setAttribute('class', '')\n        field.disabled = false\n      }\n    }\n    updater.update([], sts, sendComplete)\n  } */\n\n  const appendMsg = function (fieldValue, oldMsg = {}, options = '') { // alain\n    const sts = []\n    const now = new Date()\n    const timestamp = '' + now.getTime()\n    const dateStamp = $rdf.term(now)\n    // http://www.w3schools.com/jsref/jsref_obj_date.asp\n    const message = store.sym(messageStore.uri + '#' + 'Msg' + timestamp)\n\n    if (options === 'edit' || options === 'delete') {\n      sts.push(\n        new $rdf.Statement(mostRecentVersion(oldMsg), DCT('isReplacedBy'), message, messageStore)\n      )\n    } else {\n      sts.push(\n        new $rdf.Statement(subject, ns.wf('message'), message, messageStore)\n      )\n    }\n    // sts.push(new $rdf.Statement(message, ns.dc('title'), store.literal(titlefield.value), messageStore))\n    const msgBody = options !== 'delete' ? fieldValue : `message deleted\\nby ${nick(me)}`\n    sts.push(\n      new $rdf.Statement(\n        message,\n        ns.sioc('content'),\n        store.literal(msgBody),\n        messageStore\n      )\n    )\n    sts.push(\n      new $rdf.Statement(message, DCT('created'), dateStamp, messageStore)\n    )\n    if (me) {\n      sts.push(\n        new $rdf.Statement(message, ns.foaf('maker'), me, messageStore)\n      )\n    }\n    return { message, dateStamp, sts }\n  }\n\n  function nick (person) {\n    const s = store.any(person, UI.ns.foaf('nick'))\n    if (s) return '' + s.value\n    return '' + utils.label(person)\n  }\n\n  function creatorAndDate (td1, creator, date, message) {\n    const nickAnchor = td1.appendChild(anchor(nick(creator), creator))\n    if (creator.uri) {\n      store.fetcher.nowOrWhenFetched(creator.doc(), undefined, function (\n        _ok,\n        _body\n      ) {\n        nickAnchor.textContent = nick(creator)\n      })\n    }\n    td1.appendChild(dom.createElement('br'))\n    td1.appendChild(anchor(date, message))\n  }\n\n  // ///////////////////////////////////////////////////////////////////////\n\n  function syncMessages (about, messageTable) {\n    const displayed = {}\n    let ele, ele2\n    for (ele = messageTable.firstChild; ele; ele = ele.nextSibling) {\n      if (ele.AJAR_subject) {\n        displayed[ele.AJAR_subject.uri] = true\n      }\n    }\n    const messages = store.each(about, ns.wf('message'))\n    const stored = {}\n    messages.forEach(function (m) {\n      stored[m.uri] = true\n      if (!displayed[m.uri]) {\n        addMessage(m)\n      }\n    })\n\n    // eslint-disable-next-line space-in-parens\n    for (ele = messageTable.firstChild; ele; ) {\n      ele2 = ele.nextSibling\n      if (ele.AJAR_subject && !stored[ele.AJAR_subject.uri]) {\n        messageTable.removeChild(ele)\n      }\n      ele = ele2\n    }\n  }\n\n  const mostRecentVersion = function (message) {\n    let msg = message\n    // const listMsg = []\n    while (msg) {\n      // listMsg.push(msg)\n      msg = store.statementsMatching(message, DCT('isReplacedBy'))\n    }\n    return msg\n  }\n\n  const _deleteMessage = async function (message) { // alain: must delete message and all linked with isReplacedBy\n    // alain: check that me is not the author and ask for confirmation.\n    const deletions = await store.connectedStatements(message, messageStore)\n    updater.update(deletions, [], function (uri, ok, body) {\n      if (!ok) {\n        announce.error('Cant delete messages:' + body)\n      } else {\n        syncMessages(subject, messageTable)\n      }\n    })\n  }\n\n  const addMessage = function (message) {\n    const bindings = {\n      '?msg': message,\n      '?creator': store.any(message, ns.foaf('maker')),\n      '?date': store.any(message, DCT('created')),\n      '?content': store.any(message, ns.sioc('content'))\n    }\n    renderMessage(bindings, true) // fresh from elsewhere\n  }\n\n  const renderMessage = function (bindings, fresh) {\n    const creator = bindings['?creator']\n    const message = bindings['?msg']\n    const date = bindings['?date']\n    const content = bindings['?content']\n\n    const dateString = date.value\n    const tr = dom.createElement('tr')\n    tr.AJAR_date = dateString\n    tr.AJAR_subject = message\n\n    let done = false\n    for (let ele = messageTable.firstChild; ; ele = ele.nextSibling) {\n      if (!ele) {\n        // empty\n        break\n      }\n      if (\n        (dateString > ele.AJAR_date && newestFirst) ||\n        (dateString < ele.AJAR_date && !newestFirst)\n      ) {\n        messageTable.insertBefore(tr, ele)\n        done = true\n        break\n      }\n    }\n    if (!done) {\n      messageTable.appendChild(tr)\n    }\n\n    const td1 = dom.createElement('td')\n    tr.appendChild(td1)\n    creatorAndDate(td1, creator, UI.widgets.shortDate(dateString), message)\n\n    const td2 = dom.createElement('td')\n    tr.appendChild(td2)\n    const pre = dom.createElement('p')\n    pre.setAttribute(\n      'style',\n      messageBodyStyle +\n        (fresh ? 'background-color: #e8ffe8;' : 'background-color: #white;')\n    )\n    td2.appendChild(pre)\n    pre.textContent = content.value\n\n    const td3 = dom.createElement('td')\n    tr.appendChild(td3)\n\n    const delButton = dom.createElement('button')\n    td3.appendChild(delButton)\n    delButton.textContent = '-'\n\n    tr.setAttribute('class', 'hoverControl') // See tabbedtab.css (sigh global CSS)\n    delButton.setAttribute('class', 'hoverControlHide')\n    delButton.setAttribute('style', 'color: red;')\n    delButton.addEventListener(\n      'click',\n      function (_event) {\n        td3.removeChild(delButton) // Ask -- are you sure?\n        const cancelButton = dom.createElement('button')\n        cancelButton.textContent = 'cancel'\n        td3.appendChild(cancelButton).addEventListener(\n          'click',\n          function (_event) {\n            td3.removeChild(sureButton)\n            td3.removeChild(cancelButton)\n            td3.appendChild(delButton)\n          },\n          false\n        )\n        const sureButton = dom.createElement('button')\n        sureButton.textContent = 'Delete message'\n        td3.appendChild(sureButton).addEventListener(\n          'click',\n          function (_event) { // alain test for delete or edit depending on me = maker\n            td3.removeChild(sureButton)\n            td3.removeChild(cancelButton)\n            // deleteMessage(message) // alain or sendMessage(message, 'delete' or 'edit') //alain\n            if (me.value === store.any(message, ns.foaf('maker')).value) {\n              const { sts } = appendMsg() // alain\n              updater.update([], sts)\n            }\n          },\n          false\n        )\n      },\n      false\n    )\n  }\n\n  // Messages with date, author etc\n\n  messageTable = dom.createElement('table')\n  messageTable.fresh = false\n  div.appendChild(messageTable)\n  messageTable.setAttribute('style', 'width: 100%;') // fill that div!\n\n  const tr = newMessageForm()\n  if (newestFirst) {\n    messageTable.insertBefore(tr, messageTable.firstChild) // If newestFirst\n  } else {\n    messageTable.appendChild(tr) // not newestFirst\n  }\n\n  let query\n  // Do this with a live query to pull in messages from web\n  if (options.query) {\n    query = options.query\n  } else {\n    query = new $rdf.Query('Messages')\n    const v = {} // semicolon needed\n    const vs = ['msg', 'date', 'creator', 'content']\n    vs.forEach(function (x) {\n      query.vars.push((v[x] = $rdf.variable(x)))\n    })\n    query.pat.add(subject, WF('message'), v.msg)\n    query.pat.add(v.msg, ns.dct('created'), v.date)\n    query.pat.add(v.msg, ns.foaf('maker'), v.creator)\n    query.pat.add(v.msg, ns.sioc('content'), v.content)\n  }\n\n  function doneQuery () {\n    messageTable.fresh = true // any new are fresh and so will be greenish\n  }\n  store.query(query, renderMessage, undefined, doneQuery)\n  div.refresh = function () {\n    syncMessages(subject, messageTable)\n  }\n  // syncMessages(subject, messageTable) // no the query will do this async\n  return div\n}\n"],"mappings":"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"}