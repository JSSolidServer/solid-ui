{"version":3,"file":"chatLogic.js","names":["ChatChannel","channel","options","channelRoot","doc","dateFolder","DateFolder","div","text","updateMessage","oldMsg","deleteIt","sts","now","Date","timestamp","getTime","dateStamp","$rdf","term","chatDocument","leafDocumentFromDate","message","store","sym","uri","me","authn","currentUser","push","st","mostRecentVersion","ns","dct","schema","wf","sioc","literal","foaf","updater","update","msg","debug","warn","alert","Error","originalVersion","any","isDeleted","holds","isReplaced","isHidden","nick","person","s","value","utils","label","_createIfNotExists","contentType","data","fetcher","load","response","status","log","webOperation","requested"],"sources":["../../src/chat/chatLogic.js"],"sourcesContent":["/**\n * Contains the [[ChatChannel]] class and logic for Solid Chat\n * @packageDocumentation\n */\n\nimport * as debug from '../debug'\nimport { DateFolder } from './dateFolder'\nimport { store, authn } from 'solid-logic'\nimport * as ns from '../ns'\nimport * as $rdf from 'rdflib' // pull in first avoid cross-refs\nimport * as utils from '../utils'\n\n/* The Solid logic for a 'LongChat'\n*/\n/**\n * Common code for a chat (discussion area of messages about something)\n * This version runs over a series of files for different time periods\n *\n * Parameters for the whole chat like its title are stored on\n * index.ttl#this and the chats messages are stored in YYYY/MM/DD/chat.ttl\n *\n */\n\nexport class ChatChannel {\n  constructor (channel, options) {\n    this.channel = channel\n    this.channelRoot = channel.doc()\n    this.options = options\n    this.dateFolder = new DateFolder(this.channelRoot, 'chat.ttl')\n    this.div = null // : HTMLElement\n  }\n\n  /* Store a new message in the web,\n  */\n  async createMessage (text) {\n    return this.updateMessage(text)\n  }\n\n  /* Store a new message in the web,\n    as a replacement for an existing one.\n    The old one iis left, and the two are linked\n  */\n  async updateMessage (text, oldMsg = null, deleteIt) {\n    const sts = []\n    const now = new Date()\n    const timestamp = '' + now.getTime()\n    const dateStamp = $rdf.term(now)\n    const chatDocument = oldMsg ? oldMsg.doc() : this.dateFolder.leafDocumentFromDate(now)\n    const message = store.sym(chatDocument.uri + '#' + 'Msg' + timestamp)\n    // const content = store.literal(text)\n\n    const me = authn.currentUser() // If already logged on\n\n    if (oldMsg) { // edit message replaces old one\n      sts.push($rdf.st(mostRecentVersion(oldMsg), ns.dct('isReplacedBy'), message, chatDocument))\n      if (deleteIt) {\n        sts.push($rdf.st(message, ns.schema('dateDeleted'), dateStamp, chatDocument))\n      }\n    } else { // link new message to channel\n      sts.push($rdf.st(this.channel, ns.wf('message'), message, chatDocument))\n    }\n    sts.push(\n      $rdf.st(message, ns.sioc('content'), store.literal(text), chatDocument)\n    )\n    sts.push(\n      $rdf.st(message, ns.dct('created'), dateStamp, chatDocument)\n    )\n    if (me) {\n      sts.push($rdf.st(message, ns.foaf('maker'), me, chatDocument))\n    }\n    try {\n      await store.updater.update([], sts)\n    } catch (err) {\n      const msg = 'Error saving chat message: ' + err\n      debug.warn(msg)\n      alert(msg)\n      throw new Error(msg)\n    }\n    return message\n  }\n\n  /* Mark a message as deleted\n  * Wee add a new version of the message,m witha deletion flag (deletion date)\n  * so that the deletion can be revoked by adding another non-deleted update\n  */\n  async deleteMessage (message) {\n    return this.updateMessage('(message deleted)', message, true)\n  }\n} // class ChatChannel\n\nexport function originalVersion (message) {\n  let msg = message\n  while (msg) {\n    message = msg\n    msg = store.any(null, ns.dct('isReplacedBy'), message, message.doc())\n  }\n  return message\n}\n\nexport function mostRecentVersion (message) {\n  let msg = message\n  while (msg) {\n    message = msg\n    msg = store.any(message, ns.dct('isReplacedBy'), null, message.doc())\n  }\n  return message\n}\n\nexport function isDeleted (message) {\n  return store.holds(message, ns.schema('dateDeleted'), null, message.doc())\n}\n\nexport function isReplaced (message) {\n  return store.holds(message, ns.dct('isReplacedBy'), null, message.doc())\n}\n\nexport function isHidden (message) {\n  return this.isDeleted(message) || this.isReplaced(message)\n}\n\n// A Nickname for a person\n\nexport function nick (person) {\n  const s = store.any(person, ns.foaf('nick'))\n  if (s) return '' + s.value\n  return '' + utils.label(person)\n}\n\nexport async function _createIfNotExists (doc, contentType = 'text/turtle', data = '') {\n  let response\n  try {\n    response = await store.fetcher.load(doc)\n  } catch (err) {\n    if (err.response.status === 404) {\n      debug.log(\n        'createIfNotExists: doc does NOT exist, will create... ' + doc\n      )\n      try {\n        response = await store.fetcher.webOperation('PUT', doc.uri, {\n          data,\n          contentType\n        })\n      } catch (err) {\n        debug.log('createIfNotExists doc FAILED: ' + doc + ': ' + err)\n        throw err\n      }\n      delete store.fetcher.requested[doc.uri] // delete cached 404 error\n      // debug.log('createIfNotExists doc created ok ' + doc)\n      return response\n    } else {\n      debug.log(\n        'createIfNotExists doc load error NOT 404:  ' + doc + ': ' + err\n      )\n      throw err\n    }\n  }\n  // debug.log('createIfNotExists: doc exists, all good: ' + doc)\n  return response\n}\n// ends\n"],"mappings":"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"}