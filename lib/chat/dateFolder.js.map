{"version":3,"file":"dateFolder.js","names":["DateFolder","rootThing","leafFileName","membershipProperty","root","rootFolder","dir","ns","wf","date","isoDate","toISOString","path","split","replace","uri","store","sym","doc","head","length","str","slice","Date","debug","log","backwards","previousPeriod","file","level","younger","suitable","lastNonEmpty","siblings","filter","sort","reverse","pop","folder","leafDocument","thisDateFolder","fetcher","load","statementsMatching","dct","x","tail","includes","parent","each","ldp","response","status","Error","message","uncle","cousins","result","leafDocumentFromDate","found","dateFromLeafDocument","earliestSubfolder","folderFetcher","requested","force","kids","folderStore","$rdf","graph","Fetcher","y","month","d","leafObjects","msg","trace","sortMe","map","leafObject","any"],"sources":["../../src/chat/dateFolder.js"],"sourcesContent":["/**\n * Contains the [[DateFolder]] class\n * This tracks data stored in dated folders and sub-folders\n *\n */\n\nimport * as debug from '../debug'\nimport { store } from 'solid-logic'\n\nimport * as ns from '../ns'\nimport * as $rdf from 'rdflib' // pull in first avoid cross-refs\n\n/**\n * Track back through the YYYY/MM/DD tree to find the previous/next day\n */\nexport class DateFolder {\n  constructor (rootThing, leafFileName, membershipProperty) {\n    this.root = rootThing\n    this.rootFolder = rootThing.dir()\n    this.leafFileName = leafFileName || 'index.ttl' // typically chat.ttl\n    this.membershipProperty = membershipProperty || ns.wf('leafObject')\n  }\n\n  /* Generate the leaf document (rdf object) from date\n   * @returns: <NamedNode> - document\n   */\n  leafDocumentFromDate (date) {\n    // debug.log('incoming date: ' + date)\n    const isoDate = date.toISOString() // Like \"2018-05-07T17:42:46.576Z\"\n    let path = isoDate.split('T')[0].replace(/-/g, '/') //  Like \"2018/05/07\"\n    path = this.root.dir().uri + path + '/' + this.leafFileName\n    return store.sym(path)\n  }\n\n  /* Generate a date object from the leaf file name\n   */\n  dateFromLeafDocument (doc) {\n    const head = this.rootFolder.uri.length\n    const str = doc.uri.slice(head, head + 10).replace(/\\//g, '-')\n    // let date = new Date(str + 'Z') // GMT - but fails in FF - invalid format :-(\n    const date = new Date(str) // not explicitly UTC but is assumed so in spec\n    // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date/parse\n    debug.log('Date for ' + doc + ':' + date.toISOString())\n    return date\n  }\n\n  async loadPrevious (date, backwards) {\n    const thisDateFolder = this\n    async function previousPeriod (file, level) {\n      function younger (x) {\n        if (backwards ? x.uri >= file.uri : x.uri <= file.uri) return false // later than we want or same -- looking for different\n        return true\n      }\n      function suitable (x) {\n        const tail = x.uri\n          .slice(0, -1)\n          .split('/')\n          .slice(-1)[0]\n        if (!'0123456789'.includes(tail[0])) return false // not numeric\n        return true\n      }\n\n      async function lastNonEmpty (siblings) {\n        siblings = siblings.filter(suitable)\n        siblings.sort() // chronological order\n        if (!backwards) siblings.reverse()\n        if (level !== 3) return siblings.pop() // only length chck final leverl\n        while (siblings.length) {\n          const folder = siblings.pop()\n          const leafDocument = store.sym(folder.uri + thisDateFolder.leafFileName)\n          await store.fetcher.load(leafDocument)\n          // files can have seealso links. skip ones with no leafObjects with a date\n          if (\n            store.statementsMatching(null, ns.dct('created'), null, leafDocument)\n              .length > 0\n          ) {\n            return folder\n          }\n        }\n        return null\n      }\n      // debug.log('  previousPeriod level' + level + ' file ' + file)\n      const parent = file.dir()\n      try {\n        await store.fetcher.load(parent)\n        let siblings = store.each(parent, ns.ldp('contains'))\n        siblings = siblings.filter(younger)\n        const folder = await lastNonEmpty(siblings)\n        if (folder) return folder\n      } catch (err) {\n        if (err.response && err.response.status && err.response.status === 404) {\n          debug.log('Error 404 for chat parent file ' + parent)\n        } else {\n          debug.log('*** Error NON 404 for chat parent file ' + parent)\n          // statusTR.appendChild(widgets.errorMessageBlock(dom, err, 'pink'))\n          throw (new Error(`*** ${err.message} for chat folder ${parent}`))\n        }\n      }\n\n      if (level === 0) return null // 3:day, 2:month, 1: year  0: no\n\n      const uncle = await previousPeriod(parent, level - 1)\n      if (!uncle) return null // reached first ever\n      await store.fetcher.load(uncle)\n      const cousins = store.each(uncle, ns.ldp('contains'))\n      const result = await lastNonEmpty(cousins)\n      return result\n    } // previousPeriod\n\n    const folder = this.leafDocumentFromDate(date).dir()\n    const found = await previousPeriod(folder, 3)\n    if (found) {\n      const doc = store.sym(found.uri + this.leafFileName)\n      return this.dateFromLeafDocument(doc)\n    }\n    return null\n  } // loadPrevious\n\n  async firstLeaf (backwards) {\n    // backwards -> last leafObject\n    const folderStore = $rdf.graph()\n    const folderFetcher = new $rdf.Fetcher(folderStore)\n    async function earliestSubfolder (parent) {\n      function suitable (x) {\n        const tail = x.uri\n          .slice(0, -1)\n          .split('/')\n          .slice(-1)[0]\n        if (!'0123456789'.includes(tail[0])) return false // not numeric\n        return true\n      }\n      debug.log('            parent ' + parent)\n      delete folderFetcher.requested[parent.uri]\n      // try {\n      await folderFetcher.load(parent, { force: true }) // Force fetch as will have changed\n      // }catch (err) {\n      // }\n\n      let kids = folderStore.each(parent, ns.ldp('contains'))\n      kids = kids.filter(suitable)\n      if (kids.length === 0) {\n        throw new Error(' @@@  No children to         parent2 ' + parent)\n      }\n\n      kids.sort()\n      if (backwards) kids.reverse()\n      return kids[0]\n    }\n    const y = await earliestSubfolder(this.root.dir())\n    const month = await earliestSubfolder(y)\n    const d = await earliestSubfolder(month)\n    const leafDocument = $rdf.sym(d.uri + 'chat.ttl')\n    await folderFetcher.load(leafDocument)\n    const leafObjects = folderStore.each(\n      this.root,\n      this.membershipProperty,\n      null,\n      leafDocument\n    )\n    if (leafObjects.length === 0) {\n      const msg =\n        '  INCONSISTENCY -- no chat leafObject in file ' + leafDocument\n      debug.trace(msg)\n      throw new Error(msg)\n    }\n    const sortMe = leafObjects.map(leafObject => [\n      folderStore.any(leafObject, ns.dct('created')),\n      leafObject\n    ])\n    sortMe.sort()\n    if (backwards) sortMe.reverse()\n    debug.log(\n      (backwards ? 'Latest' : 'Earliest') + ' leafObject is ' + sortMe[0][1]\n    )\n    return sortMe[0][1]\n  } // firstleafObject\n} // class\n"],"mappings":";;;;;;;;;;;;AAMA;AACA;AAEA;AACA;AAA8B;AAAA;AAV9B;AACA;AACA;AACA;AACA;AAM+B;AAE/B;AACA;AACA;AAFA,IAGaA,UAAU;EACrB,oBAAaC,SAAS,EAAEC,YAAY,EAAEC,kBAAkB,EAAE;IAAA;IACxD,IAAI,CAACC,IAAI,GAAGH,SAAS;IACrB,IAAI,CAACI,UAAU,GAAGJ,SAAS,CAACK,GAAG,EAAE;IACjC,IAAI,CAACJ,YAAY,GAAGA,YAAY,IAAI,WAAW,EAAC;IAChD,IAAI,CAACC,kBAAkB,GAAGA,kBAAkB,IAAII,EAAE,CAACC,EAAE,CAAC,YAAY,CAAC;EACrE;;EAEA;AACF;AACA;EAFE;IAAA;IAAA,OAGA,8BAAsBC,IAAI,EAAE;MAC1B;MACA,IAAMC,OAAO,GAAGD,IAAI,CAACE,WAAW,EAAE,EAAC;MACnC,IAAIC,IAAI,GAAGF,OAAO,CAACG,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAACC,OAAO,CAAC,IAAI,EAAE,GAAG,CAAC,EAAC;MACpDF,IAAI,GAAG,IAAI,CAACR,IAAI,CAACE,GAAG,EAAE,CAACS,GAAG,GAAGH,IAAI,GAAG,GAAG,GAAG,IAAI,CAACV,YAAY;MAC3D,OAAOc,iBAAK,CAACC,GAAG,CAACL,IAAI,CAAC;IACxB;;IAEA;AACF;EADE;IAAA;IAAA,OAEA,8BAAsBM,GAAG,EAAE;MACzB,IAAMC,IAAI,GAAG,IAAI,CAACd,UAAU,CAACU,GAAG,CAACK,MAAM;MACvC,IAAMC,GAAG,GAAGH,GAAG,CAACH,GAAG,CAACO,KAAK,CAACH,IAAI,EAAEA,IAAI,GAAG,EAAE,CAAC,CAACL,OAAO,CAAC,KAAK,EAAE,GAAG,CAAC;MAC9D;MACA,IAAML,IAAI,GAAG,IAAIc,IAAI,CAACF,GAAG,CAAC,EAAC;MAC3B;MACAG,KAAK,CAACC,GAAG,CAAC,WAAW,GAAGP,GAAG,GAAG,GAAG,GAAGT,IAAI,CAACE,WAAW,EAAE,CAAC;MACvD,OAAOF,IAAI;IACb;EAAC;IAAA;IAAA;MAAA,kGAED,kBAAoBA,IAAI,EAAEiB,SAAS;QAAA,oBAElBC,cAAc;QAAA;UAAA;YAAA;cAAA;gBAAA,gGAA7B,kBAA+BC,IAAI,EAAEC,KAAK;kBAAA,IAC/BC,OAAO,EAIPC,QAAQ,EASFC,YAAY;kBAAA;oBAAA;sBAAA;wBAAA;0BAAA,8FAA3B,iBAA6BC,QAAQ;4BAAA;4BAAA;8BAAA;gCAAA;kCACnCA,QAAQ,GAAGA,QAAQ,CAACC,MAAM,CAACH,QAAQ,CAAC;kCACpCE,QAAQ,CAACE,IAAI,EAAE,EAAC;kCAChB,IAAI,CAACT,SAAS,EAAEO,QAAQ,CAACG,OAAO,EAAE;kCAAA,MAC9BP,KAAK,KAAK,CAAC;oCAAA;oCAAA;kCAAA;kCAAA,iCAASI,QAAQ,CAACI,GAAG,EAAE;gCAAA;kCAAA,KAC/BJ,QAAQ,CAACb,MAAM;oCAAA;oCAAA;kCAAA;kCACdkB,QAAM,GAAGL,QAAQ,CAACI,GAAG,EAAE;kCACvBE,YAAY,GAAGvB,iBAAK,CAACC,GAAG,CAACqB,QAAM,CAACvB,GAAG,GAAGyB,cAAc,CAACtC,YAAY,CAAC;kCAAA;kCAAA,OAClEc,iBAAK,CAACyB,OAAO,CAACC,IAAI,CAACH,YAAY,CAAC;gCAAA;kCAAA,MAGpCvB,iBAAK,CAAC2B,kBAAkB,CAAC,IAAI,EAAEpC,EAAE,CAACqC,GAAG,CAAC,SAAS,CAAC,EAAE,IAAI,EAAEL,YAAY,CAAC,CAClEnB,MAAM,GAAG,CAAC;oCAAA;oCAAA;kCAAA;kCAAA,iCAENkB,QAAM;gCAAA;kCAAA;kCAAA;gCAAA;kCAAA,iCAGV,IAAI;gCAAA;gCAAA;kCAAA;8BAAA;4BAAA;0BAAA,CACZ;0BAAA;wBAAA;wBAlBcN,YAAY;0BAAA;wBAAA;wBATlBD,QAAQ,sBAAEc,CAAC,EAAE;0BACpB,IAAMC,IAAI,GAAGD,CAAC,CAAC9B,GAAG,CACfO,KAAK,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CACZT,KAAK,CAAC,GAAG,CAAC,CACVS,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;0BACf,IAAI,CAAC,YAAY,CAACyB,QAAQ,CAACD,IAAI,CAAC,CAAC,CAAC,CAAC,EAAE,OAAO,KAAK,EAAC;0BAClD,OAAO,IAAI;wBACb,CAAC;wBAXQhB,OAAO,qBAAEe,CAAC,EAAE;0BACnB,IAAInB,SAAS,GAAGmB,CAAC,CAAC9B,GAAG,IAAIa,IAAI,CAACb,GAAG,GAAG8B,CAAC,CAAC9B,GAAG,IAAIa,IAAI,CAACb,GAAG,EAAE,OAAO,KAAK,EAAC;0BACpE,OAAO,IAAI;wBACb,CAAC;wBA6BD;wBACMiC,MAAM,GAAGpB,IAAI,CAACtB,GAAG,EAAE;wBAAA;wBAAA;wBAAA,OAEjBU,iBAAK,CAACyB,OAAO,CAACC,IAAI,CAACM,MAAM,CAAC;sBAAA;wBAC5Bf,QAAQ,GAAGjB,iBAAK,CAACiC,IAAI,CAACD,MAAM,EAAEzC,EAAE,CAAC2C,GAAG,CAAC,UAAU,CAAC,CAAC;wBACrDjB,QAAQ,GAAGA,QAAQ,CAACC,MAAM,CAACJ,OAAO,CAAC;wBAAA;wBAAA,OACdE,YAAY,CAACC,QAAQ,CAAC;sBAAA;wBAArCK,OAAM;wBAAA,KACRA,OAAM;0BAAA;0BAAA;wBAAA;wBAAA,kCAASA,OAAM;sBAAA;wBAAA;wBAAA;sBAAA;wBAAA;wBAAA;wBAAA,MAErB,aAAIa,QAAQ,IAAI,aAAIA,QAAQ,CAACC,MAAM,IAAI,aAAID,QAAQ,CAACC,MAAM,KAAK,GAAG;0BAAA;0BAAA;wBAAA;wBACpE5B,KAAK,CAACC,GAAG,CAAC,iCAAiC,GAAGuB,MAAM,CAAC;wBAAA;wBAAA;sBAAA;wBAErDxB,KAAK,CAACC,GAAG,CAAC,yCAAyC,GAAGuB,MAAM,CAAC;wBAC7D;wBAAA,MACO,IAAIK,KAAK,eAAQ,aAAIC,OAAO,8BAAoBN,MAAM,EAAG;sBAAA;wBAAA,MAIhEnB,KAAK,KAAK,CAAC;0BAAA;0BAAA;wBAAA;wBAAA,kCAAS,IAAI;sBAAA;wBAAA;wBAAA,OAERF,cAAc,CAACqB,MAAM,EAAEnB,KAAK,GAAG,CAAC,CAAC;sBAAA;wBAA/C0B,KAAK;wBAAA,IACNA,KAAK;0BAAA;0BAAA;wBAAA;wBAAA,kCAAS,IAAI;sBAAA;wBAAA;wBAAA,OACjBvC,iBAAK,CAACyB,OAAO,CAACC,IAAI,CAACa,KAAK,CAAC;sBAAA;wBACzBC,OAAO,GAAGxC,iBAAK,CAACiC,IAAI,CAACM,KAAK,EAAEhD,EAAE,CAAC2C,GAAG,CAAC,UAAU,CAAC,CAAC;wBAAA;wBAAA,OAChClB,YAAY,CAACwB,OAAO,CAAC;sBAAA;wBAApCC,MAAM;wBAAA,kCACLA,MAAM;sBAAA;sBAAA;wBAAA;oBAAA;kBAAA;gBAAA,CACd;gBAAA;cAAA;cA3Dc9B,cAAc;gBAAA;cAAA;cADvBa,cAAc,GAAG,IAAI;cA4DzB;cAEIF,MAAM,GAAG,IAAI,CAACoB,oBAAoB,CAACjD,IAAI,CAAC,CAACH,GAAG,EAAE;cAAA;cAAA,OAChCqB,cAAc,CAACW,MAAM,EAAE,CAAC,CAAC;YAAA;cAAvCqB,KAAK;cAAA,KACPA,KAAK;gBAAA;gBAAA;cAAA;cACDzC,GAAG,GAAGF,iBAAK,CAACC,GAAG,CAAC0C,KAAK,CAAC5C,GAAG,GAAG,IAAI,CAACb,YAAY,CAAC;cAAA,kCAC7C,IAAI,CAAC0D,oBAAoB,CAAC1C,GAAG,CAAC;YAAA;cAAA,kCAEhC,IAAI;YAAA;YAAA;cAAA;UAAA;QAAA;MAAA,CACZ;MAAA;QAAA;MAAA;MAAA;IAAA,IAAC;EAAA;IAAA;IAAA;MAAA,+FAEF,kBAAiBQ,SAAS;QAAA,gCAITmC,iBAAiB;QAAA;UAAA;YAAA;cAAA;gBAAA,mGAAhC,kBAAkCb,MAAM;kBAAA,IAC7BjB,QAAQ;kBAAA;oBAAA;sBAAA;wBAARA,QAAQ,uBAAEc,CAAC,EAAE;0BACpB,IAAMC,IAAI,GAAGD,CAAC,CAAC9B,GAAG,CACfO,KAAK,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CACZT,KAAK,CAAC,GAAG,CAAC,CACVS,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;0BACf,IAAI,CAAC,YAAY,CAACyB,QAAQ,CAACD,IAAI,CAAC,CAAC,CAAC,CAAC,EAAE,OAAO,KAAK,EAAC;0BAClD,OAAO,IAAI;wBACb,CAAC;wBACDtB,KAAK,CAACC,GAAG,CAAC,qBAAqB,GAAGuB,MAAM,CAAC;wBACzC,OAAOc,aAAa,CAACC,SAAS,CAACf,MAAM,CAACjC,GAAG,CAAC;wBAC1C;wBAAA;wBAAA,OACM+C,aAAa,CAACpB,IAAI,CAACM,MAAM,EAAE;0BAAEgB,KAAK,EAAE;wBAAK,CAAC,CAAC;sBAAA;wBAAC;wBAClD;wBACA;wBAEIC,IAAI,GAAGC,WAAW,CAACjB,IAAI,CAACD,MAAM,EAAEzC,EAAE,CAAC2C,GAAG,CAAC,UAAU,CAAC,CAAC;wBACvDe,IAAI,GAAGA,IAAI,CAAC/B,MAAM,CAACH,QAAQ,CAAC;wBAAA,MACxBkC,IAAI,CAAC7C,MAAM,KAAK,CAAC;0BAAA;0BAAA;wBAAA;wBAAA,MACb,IAAIiC,KAAK,CAAC,uCAAuC,GAAGL,MAAM,CAAC;sBAAA;wBAGnEiB,IAAI,CAAC9B,IAAI,EAAE;wBACX,IAAIT,SAAS,EAAEuC,IAAI,CAAC7B,OAAO,EAAE;wBAAA,kCACtB6B,IAAI,CAAC,CAAC,CAAC;sBAAA;sBAAA;wBAAA;oBAAA;kBAAA;gBAAA,CACf;gBAAA;cAAA;cAzBcJ,iBAAiB;gBAAA;cAAA;cAHhC;cACMK,WAAW,GAAGC,IAAI,CAACC,KAAK,EAAE;cAC1BN,aAAa,GAAG,IAAIK,IAAI,CAACE,OAAO,CAACH,WAAW,CAAC;cAAA;cAAA,OA2BnCL,iBAAiB,CAAC,IAAI,CAACzD,IAAI,CAACE,GAAG,EAAE,CAAC;YAAA;cAA5CgE,CAAC;cAAA;cAAA,OACaT,iBAAiB,CAACS,CAAC,CAAC;YAAA;cAAlCC,KAAK;cAAA;cAAA,OACKV,iBAAiB,CAACU,KAAK,CAAC;YAAA;cAAlCC,CAAC;cACDjC,YAAY,GAAG4B,IAAI,CAAClD,GAAG,CAACuD,CAAC,CAACzD,GAAG,GAAG,UAAU,CAAC;cAAA;cAAA,OAC3C+C,aAAa,CAACpB,IAAI,CAACH,YAAY,CAAC;YAAA;cAChCkC,WAAW,GAAGP,WAAW,CAACjB,IAAI,CAClC,IAAI,CAAC7C,IAAI,EACT,IAAI,CAACD,kBAAkB,EACvB,IAAI,EACJoC,YAAY,CACb;cAAA,MACGkC,WAAW,CAACrD,MAAM,KAAK,CAAC;gBAAA;gBAAA;cAAA;cACpBsD,GAAG,GACP,gDAAgD,GAAGnC,YAAY;cACjEf,KAAK,CAACmD,KAAK,CAACD,GAAG,CAAC;cAAA,MACV,IAAIrB,KAAK,CAACqB,GAAG,CAAC;YAAA;cAEhBE,MAAM,GAAGH,WAAW,CAACI,GAAG,CAAC,UAAAC,UAAU;gBAAA,OAAI,CAC3CZ,WAAW,CAACa,GAAG,CAACD,UAAU,EAAEvE,EAAE,CAACqC,GAAG,CAAC,SAAS,CAAC,CAAC,EAC9CkC,UAAU,CACX;cAAA,EAAC;cACFF,MAAM,CAACzC,IAAI,EAAE;cACb,IAAIT,SAAS,EAAEkD,MAAM,CAACxC,OAAO,EAAE;cAC/BZ,KAAK,CAACC,GAAG,CACP,CAACC,SAAS,GAAG,QAAQ,GAAG,UAAU,IAAI,iBAAiB,GAAGkD,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CACvE;cAAA,kCACMA,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;YAAA;YAAA;cAAA;UAAA;QAAA;MAAA,CACpB;MAAA;QAAA;MAAA;MAAA;IAAA,IAAC;EAAA;EAAA;AAAA,KACF;AAAA"}