{"version":3,"file":"acl-control.js","names":["global","window","preventBrowserDropEventsDone","Symbol","preventBrowserDropEvents","document","log","addEventListener","handleDrop","preventDrag","e","stopPropagation","preventDefault","dataTransfer","files","length","confirm","dropEffect","shortNameForFolder","x","str","uri","slice","slash","lastIndexOf","ACLControlBox5","subject","context","noun","kb","dom","doc","classes","getClasses","head","styles","container","createElement","classList","add","aclControlBoxContainer","header","appendChild","textContent","utils","label","aclControlBoxHeader","status","aclControlBoxStatus","loadController","then","controller","render","error","innerText","Promise","resolve","reject","getACLorDefault","ok","isDirectACL","targetDoc","targetACLDoc","defaultHolder","defaultACLDoc","getController","prospectiveDefaultHolder","AccessController","targetIsProtected","Error","targetDirectory","getDirectory","isStorage","hasProtectedAcl","getProspectiveHolder","warn","split","p","q","indexOf","aclDoc","store","holds","ns","rdf","space","site","setGlobalWindow"],"sources":["../../src/acl/acl-control.ts"],"sourcesContent":["/**\n * Functions for rendering the ACL User Interface.\n * See https://github.com/solidos/userguide/blob/main/views/sharing/userguide.md#view\n * for a screenshot.\n * @packageDocumentation\n */\n\nimport * as ns from '../ns'\nimport * as utils from '../utils'\nimport { getACLorDefault, getProspectiveHolder } from './acl'\nimport { Store, NamedNode } from 'rdflib'\nimport { DataBrowserContext } from 'pane-registry'\nimport { AccessController } from './access-controller'\nimport { getClasses } from '../jss'\nimport { styles } from './styles'\nimport { log, warn } from '../debug'\n\nlet global: Window = window\nconst preventBrowserDropEventsDone = Symbol('prevent double triggering of drop event')\n\n/**\n * See https://coshx.com/preventing-drag-and-drop-disasters-with-a-chrome-userscript\n * Without this dropping anything onto a browser page will cause chrome etc to jump to diff page\n * throwing away all the user's work.\n *\n * In apps which may use drag and drop, this utility takes care of the fact\n * by default in a browser, an uncaught user drop into a browser window\n * causes the browser to lose all its work in that window and navigate to another page\n *\n * @param document  The DOM\n * @returns void\n */\nexport function preventBrowserDropEvents (document: HTMLDocument): void {\n  log('preventBrowserDropEvents called.')\n  if (typeof global !== 'undefined') {\n    if (global[preventBrowserDropEventsDone]) return\n    global[preventBrowserDropEventsDone] = true\n  }\n\n  document.addEventListener('drop', handleDrop, false)\n  document.addEventListener('dragenter', preventDrag, false)\n  document.addEventListener('dragover', preventDrag, false)\n}\n\n/** @internal */\nexport function preventDrag (e) {\n  e.stopPropagation()\n  e.preventDefault()\n}\n\n/** @internal */\nexport function handleDrop (e) {\n  if (e.dataTransfer.files.length > 0) {\n    if (\n      !global.confirm('Are you sure you want to drop this file here? (Cancel opens it in a new tab)')\n    ) {\n      e.stopPropagation()\n      e.preventDefault()\n      log('@@@@ document-level DROP suppressed: ' + e.dataTransfer.dropEffect\n      )\n    }\n  }\n}\n\n/**\n * Get a folder's own filename in the directory tree. Also works for\n * domain names; the URL protocol ('https://') acts as the tree root\n * with short name '/' (see also test/unit/acl/acl-control.test.ts).\n *\n * ```typescript\n * shortNameForFolder($rdf.namedNode('http://example.com/some/folder/'))\n * // 'folder'\n *\n * shortNameForFolder($rdf.namedNode('http://example.com/some/folder'))\n * // 'folder'\n *\n * shortNameForFolder($rdf.namedNode('http://example.com/'))\n * // 'example.com'\n *\n * shortNameForFolder($rdf.namedNode('http://example.com'))\n * // 'example.com'\n *\n * shortNameForFolder($rdf.namedNode('http://'))\n * // '/'\n * ```\n *\n * It also works with relative URLs:\n * ```typescript\n * shortNameForFolder($rdf.namedNode('../folder/'))\n * // 'folder'\n * ```\n *\n * @param x  RDF Node for the folder URL\n * @returns  Short name for the folder\n */\nexport function shortNameForFolder (x: NamedNode): string {\n  let str = x.uri\n\n  // Strip the trailing slash\n  if (str.slice(-1) === '/') {\n    str = str.slice(0, -1)\n  }\n\n  // Remove the path if present, keeping only the part\n  // after the last slash.\n  const slash = str.lastIndexOf('/')\n  if (slash >= 0) {\n    str = str.slice(slash + 1)\n  }\n  // Return the folder's filename, or '/' if nothing found\n  // (but see https://github.com/solidos/solid-ui/issues/196\n  // regarding whether this happens at the domain root or\n  // not)\n  return str || '/'\n}\n\n/**\n * A wrapper that retrieves ACL data and uses it\n * to render an [[AccessController]] component.\n * Presumably the '5' is a version number of some sort,\n * but all we know is it was already called ACLControlBox5\n * when it was introduced into solid-ui in\n * https://github.com/solidos/solid-ui/commit/948b874bd93e7bf5160e6e224821b888f07d15f3#diff-4192a29f38a0ababd563b36b47eba5bbR54\n */\nexport function ACLControlBox5 (\n  subject: NamedNode,\n  context: DataBrowserContext,\n  noun: string,\n  kb: Store\n): HTMLElement {\n  const dom = context.dom\n  const doc = subject.doc() // The ACL is actually to the doc describing the thing\n  const classes = getClasses(dom.head, styles).classes\n\n  const container = dom.createElement('div')\n  container.classList.add(classes.aclControlBoxContainer)\n\n  const header = container.appendChild(dom.createElement('h1'))\n  header.textContent = `Sharing for ${noun} ${utils.label(subject)}`\n  header.classList.add(classes.aclControlBoxHeader)\n\n  const status = container.appendChild(dom.createElement('div'))\n  status.classList.add(classes.aclControlBoxStatus)\n\n  try {\n    loadController(doc, kb, subject, noun, context, classes, dom, status)\n      .then(controller => container.appendChild(controller.render()))\n  } catch (error) {\n    status.innerText = error\n  }\n\n  return container\n}\n\nasync function loadController (\n  doc: NamedNode,\n  kb: Store,\n  subject: NamedNode,\n  noun: string,\n  context: DataBrowserContext,\n  classes: Record<string, string>,\n  dom: HTMLDocument,\n  status: HTMLElement\n): Promise<AccessController> {\n  return new Promise((resolve, reject) => getACLorDefault(doc, async (\n    ok,\n    isDirectACL,\n    targetDoc,\n    targetACLDoc,\n    defaultHolder,\n    defaultACLDoc\n  ) => {\n    if (!ok) {\n      return reject(new Error(`Error reading ${isDirectACL ? '' : ' default '}ACL. status ${targetDoc}: ${targetACLDoc}`))\n    }\n    const targetDirectory = getDirectory(targetDoc as NamedNode)\n    const targetIsProtected = isStorage(targetDoc as NamedNode, targetACLDoc as NamedNode, kb) || hasProtectedAcl(targetDoc as NamedNode)\n    if (!targetIsProtected && targetDirectory) {\n      try {\n        const prospectiveDefaultHolder = await getProspectiveHolder(targetDirectory)\n        return resolve(getController(prospectiveDefaultHolder))\n      } catch (error) {\n        // No need to show this error in status, but good to warn about it in console\n        warn(error)\n      }\n    }\n    return resolve(getController())\n\n    function getController (prospectiveDefaultHolder?: NamedNode) {\n      return new AccessController(subject, noun, context, status, classes, targetIsProtected, targetDoc as NamedNode, targetACLDoc as NamedNode, defaultHolder as NamedNode,\n        defaultACLDoc as NamedNode, prospectiveDefaultHolder, kb, dom)\n    }\n  }))\n}\n\nfunction getDirectory (doc: NamedNode): string | null {\n  const str = doc.uri.split('#')[0]\n  const p = str.slice(0, -1).lastIndexOf('/')\n  const q = str.indexOf('//')\n  return (q >= 0 && p < q + 2) || p < 0 ? null : str.slice(0, p + 1)\n}\n\nfunction isStorage (doc: NamedNode, aclDoc: NamedNode, store: Store): boolean {\n  // @@ TODO: The methods used for targetIsStorage are HACKs - it should not be relied upon, and work is\n  // @@ underway to standardize a behavior that does not rely upon this hack\n  // @@ hopefully fixed as part of https://github.com/solidos/data-interoperability-panel/issues/10\n  return store.holds(doc, ns.rdf('type'), ns.space('Storage'), aclDoc)\n}\n\nfunction hasProtectedAcl (targetDoc: NamedNode): boolean {\n  // @@ TODO: This is hacky way of knowing whether or not a certain ACL file can be removed\n  // Hopefully we'll find a better, standardized solution to this - https://github.com/solidos/specification/issues/37\n  return targetDoc.uri === targetDoc.site().uri\n}\n\n/** @internal */\nexport function setGlobalWindow (window: Window) {\n  global = window\n}\n"],"mappings":"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"}