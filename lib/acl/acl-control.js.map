{"version":3,"file":"acl-control.js","names":["global","window","preventBrowserDropEventsDone","Symbol","preventBrowserDropEvents","document","log","addEventListener","handleDrop","preventDrag","e","stopPropagation","preventDefault","dataTransfer","files","length","confirm","dropEffect","shortNameForFolder","x","str","uri","slice","slash","lastIndexOf","ACLControlBox5","subject","context","noun","kb","dom","doc","classes","getClasses","head","styles","container","createElement","classList","add","aclControlBoxContainer","header","appendChild","textContent","utils","label","aclControlBoxHeader","status","aclControlBoxStatus","loadController","then","controller","render","error","innerText","Promise","resolve","reject","getACLorDefault","ok","isDirectACL","targetDoc","targetACLDoc","defaultHolder","defaultACLDoc","getController","prospectiveDefaultHolder","AccessController","targetIsProtected","Error","targetDirectory","getDirectory","isStorage","hasProtectedAcl","getProspectiveHolder","warn","split","p","q","indexOf","aclDoc","store","holds","ns","rdf","space","site","setGlobalWindow"],"sources":["../../src/acl/acl-control.ts"],"sourcesContent":["/**\n * Functions for rendering the ACL User Interface.\n * See https://github.com/solidos/userguide/blob/main/views/sharing/userguide.md#view\n * for a screenshot.\n * @packageDocumentation\n */\n\nimport * as ns from '../ns'\nimport * as utils from '../utils'\nimport { getACLorDefault, getProspectiveHolder } from './acl'\nimport { Store, NamedNode } from 'rdflib'\nimport { DataBrowserContext } from 'pane-registry'\nimport { AccessController } from './access-controller'\nimport { getClasses } from '../jss'\nimport { styles } from './styles'\nimport { log, warn } from '../debug'\n\nlet global: Window = window\nconst preventBrowserDropEventsDone = Symbol('prevent double triggering of drop event')\n\n/**\n * See https://coshx.com/preventing-drag-and-drop-disasters-with-a-chrome-userscript\n * Without this dropping anything onto a browser page will cause chrome etc to jump to diff page\n * throwing away all the user's work.\n *\n * In apps which may use drag and drop, this utility takes care of the fact\n * by default in a browser, an uncaught user drop into a browser window\n * causes the browser to lose all its work in that window and navigate to another page\n *\n * @param document  The DOM\n * @returns void\n */\nexport function preventBrowserDropEvents (document: HTMLDocument): void {\n  log('preventBrowserDropEvents called.')\n  if (typeof global !== 'undefined') {\n    if (global[preventBrowserDropEventsDone]) return\n    global[preventBrowserDropEventsDone] = true\n  }\n\n  document.addEventListener('drop', handleDrop, false)\n  document.addEventListener('dragenter', preventDrag, false)\n  document.addEventListener('dragover', preventDrag, false)\n}\n\n/** @internal */\nexport function preventDrag (e) {\n  e.stopPropagation()\n  e.preventDefault()\n}\n\n/** @internal */\nexport function handleDrop (e) {\n  if (e.dataTransfer.files.length > 0) {\n    if (\n      !global.confirm('Are you sure you want to drop this file here? (Cancel opens it in a new tab)')\n    ) {\n      e.stopPropagation()\n      e.preventDefault()\n      log('@@@@ document-level DROP suppressed: ' + e.dataTransfer.dropEffect\n      )\n    }\n  }\n}\n\n/**\n * Get a folder's own filename in the directory tree. Also works for\n * domain names; the URL protocol ('https://') acts as the tree root\n * with short name '/' (see also test/unit/acl/acl-control.test.ts).\n *\n * ```typescript\n * shortNameForFolder($rdf.namedNode('http://example.com/some/folder/'))\n * // 'folder'\n *\n * shortNameForFolder($rdf.namedNode('http://example.com/some/folder'))\n * // 'folder'\n *\n * shortNameForFolder($rdf.namedNode('http://example.com/'))\n * // 'example.com'\n *\n * shortNameForFolder($rdf.namedNode('http://example.com'))\n * // 'example.com'\n *\n * shortNameForFolder($rdf.namedNode('http://'))\n * // '/'\n * ```\n *\n * It also works with relative URLs:\n * ```typescript\n * shortNameForFolder($rdf.namedNode('../folder/'))\n * // 'folder'\n * ```\n *\n * @param x  RDF Node for the folder URL\n * @returns  Short name for the folder\n */\nexport function shortNameForFolder (x: NamedNode): string {\n  let str = x.uri\n\n  // Strip the trailing slash\n  if (str.slice(-1) === '/') {\n    str = str.slice(0, -1)\n  }\n\n  // Remove the path if present, keeping only the part\n  // after the last slash.\n  const slash = str.lastIndexOf('/')\n  if (slash >= 0) {\n    str = str.slice(slash + 1)\n  }\n  // Return the folder's filename, or '/' if nothing found\n  // (but see https://github.com/solidos/solid-ui/issues/196\n  // regarding whether this happens at the domain root or\n  // not)\n  return str || '/'\n}\n\n/**\n * A wrapper that retrieves ACL data and uses it\n * to render an [[AccessController]] component.\n * Presumably the '5' is a version number of some sort,\n * but all we know is it was already called ACLControlBox5\n * when it was introduced into solid-ui in\n * https://github.com/solidos/solid-ui/commit/948b874bd93e7bf5160e6e224821b888f07d15f3#diff-4192a29f38a0ababd563b36b47eba5bbR54\n */\nexport function ACLControlBox5 (\n  subject: NamedNode,\n  context: DataBrowserContext,\n  noun: string,\n  kb: Store\n): HTMLElement {\n  const dom = context.dom\n  const doc = subject.doc() // The ACL is actually to the doc describing the thing\n  const classes = getClasses(dom.head, styles).classes\n\n  const container = dom.createElement('div')\n  container.classList.add(classes.aclControlBoxContainer)\n\n  const header = container.appendChild(dom.createElement('h1'))\n  header.textContent = `Sharing for ${noun} ${utils.label(subject)}`\n  header.classList.add(classes.aclControlBoxHeader)\n\n  const status = container.appendChild(dom.createElement('div'))\n  status.classList.add(classes.aclControlBoxStatus)\n\n  try {\n    loadController(doc, kb, subject, noun, context, classes, dom, status)\n      .then(controller => container.appendChild(controller.render()))\n  } catch (error) {\n    status.innerText = error\n  }\n\n  return container\n}\n\nasync function loadController (\n  doc: NamedNode,\n  kb: Store,\n  subject: NamedNode,\n  noun: string,\n  context: DataBrowserContext,\n  classes: Record<string, string>,\n  dom: HTMLDocument,\n  status: HTMLElement\n): Promise<AccessController> {\n  return new Promise((resolve, reject) => getACLorDefault(doc, async (\n    ok,\n    isDirectACL,\n    targetDoc,\n    targetACLDoc,\n    defaultHolder,\n    defaultACLDoc\n  ) => {\n    if (!ok) {\n      return reject(new Error(`Error reading ${isDirectACL ? '' : ' default '}ACL. status ${targetDoc}: ${targetACLDoc}`))\n    }\n    const targetDirectory = getDirectory(targetDoc as NamedNode)\n    const targetIsProtected = isStorage(targetDoc as NamedNode, targetACLDoc as NamedNode, kb) || hasProtectedAcl(targetDoc as NamedNode)\n    if (!targetIsProtected && targetDirectory) {\n      try {\n        const prospectiveDefaultHolder = await getProspectiveHolder(targetDirectory)\n        return resolve(getController(prospectiveDefaultHolder))\n      } catch (error) {\n        // No need to show this error in status, but good to warn about it in console\n        warn(error)\n      }\n    }\n    return resolve(getController())\n\n    function getController (prospectiveDefaultHolder?: NamedNode) {\n      return new AccessController(subject, noun, context, status, classes, targetIsProtected, targetDoc as NamedNode, targetACLDoc as NamedNode, defaultHolder as NamedNode,\n        defaultACLDoc as NamedNode, prospectiveDefaultHolder, kb, dom)\n    }\n  }))\n}\n\nfunction getDirectory (doc: NamedNode): string | null {\n  const str = doc.uri.split('#')[0]\n  const p = str.slice(0, -1).lastIndexOf('/')\n  const q = str.indexOf('//')\n  return (q >= 0 && p < q + 2) || p < 0 ? null : str.slice(0, p + 1)\n}\n\nfunction isStorage (doc: NamedNode, aclDoc: NamedNode, store: Store): boolean {\n  // @@ TODO: The methods used for targetIsStorage are HACKs - it should not be relied upon, and work is\n  // @@ underway to standardize a behavior that does not rely upon this hack\n  // @@ hopefully fixed as part of https://github.com/solidos/data-interoperability-panel/issues/10\n  return store.holds(doc, ns.rdf('type'), ns.space('Storage'), aclDoc)\n}\n\nfunction hasProtectedAcl (targetDoc: NamedNode): boolean {\n  // @@ TODO: This is hacky way of knowing whether or not a certain ACL file can be removed\n  // Hopefully we'll find a better, standardized solution to this - https://github.com/solidos/specification/issues/37\n  return targetDoc.uri === targetDoc.site().uri\n}\n\n/** @internal */\nexport function setGlobalWindow (window: Window) {\n  global = window\n}\n"],"mappings":"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"}