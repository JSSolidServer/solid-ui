{"version":3,"file":"access-groups.js","names":["ACL","ns","acl","COLLOQUIAL","RECOMMENDED","EXPLANATION","AccessGroups","doc","aclDoc","controller","store","options","defaults","_store","aclMap","readACL","byCombo","ACLbyCombination","addAgentButton","AddAgentButtons","rootElement","dom","createElement","classList","add","classes","accessGroupList","innerHTML","renderGroups","forEach","group","appendChild","isEditable","render","groupElements","comboIndex","combo","kToCombo","push","renderGroup","groupRow","accessGroupListItem","widgets","makeDropTarget","uris","handleDroppedUris","then","error","renderStatus","groupColumns","renderGroupElements","column","groupNameColumn","toggle","innerText","ktToList","groupAgentsColumn","groupAgentsTable","combos","map","pred","obj","renderAgent","agentElement","groupDescriptionElement","personRow","personTR","sym","deleteFunction","deleteAgent","removeChild","comboToRemove","find","comboPred","comboObj","splice","indexOf","save","uri","handleDroppedUri","Promise","all","reject","secondAttempt","agent","findAgent","thing","debug","log","fetcher","load","message","Error","setACLCombo","subject","res","removeAgentFromCombos","k","i","length","y","sort","join","list","kb","types","findTypeURIs","ty","startsWith","split","endsWith","slice","vcard","sameTerm","foaf","rdf","owl","pref","any","solid"],"sources":["../../src/acl/access-groups.ts"],"sourcesContent":["/**\n * Contains the [[AccessGroups]]\n * and [[AccessGroupsOptions]] classes\n * @packageDocumentation\n */\n\nimport { NamedNode, sym, Store } from 'rdflib'\nimport { ACLbyCombination, readACL } from './acl'\nimport * as widgets from '../widgets'\nimport * as ns from '../ns'\nimport { AccessController } from './access-controller'\nimport { AgentMapMap, ComboList, PartialAgentTriple } from './types'\nimport { AddAgentButtons } from './add-agent-buttons'\nimport * as debug from '../debug'\n\nconst ACL = ns.acl\n\nconst COLLOQUIAL = {\n  13: 'Owners',\n  9: 'Owners (write locked)',\n  5: 'Editors',\n  3: 'Posters',\n  2: 'Submitters',\n  1: 'Viewers'\n}\n\nconst RECOMMENDED = {\n  13: true,\n  5: true,\n  3: true,\n  2: true,\n  1: true\n}\n\nconst EXPLANATION = {\n  13: 'can read, write, and control sharing.',\n  9: 'can read and control sharing, currently write-locked.',\n  5: 'can read and change information',\n  3: 'can add new information, and read but not change existing information',\n  2: 'can add new information but not read any',\n  1: 'can read but not change information'\n}\n\n/**\n * Type for the options parameter of [[AccessGroups]]\n */\nexport interface AccessGroupsOptions {\n  defaults?: boolean\n}\n\n/**\n * Renders the table of Owners, Editors, Posters, Submitters, Viewers\n * for https://github.com/solidos/userguide/blob/main/views/sharing/userguide.md\n */\nexport class AccessGroups {\n  private readonly defaults: boolean\n  public byCombo: ComboList\n  public aclMap: AgentMapMap\n  private readonly addAgentButton: AddAgentButtons\n  private readonly rootElement: HTMLElement\n  private _store: Store // @@ was LiveStore but does not need to be connected to web\n\n  constructor (\n    private doc: NamedNode,\n    private aclDoc: NamedNode,\n    public controller: AccessController,\n    store: Store, // @@ was LiveStore\n    private options: AccessGroupsOptions = {}\n  ) {\n    this.defaults = options.defaults || false\n    this._store = store\n    this.aclMap = readACL(doc, aclDoc, store, this.defaults)\n    this.byCombo = ACLbyCombination(this.aclMap)\n    this.addAgentButton = new AddAgentButtons(this)\n    this.rootElement = this.controller.dom.createElement('div')\n    this.rootElement.classList.add(this.controller.classes.accessGroupList)\n  }\n\n  public get store () {\n    return this._store\n  }\n\n  public set store (store) {\n    this._store = store\n    this.aclMap = readACL(this.doc, this.aclDoc, store, this.defaults)\n    this.byCombo = ACLbyCombination(this.aclMap)\n  }\n\n  public render (): HTMLElement {\n    this.rootElement.innerHTML = ''\n    this.renderGroups().forEach(group => this.rootElement.appendChild(group))\n    if (this.controller.isEditable) {\n      this.rootElement.appendChild(this.addAgentButton.render())\n    }\n    return this.rootElement\n  }\n\n  private renderGroups (): HTMLElement[] {\n    const groupElements: HTMLElement[] = []\n    for (let comboIndex = 15; comboIndex > 0; comboIndex--) {\n      const combo = kToCombo(comboIndex)\n      if ((this.controller.isEditable && RECOMMENDED[comboIndex]) || this.byCombo[combo]) {\n        groupElements.push(this.renderGroup(comboIndex, combo))\n      }\n    }\n    return groupElements\n  }\n\n  private renderGroup (comboIndex: number, combo: string): HTMLElement {\n    const groupRow = this.controller.dom.createElement('div')\n    groupRow.classList.add(this.controller.classes.accessGroupListItem)\n    widgets.makeDropTarget(groupRow, (uris) => this.handleDroppedUris(uris, combo)\n      .then(() => this.controller.render())\n      .catch(error => this.controller.renderStatus(error)))\n    const groupColumns = this.renderGroupElements(comboIndex, combo)\n    groupColumns.forEach(column => groupRow.appendChild(column))\n    return groupRow\n  }\n\n  private renderGroupElements (comboIndex, combo): HTMLElement[] {\n    const groupNameColumn = this.controller.dom.createElement('div')\n    groupNameColumn.classList.add(this.controller.classes.group)\n    groupNameColumn.classList.toggle(this.controller.classes[`group-${comboIndex}`], this.controller.isEditable)\n    groupNameColumn.innerText = COLLOQUIAL[comboIndex] || ktToList(comboIndex)\n\n    const groupAgentsColumn = this.controller.dom.createElement('div')\n    groupAgentsColumn.classList.add(this.controller.classes.group)\n    groupAgentsColumn.classList.toggle(this.controller.classes[`group-${comboIndex}`], this.controller.isEditable)\n    const groupAgentsTable = groupAgentsColumn.appendChild(this.controller.dom.createElement('table'))\n    const combos = this.byCombo[combo] || []\n    combos\n      .map(([pred, obj]) => this.renderAgent(groupAgentsTable, combo, pred, obj))\n      .forEach(agentElement => groupAgentsTable.appendChild(agentElement))\n\n    const groupDescriptionElement = this.controller.dom.createElement('div')\n    groupDescriptionElement.classList.add(this.controller.classes.group)\n    groupDescriptionElement.classList.toggle(this.controller.classes[`group-${comboIndex}`], this.controller.isEditable)\n    groupDescriptionElement.innerText = EXPLANATION[comboIndex] || 'Unusual combination'\n\n    return [groupNameColumn, groupAgentsColumn, groupDescriptionElement]\n  }\n\n  private renderAgent (groupAgentsTable, combo, pred, obj): HTMLElement {\n    const personRow = widgets.personTR(this.controller.dom, ACL(pred), sym(obj), this.controller.isEditable\n      ? {\n          deleteFunction: () => this.deleteAgent(combo, pred, obj)\n            .then(() => groupAgentsTable.removeChild(personRow))\n            .catch(error => this.controller.renderStatus(error))\n        }\n      : {})\n    return personRow\n  }\n\n  private async deleteAgent (combo, pred, obj): Promise<void> {\n    const combos = this.byCombo[combo] || []\n    const comboToRemove = combos.find(([comboPred, comboObj]) => comboPred === pred && comboObj === obj)\n    if (comboToRemove) {\n      combos.splice(combos.indexOf(comboToRemove), 1)\n    }\n    await this.controller.save()\n  }\n\n  public async addNewURI (uri: string): Promise<void> {\n    await this.handleDroppedUri(uri, kToCombo(1))\n    await this.controller.save()\n  }\n\n  private async handleDroppedUris (uris: string[], combo: string): Promise<void> {\n    try {\n      await Promise.all(uris.map(uri => this.handleDroppedUri(uri, combo)))\n      await this.controller.save()\n    } catch (error) {\n      return Promise.reject(error)\n    }\n  }\n\n  private async handleDroppedUri (uri: string, combo: string, secondAttempt: boolean = false): Promise<void> {\n    const agent = findAgent(uri, this.store) // eg 'agent', 'origin', agentClass'\n    const thing = sym(uri)\n    if (!agent && !secondAttempt) {\n      debug.log(`   Not obvious: looking up dropped thing ${thing}`)\n      try {\n        await this._store?.fetcher?.load(thing.doc())\n      } catch (error) {\n        const message = `Ignore error looking up dropped thing: ${error}`\n        debug.error(message)\n        return Promise.reject(new Error(message))\n      }\n      return this.handleDroppedUri(uri, combo, true)\n    } else if (!agent) {\n      const error = `   Error: Drop fails to drop appropriate thing! ${uri}`\n      debug.error(error)\n      return Promise.reject(new Error(error))\n    }\n    this.setACLCombo(combo, uri, agent, this.controller.subject)\n  }\n\n  private setACLCombo (combo: string, uri: string, res: PartialAgentTriple, subject: NamedNode): void {\n    if (!(combo in this.byCombo)) {\n      this.byCombo[combo] = []\n    }\n    this.removeAgentFromCombos(uri) // Combos are mutually distinct\n    this.byCombo[combo].push([res.pred, res.obj.uri])\n    debug.log(`ACL: setting access to ${subject} by ${res.pred}: ${res.obj}`)\n  }\n\n  private removeAgentFromCombos (uri: string): void {\n    for (let k = 0; k < 16; k++) {\n      const combos = this.byCombo[kToCombo(k)]\n      if (combos) {\n        for (let i = 0; i < combos.length; i++) {\n          while (i < combos.length && combos[i][1] === uri) {\n            combos.splice(i, 1)\n          }\n        }\n      }\n    }\n  }\n}\n\nfunction kToCombo (k: number): string {\n  const y = ['Read', 'Append', 'Write', 'Control']\n  const combo: string[] = []\n  for (let i = 0; i < 4; i++) {\n    if (k & (1 << i)) {\n      combo.push('http://www.w3.org/ns/auth/acl#' + y[i])\n    }\n  }\n  combo.sort()\n  return combo.join('\\n')\n}\n\nfunction ktToList (k: number): string {\n  let list = ''\n  const y = ['Read', 'Append', 'Write', 'Control']\n  for (let i = 0; i < 4; i++) {\n    if (k & (1 << i)) {\n      list += y[i]\n    }\n  }\n  return list\n}\n\nfunction findAgent (uri, kb): PartialAgentTriple | null {\n  const obj = sym(uri)\n  const types = kb.findTypeURIs(obj)\n  for (const ty in types) {\n    debug.log('    drop object type includes: ' + ty)\n  }\n  // An Origin URI is one like https://fred.github.io eith no trailing slash\n  if (uri.startsWith('http') && uri.split('/').length === 3) {\n    // there is no third slash\n    return { pred: 'origin', obj } // The only way to know an origin alas\n  }\n  // @@ This is an almighty kludge needed because drag and drop adds extra slashes to origins\n  if (\n    uri.startsWith('http') &&\n    uri.split('/').length === 4 &&\n    uri.endsWith('/')\n  ) {\n    // there  IS third slash\n    debug.log('Assuming final slash on dragged origin URI was unintended!')\n    return { pred: 'origin', obj: sym(uri.slice(0, -1)) } // Fix a URI where the drag and drop system has added a spurious slash\n  }\n\n  if (ns.vcard('WebID').uri in types) return { pred: 'agent', obj }\n\n  if (ns.vcard('Group').uri in types) {\n    return { pred: 'agentGroup', obj } // @@ note vcard membership not RDFs\n  }\n  if (\n    obj.sameTerm(ns.foaf('Agent')) ||\n    obj.sameTerm(ns.acl('AuthenticatedAgent')) || // AuthenticatedAgent\n    obj.sameTerm(ns.rdf('Resource')) ||\n    obj.sameTerm(ns.owl('Thing'))\n  ) {\n    return { pred: 'agentClass', obj }\n  }\n  if (\n    ns.vcard('Individual').uri in types ||\n    ns.foaf('Person').uri in types ||\n    ns.foaf('Agent').uri in types\n  ) {\n    const pref = kb.any(obj, ns.foaf('preferredURI'))\n    if (pref) return { pred: 'agent', obj: sym(pref) }\n    return { pred: 'agent', obj }\n  }\n  if (ns.solid('AppProvider').uri in types) {\n    return { pred: 'origin', obj }\n  }\n  if (ns.solid('AppProviderClass').uri in types) {\n    return { pred: 'originClass', obj }\n  }\n  debug.log('    Triage fails for ' + uri)\n  return null\n}\n"],"mappings":"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"}