{"version":3,"file":"access-groups.js","names":["ACL","ns","acl","COLLOQUIAL","RECOMMENDED","EXPLANATION","AccessGroups","doc","aclDoc","controller","store","options","defaults","_store","aclMap","readACL","byCombo","ACLbyCombination","addAgentButton","AddAgentButtons","rootElement","dom","createElement","classList","add","classes","accessGroupList","innerHTML","renderGroups","forEach","group","appendChild","isEditable","render","groupElements","comboIndex","combo","kToCombo","push","renderGroup","groupRow","accessGroupListItem","widgets","makeDropTarget","uris","handleDroppedUris","then","error","renderStatus","groupColumns","renderGroupElements","column","groupNameColumn","toggle","innerText","ktToList","groupAgentsColumn","groupAgentsTable","combos","map","pred","obj","renderAgent","agentElement","groupDescriptionElement","personRow","personTR","sym","deleteFunction","deleteAgent","removeChild","comboToRemove","find","comboPred","comboObj","splice","indexOf","save","uri","handleDroppedUri","Promise","all","reject","secondAttempt","agent","findAgent","thing","debug","log","fetcher","load","message","Error","setACLCombo","subject","res","removeAgentFromCombos","k","i","length","y","sort","join","list","kb","types","findTypeURIs","ty","startsWith","split","endsWith","slice","vcard","sameTerm","foaf","rdf","owl","pref","any","solid"],"sources":["../../src/acl/access-groups.ts"],"sourcesContent":["/**\n * Contains the [[AccessGroups]]\n * and [[AccessGroupsOptions]] classes\n * @packageDocumentation\n */\n\nimport { NamedNode, sym, Store } from 'rdflib'\nimport { ACLbyCombination, readACL } from './acl'\nimport * as widgets from '../widgets'\nimport * as ns from '../ns'\nimport { AccessController } from './access-controller'\nimport { AgentMapMap, ComboList, PartialAgentTriple } from './types'\nimport { AddAgentButtons } from './add-agent-buttons'\nimport * as debug from '../debug'\n\nconst ACL = ns.acl\n\nconst COLLOQUIAL = {\n  13: 'Owners',\n  9: 'Owners (write locked)',\n  5: 'Editors',\n  3: 'Posters',\n  2: 'Submitters',\n  1: 'Viewers'\n}\n\nconst RECOMMENDED = {\n  13: true,\n  5: true,\n  3: true,\n  2: true,\n  1: true\n}\n\nconst EXPLANATION = {\n  13: 'can read, write, and control sharing.',\n  9: 'can read and control sharing, currently write-locked.',\n  5: 'can read and change information',\n  3: 'can add new information, and read but not change existing information',\n  2: 'can add new information but not read any',\n  1: 'can read but not change information'\n}\n\n/**\n * Type for the options parameter of [[AccessGroups]]\n */\nexport interface AccessGroupsOptions {\n  defaults?: boolean\n}\n\n/**\n * Renders the table of Owners, Editors, Posters, Submitters, Viewers\n * for https://github.com/solidos/userguide/blob/main/views/sharing/userguide.md\n */\nexport class AccessGroups {\n  private readonly defaults: boolean\n  public byCombo: ComboList\n  public aclMap: AgentMapMap\n  private readonly addAgentButton: AddAgentButtons\n  private readonly rootElement: HTMLElement\n  private _store: Store // @@ was LiveStore but does not need to be connected to web\n\n  constructor (\n    private doc: NamedNode,\n    private aclDoc: NamedNode,\n    public controller: AccessController,\n    store: Store, // @@ was LiveStore\n    private options: AccessGroupsOptions = {}\n  ) {\n    this.defaults = options.defaults || false\n    this._store = store\n    this.aclMap = readACL(doc, aclDoc, store, this.defaults)\n    this.byCombo = ACLbyCombination(this.aclMap)\n    this.addAgentButton = new AddAgentButtons(this)\n    this.rootElement = this.controller.dom.createElement('div')\n    this.rootElement.classList.add(this.controller.classes.accessGroupList)\n  }\n\n  public get store () {\n    return this._store\n  }\n\n  public set store (store) {\n    this._store = store\n    this.aclMap = readACL(this.doc, this.aclDoc, store, this.defaults)\n    this.byCombo = ACLbyCombination(this.aclMap)\n  }\n\n  public render (): HTMLElement {\n    this.rootElement.innerHTML = ''\n    this.renderGroups().forEach(group => this.rootElement.appendChild(group))\n    if (this.controller.isEditable) {\n      this.rootElement.appendChild(this.addAgentButton.render())\n    }\n    return this.rootElement\n  }\n\n  private renderGroups (): HTMLElement[] {\n    const groupElements: HTMLElement[] = []\n    for (let comboIndex = 15; comboIndex > 0; comboIndex--) {\n      const combo = kToCombo(comboIndex)\n      if ((this.controller.isEditable && RECOMMENDED[comboIndex]) || this.byCombo[combo]) {\n        groupElements.push(this.renderGroup(comboIndex, combo))\n      }\n    }\n    return groupElements\n  }\n\n  private renderGroup (comboIndex: number, combo: string): HTMLElement {\n    const groupRow = this.controller.dom.createElement('div')\n    groupRow.classList.add(this.controller.classes.accessGroupListItem)\n    widgets.makeDropTarget(groupRow, (uris) => this.handleDroppedUris(uris, combo)\n      .then(() => this.controller.render())\n      .catch(error => this.controller.renderStatus(error)))\n    const groupColumns = this.renderGroupElements(comboIndex, combo)\n    groupColumns.forEach(column => groupRow.appendChild(column))\n    return groupRow\n  }\n\n  private renderGroupElements (comboIndex, combo): HTMLElement[] {\n    const groupNameColumn = this.controller.dom.createElement('div')\n    groupNameColumn.classList.add(this.controller.classes.group)\n    groupNameColumn.classList.toggle(this.controller.classes[`group-${comboIndex}`], this.controller.isEditable)\n    groupNameColumn.innerText = COLLOQUIAL[comboIndex] || ktToList(comboIndex)\n\n    const groupAgentsColumn = this.controller.dom.createElement('div')\n    groupAgentsColumn.classList.add(this.controller.classes.group)\n    groupAgentsColumn.classList.toggle(this.controller.classes[`group-${comboIndex}`], this.controller.isEditable)\n    const groupAgentsTable = groupAgentsColumn.appendChild(this.controller.dom.createElement('table'))\n    const combos = this.byCombo[combo] || []\n    combos\n      .map(([pred, obj]) => this.renderAgent(groupAgentsTable, combo, pred, obj))\n      .forEach(agentElement => groupAgentsTable.appendChild(agentElement))\n\n    const groupDescriptionElement = this.controller.dom.createElement('div')\n    groupDescriptionElement.classList.add(this.controller.classes.group)\n    groupDescriptionElement.classList.toggle(this.controller.classes[`group-${comboIndex}`], this.controller.isEditable)\n    groupDescriptionElement.innerText = EXPLANATION[comboIndex] || 'Unusual combination'\n\n    return [groupNameColumn, groupAgentsColumn, groupDescriptionElement]\n  }\n\n  private renderAgent (groupAgentsTable, combo, pred, obj): HTMLElement {\n    const personRow = widgets.personTR(this.controller.dom, ACL(pred), sym(obj), this.controller.isEditable\n      ? {\n          deleteFunction: () => this.deleteAgent(combo, pred, obj)\n            .then(() => groupAgentsTable.removeChild(personRow))\n            .catch(error => this.controller.renderStatus(error))\n        }\n      : {})\n    return personRow\n  }\n\n  private async deleteAgent (combo, pred, obj): Promise<void> {\n    const combos = this.byCombo[combo] || []\n    const comboToRemove = combos.find(([comboPred, comboObj]) => comboPred === pred && comboObj === obj)\n    if (comboToRemove) {\n      combos.splice(combos.indexOf(comboToRemove), 1)\n    }\n    await this.controller.save()\n  }\n\n  public async addNewURI (uri: string): Promise<void> {\n    await this.handleDroppedUri(uri, kToCombo(1))\n    await this.controller.save()\n  }\n\n  private async handleDroppedUris (uris: string[], combo: string): Promise<void> {\n    try {\n      await Promise.all(uris.map(uri => this.handleDroppedUri(uri, combo)))\n      await this.controller.save()\n    } catch (error) {\n      return Promise.reject(error)\n    }\n  }\n\n  private async handleDroppedUri (uri: string, combo: string, secondAttempt: boolean = false): Promise<void> {\n    const agent = findAgent(uri, this.store) // eg 'agent', 'origin', agentClass'\n    const thing = sym(uri)\n    if (!agent && !secondAttempt) {\n      debug.log(`   Not obvious: looking up dropped thing ${thing}`)\n      try {\n        await this._store?.fetcher?.load(thing.doc())\n      } catch (error) {\n        const message = `Ignore error looking up dropped thing: ${error}`\n        debug.error(message)\n        return Promise.reject(new Error(message))\n      }\n      return this.handleDroppedUri(uri, combo, true)\n    } else if (!agent) {\n      const error = `   Error: Drop fails to drop appropriate thing! ${uri}`\n      debug.error(error)\n      return Promise.reject(new Error(error))\n    }\n    this.setACLCombo(combo, uri, agent, this.controller.subject)\n  }\n\n  private setACLCombo (combo: string, uri: string, res: PartialAgentTriple, subject: NamedNode): void {\n    if (!(combo in this.byCombo)) {\n      this.byCombo[combo] = []\n    }\n    this.removeAgentFromCombos(uri) // Combos are mutually distinct\n    this.byCombo[combo].push([res.pred, res.obj.uri])\n    debug.log(`ACL: setting access to ${subject} by ${res.pred}: ${res.obj}`)\n  }\n\n  private removeAgentFromCombos (uri: string): void {\n    for (let k = 0; k < 16; k++) {\n      const combos = this.byCombo[kToCombo(k)]\n      if (combos) {\n        for (let i = 0; i < combos.length; i++) {\n          while (i < combos.length && combos[i][1] === uri) {\n            combos.splice(i, 1)\n          }\n        }\n      }\n    }\n  }\n}\n\nfunction kToCombo (k: number): string {\n  const y = ['Read', 'Append', 'Write', 'Control']\n  const combo: string[] = []\n  for (let i = 0; i < 4; i++) {\n    if (k & (1 << i)) {\n      combo.push('http://www.w3.org/ns/auth/acl#' + y[i])\n    }\n  }\n  combo.sort()\n  return combo.join('\\n')\n}\n\nfunction ktToList (k: number): string {\n  let list = ''\n  const y = ['Read', 'Append', 'Write', 'Control']\n  for (let i = 0; i < 4; i++) {\n    if (k & (1 << i)) {\n      list += y[i]\n    }\n  }\n  return list\n}\n\nfunction findAgent (uri, kb): PartialAgentTriple | null {\n  const obj = sym(uri)\n  const types = kb.findTypeURIs(obj)\n  for (const ty in types) {\n    debug.log('    drop object type includes: ' + ty)\n  }\n  // An Origin URI is one like https://fred.github.io eith no trailing slash\n  if (uri.startsWith('http') && uri.split('/').length === 3) {\n    // there is no third slash\n    return { pred: 'origin', obj } // The only way to know an origin alas\n  }\n  // @@ This is an almighty kludge needed because drag and drop adds extra slashes to origins\n  if (\n    uri.startsWith('http') &&\n    uri.split('/').length === 4 &&\n    uri.endsWith('/')\n  ) {\n    // there  IS third slash\n    debug.log('Assuming final slash on dragged origin URI was unintended!')\n    return { pred: 'origin', obj: sym(uri.slice(0, -1)) } // Fix a URI where the drag and drop system has added a spurious slash\n  }\n\n  if (ns.vcard('WebID').uri in types) return { pred: 'agent', obj }\n\n  if (ns.vcard('Group').uri in types) {\n    return { pred: 'agentGroup', obj } // @@ note vcard membership not RDFs\n  }\n  if (\n    obj.sameTerm(ns.foaf('Agent')) ||\n    obj.sameTerm(ns.acl('AuthenticatedAgent')) || // AuthenticatedAgent\n    obj.sameTerm(ns.rdf('Resource')) ||\n    obj.sameTerm(ns.owl('Thing'))\n  ) {\n    return { pred: 'agentClass', obj }\n  }\n  if (\n    ns.vcard('Individual').uri in types ||\n    ns.foaf('Person').uri in types ||\n    ns.foaf('Agent').uri in types\n  ) {\n    const pref = kb.any(obj, ns.foaf('preferredURI'))\n    if (pref) return { pred: 'agent', obj: sym(pref) }\n    return { pred: 'agent', obj }\n  }\n  if (ns.solid('AppProvider').uri in types) {\n    return { pred: 'origin', obj }\n  }\n  if (ns.solid('AppProviderClass').uri in types) {\n    return { pred: 'originClass', obj }\n  }\n  debug.log('    Triage fails for ' + uri)\n  return null\n}\n"],"mappings":"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"}