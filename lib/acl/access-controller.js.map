{"version":3,"file":"access-controller.js","names":["AccessController","subject","noun","context","statusElement","classes","targetIsProtected","targetDoc","targetACLDoc","defaultHolder","defaultACLDoc","prospectiveDefaultHolder","store","dom","rootElement","createElement","classList","add","aclGroupContent","isContainer","uri","slice","isUsingDefaults","aclDefaultStore","adoptACLDefault","mainCombo","AccessGroups","defaults","defaultsCombo","defaultsDiffer","sameACL","aclMap","innerHTML","renderStatus","defaultHolderLink","appendChild","href","innerText","shortNameForFolder","render","renderRemoveDefaultsController","isEditable","renderAddDefaultsController","renderAddAclsController","renderRemoveAclsController","useDefaultButton","utils","label","bigButton","addEventListener","removeAcls","then","error","addAclButton","addAcls","containerElement","defaultsController","noticeElement","defaultsControllerNotice","button","addDefaults","removeDefaults","message","aclControlBoxStatusRevealed","temporaryStatusInit","setTimeout","temporaryStatusEnd","toggle","debug","Promise","reject","aclGraph","statements","forEach","st","predicate","object","fetcher","putBack","resolve","getProspectiveHolder","warn","fallbackCombo","save","newAClGraph","graph","makeACLGraphbyCombo","byCombo","fetch","_fetch","updater","UpdateManager","put","statementsMatching","undefined","ok","Error","unload","requested","log"],"sources":["../../src/acl/access-controller.ts"],"sourcesContent":["/**\n * Contains the [[AccessController]] class\n * @packageDocumentation\n */\n\nimport { adoptACLDefault, getProspectiveHolder, makeACLGraphbyCombo, sameACL } from './acl'\nimport { fetcher, graph, NamedNode, UpdateManager } from 'rdflib'\nimport { AccessGroups } from './access-groups'\nimport { DataBrowserContext } from 'pane-registry'\nimport { shortNameForFolder } from './acl-control'\nimport * as utils from '../utils'\nimport * as debug from '../debug'\n\n/**\n * Rendered HTML component used in the databrowser's Sharing pane.\n */\nexport class AccessController {\n  public mainCombo: AccessGroups\n  public defaultsCombo: AccessGroups | null\n  private readonly isContainer: boolean\n  private defaultsDiffer: boolean\n  private readonly rootElement: HTMLElement\n  private isUsingDefaults: boolean\n\n  constructor (\n    public subject: NamedNode,\n    public noun: string,\n    public context: DataBrowserContext,\n    private statusElement: HTMLElement,\n    public classes: Record<string, string>,\n    public targetIsProtected: boolean,\n    private targetDoc: NamedNode,\n    private targetACLDoc: NamedNode,\n    private defaultHolder: NamedNode | null,\n    private defaultACLDoc: NamedNode | null,\n    private prospectiveDefaultHolder: NamedNode | undefined,\n    public store,\n    public dom\n  ) {\n    this.rootElement = dom.createElement('div')\n    this.rootElement.classList.add(classes.aclGroupContent)\n    this.isContainer = targetDoc.uri.slice(-1) === '/' // Give default for all directories\n    if (defaultHolder && defaultACLDoc) {\n      this.isUsingDefaults = true\n      const aclDefaultStore = adoptACLDefault(this.targetDoc, targetACLDoc, defaultHolder, defaultACLDoc)\n      this.mainCombo = new AccessGroups(targetDoc, targetACLDoc, this, aclDefaultStore, { defaults: this.isContainer })\n      this.defaultsCombo = null\n      this.defaultsDiffer = false\n    } else {\n      this.isUsingDefaults = false\n      this.mainCombo = new AccessGroups(targetDoc, targetACLDoc, this, store)\n      this.defaultsCombo = new AccessGroups(targetDoc, targetACLDoc, this, store, { defaults: this.isContainer })\n      this.defaultsDiffer = !sameACL(this.mainCombo.aclMap, this.defaultsCombo.aclMap)\n    }\n  }\n\n  public get isEditable (): boolean {\n    return !this.isUsingDefaults\n  }\n\n  public render (): HTMLElement {\n    this.rootElement.innerHTML = ''\n    if (this.isUsingDefaults) {\n      this.renderStatus(`The sharing for this ${this.noun} is the default for folder `)\n      if (this.defaultHolder) {\n        const defaultHolderLink = this.statusElement.appendChild(this.dom.createElement('a'))\n        defaultHolderLink.href = this.defaultHolder.uri\n        defaultHolderLink.innerText = shortNameForFolder(this.defaultHolder)\n      }\n    } else if (!this.defaultsDiffer && this.isContainer) {\n      this.renderStatus('This is also the default for things in this folder.')\n    } else {\n      this.renderStatus('')\n    }\n    this.rootElement.appendChild(this.mainCombo.render())\n    if (this.defaultsCombo && this.defaultsDiffer) {\n      this.rootElement.appendChild(this.renderRemoveDefaultsController())\n      this.rootElement.appendChild(this.defaultsCombo.render())\n    } else if (this.isEditable && this.isContainer) {\n      this.rootElement.appendChild(this.renderAddDefaultsController())\n    }\n    if (!this.targetIsProtected && this.isUsingDefaults) {\n      this.rootElement.appendChild(this.renderAddAclsController())\n    } else if (!this.targetIsProtected) {\n      this.rootElement.appendChild(this.renderRemoveAclsController())\n    }\n    return this.rootElement\n  }\n\n  private renderRemoveAclsController (): HTMLElement {\n    const useDefaultButton = this.dom.createElement('button')\n    useDefaultButton.innerText = `Remove custom sharing settings for this ${this.noun} -- just use default${this.prospectiveDefaultHolder ? ` for ${utils.label(this.prospectiveDefaultHolder)}` : ''}`\n    useDefaultButton.classList.add(this.classes.bigButton)\n    useDefaultButton.addEventListener('click', () => this.removeAcls()\n      .then(() => this.render())\n      .catch(error => this.renderStatus(error)))\n    return useDefaultButton\n  }\n\n  private renderAddAclsController (): HTMLElement {\n    const addAclButton = this.dom.createElement('button')\n    addAclButton.innerText = `Set specific sharing for this ${this.noun}`\n    addAclButton.classList.add(this.classes.bigButton)\n    addAclButton.addEventListener('click', () => this.addAcls()\n      .then(() => this.render())\n      .catch(error => this.renderStatus(error)))\n    return addAclButton\n  }\n\n  private renderAddDefaultsController (): HTMLElement {\n    const containerElement = this.dom.createElement('div')\n    containerElement.classList.add(this.classes.defaultsController)\n\n    const noticeElement = containerElement.appendChild(this.dom.createElement('div'))\n    noticeElement.innerText = 'Sharing for things within the folder currently tracks sharing for the folder.'\n    noticeElement.classList.add(this.classes.defaultsControllerNotice)\n\n    const button = containerElement.appendChild(this.dom.createElement('button'))\n    button.innerText = 'Set the sharing of folder contents separately from the sharing for the folder'\n    button.classList.add(this.classes.bigButton)\n    button.addEventListener('click', () => this.addDefaults()\n      .then(() => this.render()))\n    return containerElement\n  }\n\n  private renderRemoveDefaultsController (): HTMLElement {\n    const containerElement = this.dom.createElement('div')\n    containerElement.classList.add(this.classes.defaultsController)\n\n    const noticeElement = containerElement.appendChild(this.dom.createElement('div'))\n    noticeElement.innerText = 'Access to things within this folder:'\n    noticeElement.classList.add(this.classes.defaultsControllerNotice)\n\n    const button = containerElement.appendChild(this.dom.createElement('button'))\n    button.innerText = 'Set default for folder contents to just track the sharing for the folder'\n    button.classList.add(this.classes.bigButton)\n    button.addEventListener('click', () => this.removeDefaults()\n      .then(() => this.render())\n      .catch(error => this.renderStatus(error)))\n    return containerElement\n  }\n\n  public renderTemporaryStatus (message: string): void {\n    // @@ TODO Introduce better system for error notification to user https://github.com/solidos/mashlib/issues/87\n    this.statusElement.classList.add(this.classes.aclControlBoxStatusRevealed)\n    this.statusElement.innerText = message\n    this.statusElement.classList.add(this.classes.temporaryStatusInit)\n    setTimeout(() => {\n      this.statusElement.classList.add(this.classes.temporaryStatusEnd)\n    })\n    setTimeout(() => {\n      this.statusElement.innerText = ''\n    }, 5000)\n  }\n\n  public renderStatus (message: string): void {\n    // @@ TODO Introduce better system for error notification to user https://github.com/solidos/mashlib/issues/87\n    this.statusElement.classList.toggle(this.classes.aclControlBoxStatusRevealed, !!message)\n    this.statusElement.innerText = message\n  }\n\n  private async addAcls (): Promise<void> {\n    if (!this.defaultHolder || !this.defaultACLDoc) {\n      const message = 'Unable to find defaults to copy'\n      debug.error(message)\n      return Promise.reject(message)\n    }\n    const aclGraph = adoptACLDefault(this.targetDoc, this.targetACLDoc, this.defaultHolder, this.defaultACLDoc)\n    aclGraph.statements.forEach(st => this.store.add(st.subject, st.predicate, st.object, this.targetACLDoc))\n    try {\n      await this.store.fetcher.putBack(this.targetACLDoc)\n      this.isUsingDefaults = false\n      return Promise.resolve()\n    } catch (error) {\n      const message = ` Error writing back access control file! ${error}`\n      debug.error(message)\n      return Promise.reject(message)\n    }\n  }\n\n  private async addDefaults (): Promise<void> {\n    this.defaultsCombo = new AccessGroups(this.targetDoc, this.targetACLDoc, this, this.store, { defaults: true })\n    this.defaultsDiffer = true\n  }\n\n  private async removeAcls (): Promise<void> {\n    try {\n      await this.store.fetcher.delete(this.targetACLDoc.uri, {})\n      this.isUsingDefaults = true\n      try {\n        this.prospectiveDefaultHolder = await getProspectiveHolder(this.targetDoc.uri)\n      } catch (error) {\n        // No need to show this error in status, but good to warn about it in console\n        debug.warn(error)\n      }\n    } catch (error) {\n      const message = `Error deleting access control file: ${this.targetACLDoc}: ${error}`\n      debug.error(message)\n      return Promise.reject(message)\n    }\n  }\n\n  private async removeDefaults (): Promise<void> {\n    const fallbackCombo = this.defaultsCombo\n    try {\n      this.defaultsCombo = null\n      this.defaultsDiffer = false\n      await this.save()\n    } catch (error) {\n      this.defaultsCombo = fallbackCombo\n      this.defaultsDiffer = true\n      debug.error(error)\n      return Promise.reject(error)\n    }\n  }\n\n  public save (): Promise<void> {\n    // build graph\n    const newAClGraph = graph()\n    if (!this.isContainer) {\n      makeACLGraphbyCombo(newAClGraph, this.targetDoc, this.mainCombo.byCombo, this.targetACLDoc, true)\n    } else if (this.defaultsCombo && this.defaultsDiffer) {\n      // Pair of controls\n      makeACLGraphbyCombo(newAClGraph, this.targetDoc, this.mainCombo.byCombo, this.targetACLDoc, true)\n      makeACLGraphbyCombo(newAClGraph, this.targetDoc, this.defaultsCombo.byCombo, this.targetACLDoc, false, true)\n    } else {\n      // Linked controls\n      makeACLGraphbyCombo(newAClGraph, this.targetDoc, this.mainCombo.byCombo, this.targetACLDoc, true, true)\n    }\n\n    // add authenticated fetcher\n    newAClGraph.fetcher = fetcher(newAClGraph, { fetch: this.store.fetcher._fetch })\n    const updater = newAClGraph.updater || new UpdateManager(newAClGraph)\n\n    // save ACL resource\n    return new Promise((resolve, reject) => {\n      updater.put(\n        this.targetACLDoc,\n        newAClGraph.statementsMatching(undefined, undefined, undefined, this.targetACLDoc),\n        'text/turtle',\n        (uri, ok, message) => {\n          if (!ok) {\n            return reject(new Error(`ACL file save failed: ${message}`))\n          }\n          this.store.fetcher.unload(this.targetACLDoc)\n          this.store.add(newAClGraph.statements)\n          this.store.fetcher.requested[this.targetACLDoc.uri] = 'done' // missing: save headers\n          this.mainCombo.store = this.store\n          if (this.defaultsCombo) {\n            this.defaultsCombo.store = this.store\n          }\n          this.defaultsDiffer = !!this.defaultsCombo && !sameACL(this.mainCombo.aclMap, this.defaultsCombo.aclMap)\n          debug.log('ACL modification: success!')\n          resolve()\n        }\n      )\n    })\n  }\n}\n"],"mappings":"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"}