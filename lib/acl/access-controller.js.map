{"version":3,"file":"access-controller.js","names":["AccessController","subject","noun","context","statusElement","classes","targetIsProtected","targetDoc","targetACLDoc","defaultHolder","defaultACLDoc","prospectiveDefaultHolder","store","dom","rootElement","createElement","classList","add","aclGroupContent","isContainer","uri","slice","isUsingDefaults","aclDefaultStore","adoptACLDefault","mainCombo","AccessGroups","defaults","defaultsCombo","defaultsDiffer","sameACL","aclMap","innerHTML","renderStatus","defaultHolderLink","appendChild","href","innerText","shortNameForFolder","render","renderRemoveDefaultsController","isEditable","renderAddDefaultsController","renderAddAclsController","renderRemoveAclsController","useDefaultButton","utils","label","bigButton","addEventListener","removeAcls","then","error","addAclButton","addAcls","containerElement","defaultsController","noticeElement","defaultsControllerNotice","button","addDefaults","removeDefaults","message","aclControlBoxStatusRevealed","temporaryStatusInit","setTimeout","temporaryStatusEnd","toggle","debug","Promise","reject","aclGraph","statements","forEach","st","predicate","object","fetcher","putBack","resolve","getProspectiveHolder","warn","fallbackCombo","save","newAClGraph","graph","makeACLGraphbyCombo","byCombo","fetch","_fetch","updater","UpdateManager","put","statementsMatching","undefined","ok","Error","unload","requested","log"],"sources":["../../src/acl/access-controller.ts"],"sourcesContent":["/**\n * Contains the [[AccessController]] class\n * @packageDocumentation\n */\n\nimport { adoptACLDefault, getProspectiveHolder, makeACLGraphbyCombo, sameACL } from './acl'\nimport { fetcher, graph, NamedNode, UpdateManager } from 'rdflib'\nimport { AccessGroups } from './access-groups'\nimport { DataBrowserContext } from 'pane-registry'\nimport { shortNameForFolder } from './acl-control'\nimport * as utils from '../utils'\nimport * as debug from '../debug'\n\n/**\n * Rendered HTML component used in the databrowser's Sharing pane.\n */\nexport class AccessController {\n  public mainCombo: AccessGroups\n  public defaultsCombo: AccessGroups | null\n  private readonly isContainer: boolean\n  private defaultsDiffer: boolean\n  private readonly rootElement: HTMLElement\n  private isUsingDefaults: boolean\n\n  constructor (\n    public subject: NamedNode,\n    public noun: string,\n    public context: DataBrowserContext,\n    private statusElement: HTMLElement,\n    public classes: Record<string, string>,\n    public targetIsProtected: boolean,\n    private targetDoc: NamedNode,\n    private targetACLDoc: NamedNode,\n    private defaultHolder: NamedNode | null,\n    private defaultACLDoc: NamedNode | null,\n    private prospectiveDefaultHolder: NamedNode | undefined,\n    public store,\n    public dom\n  ) {\n    this.rootElement = dom.createElement('div')\n    this.rootElement.classList.add(classes.aclGroupContent)\n    this.isContainer = targetDoc.uri.slice(-1) === '/' // Give default for all directories\n    if (defaultHolder && defaultACLDoc) {\n      this.isUsingDefaults = true\n      const aclDefaultStore = adoptACLDefault(this.targetDoc, targetACLDoc, defaultHolder, defaultACLDoc)\n      this.mainCombo = new AccessGroups(targetDoc, targetACLDoc, this, aclDefaultStore, { defaults: this.isContainer })\n      this.defaultsCombo = null\n      this.defaultsDiffer = false\n    } else {\n      this.isUsingDefaults = false\n      this.mainCombo = new AccessGroups(targetDoc, targetACLDoc, this, store)\n      this.defaultsCombo = new AccessGroups(targetDoc, targetACLDoc, this, store, { defaults: this.isContainer })\n      this.defaultsDiffer = !sameACL(this.mainCombo.aclMap, this.defaultsCombo.aclMap)\n    }\n  }\n\n  public get isEditable (): boolean {\n    return !this.isUsingDefaults\n  }\n\n  public render (): HTMLElement {\n    this.rootElement.innerHTML = ''\n    if (this.isUsingDefaults) {\n      this.renderStatus(`The sharing for this ${this.noun} is the default for folder `)\n      if (this.defaultHolder) {\n        const defaultHolderLink = this.statusElement.appendChild(this.dom.createElement('a'))\n        defaultHolderLink.href = this.defaultHolder.uri\n        defaultHolderLink.innerText = shortNameForFolder(this.defaultHolder)\n      }\n    } else if (!this.defaultsDiffer && this.isContainer) {\n      this.renderStatus('This is also the default for things in this folder.')\n    } else {\n      this.renderStatus('')\n    }\n    this.rootElement.appendChild(this.mainCombo.render())\n    if (this.defaultsCombo && this.defaultsDiffer) {\n      this.rootElement.appendChild(this.renderRemoveDefaultsController())\n      this.rootElement.appendChild(this.defaultsCombo.render())\n    } else if (this.isEditable && this.isContainer) {\n      this.rootElement.appendChild(this.renderAddDefaultsController())\n    }\n    if (!this.targetIsProtected && this.isUsingDefaults) {\n      this.rootElement.appendChild(this.renderAddAclsController())\n    } else if (!this.targetIsProtected) {\n      this.rootElement.appendChild(this.renderRemoveAclsController())\n    }\n    return this.rootElement\n  }\n\n  private renderRemoveAclsController (): HTMLElement {\n    const useDefaultButton = this.dom.createElement('button')\n    useDefaultButton.innerText = `Remove custom sharing settings for this ${this.noun} -- just use default${this.prospectiveDefaultHolder ? ` for ${utils.label(this.prospectiveDefaultHolder)}` : ''}`\n    useDefaultButton.classList.add(this.classes.bigButton)\n    useDefaultButton.addEventListener('click', () => this.removeAcls()\n      .then(() => this.render())\n      .catch(error => this.renderStatus(error)))\n    return useDefaultButton\n  }\n\n  private renderAddAclsController (): HTMLElement {\n    const addAclButton = this.dom.createElement('button')\n    addAclButton.innerText = `Set specific sharing for this ${this.noun}`\n    addAclButton.classList.add(this.classes.bigButton)\n    addAclButton.addEventListener('click', () => this.addAcls()\n      .then(() => this.render())\n      .catch(error => this.renderStatus(error)))\n    return addAclButton\n  }\n\n  private renderAddDefaultsController (): HTMLElement {\n    const containerElement = this.dom.createElement('div')\n    containerElement.classList.add(this.classes.defaultsController)\n\n    const noticeElement = containerElement.appendChild(this.dom.createElement('div'))\n    noticeElement.innerText = 'Sharing for things within the folder currently tracks sharing for the folder.'\n    noticeElement.classList.add(this.classes.defaultsControllerNotice)\n\n    const button = containerElement.appendChild(this.dom.createElement('button'))\n    button.innerText = 'Set the sharing of folder contents separately from the sharing for the folder'\n    button.classList.add(this.classes.bigButton)\n    button.addEventListener('click', () => this.addDefaults()\n      .then(() => this.render()))\n    return containerElement\n  }\n\n  private renderRemoveDefaultsController (): HTMLElement {\n    const containerElement = this.dom.createElement('div')\n    containerElement.classList.add(this.classes.defaultsController)\n\n    const noticeElement = containerElement.appendChild(this.dom.createElement('div'))\n    noticeElement.innerText = 'Access to things within this folder:'\n    noticeElement.classList.add(this.classes.defaultsControllerNotice)\n\n    const button = containerElement.appendChild(this.dom.createElement('button'))\n    button.innerText = 'Set default for folder contents to just track the sharing for the folder'\n    button.classList.add(this.classes.bigButton)\n    button.addEventListener('click', () => this.removeDefaults()\n      .then(() => this.render())\n      .catch(error => this.renderStatus(error)))\n    return containerElement\n  }\n\n  public renderTemporaryStatus (message: string): void {\n    // @@ TODO Introduce better system for error notification to user https://github.com/solidos/mashlib/issues/87\n    this.statusElement.classList.add(this.classes.aclControlBoxStatusRevealed)\n    this.statusElement.innerText = message\n    this.statusElement.classList.add(this.classes.temporaryStatusInit)\n    setTimeout(() => {\n      this.statusElement.classList.add(this.classes.temporaryStatusEnd)\n    })\n    setTimeout(() => {\n      this.statusElement.innerText = ''\n    }, 5000)\n  }\n\n  public renderStatus (message: string): void {\n    // @@ TODO Introduce better system for error notification to user https://github.com/solidos/mashlib/issues/87\n    this.statusElement.classList.toggle(this.classes.aclControlBoxStatusRevealed, !!message)\n    this.statusElement.innerText = message\n  }\n\n  private async addAcls (): Promise<void> {\n    if (!this.defaultHolder || !this.defaultACLDoc) {\n      const message = 'Unable to find defaults to copy'\n      debug.error(message)\n      return Promise.reject(message)\n    }\n    const aclGraph = adoptACLDefault(this.targetDoc, this.targetACLDoc, this.defaultHolder, this.defaultACLDoc)\n    aclGraph.statements.forEach(st => this.store.add(st.subject, st.predicate, st.object, this.targetACLDoc))\n    try {\n      await this.store.fetcher.putBack(this.targetACLDoc)\n      this.isUsingDefaults = false\n      return Promise.resolve()\n    } catch (error) {\n      const message = ` Error writing back access control file! ${error}`\n      debug.error(message)\n      return Promise.reject(message)\n    }\n  }\n\n  private async addDefaults (): Promise<void> {\n    this.defaultsCombo = new AccessGroups(this.targetDoc, this.targetACLDoc, this, this.store, { defaults: true })\n    this.defaultsDiffer = true\n  }\n\n  private async removeAcls (): Promise<void> {\n    try {\n      await this.store.fetcher.delete(this.targetACLDoc.uri, {})\n      this.isUsingDefaults = true\n      try {\n        this.prospectiveDefaultHolder = await getProspectiveHolder(this.targetDoc.uri)\n      } catch (error) {\n        // No need to show this error in status, but good to warn about it in console\n        debug.warn(error)\n      }\n    } catch (error) {\n      const message = `Error deleting access control file: ${this.targetACLDoc}: ${error}`\n      debug.error(message)\n      return Promise.reject(message)\n    }\n  }\n\n  private async removeDefaults (): Promise<void> {\n    const fallbackCombo = this.defaultsCombo\n    try {\n      this.defaultsCombo = null\n      this.defaultsDiffer = false\n      await this.save()\n    } catch (error) {\n      this.defaultsCombo = fallbackCombo\n      this.defaultsDiffer = true\n      debug.error(error)\n      return Promise.reject(error)\n    }\n  }\n\n  public save (): Promise<void> {\n    // build graph\n    const newAClGraph = graph()\n    if (!this.isContainer) {\n      makeACLGraphbyCombo(newAClGraph, this.targetDoc, this.mainCombo.byCombo, this.targetACLDoc, true)\n    } else if (this.defaultsCombo && this.defaultsDiffer) {\n      // Pair of controls\n      makeACLGraphbyCombo(newAClGraph, this.targetDoc, this.mainCombo.byCombo, this.targetACLDoc, true)\n      makeACLGraphbyCombo(newAClGraph, this.targetDoc, this.defaultsCombo.byCombo, this.targetACLDoc, false, true)\n    } else {\n      // Linked controls\n      makeACLGraphbyCombo(newAClGraph, this.targetDoc, this.mainCombo.byCombo, this.targetACLDoc, true, true)\n    }\n\n    // add authenticated fetcher\n    newAClGraph.fetcher = fetcher(newAClGraph, { fetch: this.store.fetcher._fetch })\n    const updater = newAClGraph.updater || new UpdateManager(newAClGraph)\n\n    // save ACL resource\n    return new Promise((resolve, reject) => {\n      updater.put(\n        this.targetACLDoc,\n        newAClGraph.statementsMatching(undefined, undefined, undefined, this.targetACLDoc),\n        'text/turtle',\n        (uri, ok, message) => {\n          if (!ok) {\n            return reject(new Error(`ACL file save failed: ${message}`))\n          }\n          this.store.fetcher.unload(this.targetACLDoc)\n          this.store.add(newAClGraph.statements)\n          this.store.fetcher.requested[this.targetACLDoc.uri] = 'done' // missing: save headers\n          this.mainCombo.store = this.store\n          if (this.defaultsCombo) {\n            this.defaultsCombo.store = this.store\n          }\n          this.defaultsDiffer = !!this.defaultsCombo && !sameACL(this.mainCombo.aclMap, this.defaultsCombo.aclMap)\n          debug.log('ACL modification: success!')\n          resolve()\n        }\n      )\n    })\n  }\n}\n"],"mappings":"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"}