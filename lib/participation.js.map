{"version":3,"file":"participation.js","names":["ParticipationTableElement","HTMLTableElement","store","solidLogicSingleton","renderPartipants","dom","table","unused1","subject","unused2","options","setAttribute","newRowForParticpation","parp","person","any","ns","wf","tr","createElement","textContent","bg","anyValue","ui","block","personTR","appendChild","td","insertBefore","firstChild","syncTable","parps","each","map","log","cal","sort","participations","p","syncTableToArray","refresh","participationObject","padDoc","me","Promise","resolve","reject","Error","filter","pn","holds","length","candidates","participation","date","push","debug","warn","newThing","ins","st","Date","lightColorHash","updater","update","uri","ok","errorMessage","recordParticipation","refreshable","authn","currentUser","editable","manageParticipation","container","_participation","e","errorMessageBlock"],"sources":["../src/participation.ts"],"sourcesContent":["/* Manage a UI for the particpation of a person in any thing\n*/\n\n// import { currentUser } from './authn/authn'\nimport * as debug from './debug'\nimport { LiveStore, NamedNode, st, UpdateManager } from 'rdflib'\nimport * as ns from './ns'\nimport { personTR, newThing, errorMessageBlock } from './widgets'\nimport { syncTableToArray } from './utils'\nimport { lightColorHash } from './pad'\nimport { log } from './debug'\nimport { solidLogicSingleton, authn } from 'solid-logic'\n\ntype ParticipationOptions = {\n  deleteFunction?: () => {}\n  link?: string\n  draggable?: boolean\n}\n\nclass ParticipationTableElement extends HTMLTableElement {\n  refresh?: () => void\n}\nconst store = solidLogicSingleton.store as LiveStore\n\n/**  Manage participation in this session\n*\n*  @param {Document} dom - the web page loaded into the browser\n*  @param {HTMLTableElement} table - the table element\n*  @param {NamedNode} unused1/document - the document to render (this argument is no longer used, but left in for backwards compatibility)\n*  @param {NamedNode} subject - the thing in which the participation is happening\n*  @param {NamedNode} unused2/me - user that is logged into the pod (this argument is no longer used, but left in for backwards compatibility)\n*  @param {ParticipationOptions} options - the options that can be passed in are deleteFunction, link, and draggable these are used by the personTR button\n*/\nexport function renderPartipants (dom: HTMLDocument, table: ParticipationTableElement, unused1: NamedNode, subject: NamedNode, unused2: NamedNode, options: ParticipationOptions) {\n  table.setAttribute('style', 'margin: 0.8em;')\n\n  const newRowForParticpation = function (parp) {\n    const person = store.any(parp, ns.wf('participant'))\n\n    let tr\n    if (!person) {\n      tr = dom.createElement('tr')\n      tr.textContent = '???' // Don't crash - invalid part'n entry\n      return tr\n    }\n    const bg = store.anyValue(parp, ns.ui('backgroundColor')) || 'white'\n\n    const block = dom.createElement('div')\n    block.setAttribute(\n      'style',\n      'height: 1.5em; width: 1.5em; margin: 0.3em; border 0.01em solid #888; background-color: ' +\n      bg\n    )\n    tr = personTR(dom, null, person, options)\n    table.appendChild(tr)\n    const td = dom.createElement('td')\n    td.setAttribute('style', 'vertical-align: middle;')\n    td.appendChild(block)\n    tr.insertBefore(td, tr.firstChild)\n    return tr\n  }\n\n  const syncTable = function () {\n    const parps = store.each(subject, ns.wf('participation')).map(function (parp) {\n      log('in participants')\n      return [store.anyValue(parp as any, ns.cal('dtstart')) || '9999-12-31', parp]\n    })\n    parps.sort() // List in order of joining\n    const participations = parps.map(function (p) {\n      return p[1]\n    })\n    syncTableToArray(table, participations, newRowForParticpation)\n  }\n  table.refresh = syncTable\n  syncTable()\n  return table\n}\n\n/** Record, or find old, Particpation object\n *\n * A particpaption object is a place to record things specifically about\n * subject and the user, such as preferences, start of membership, etc\n * @param {NamedNode} subject - the thing in which the participation is happening\n * @param {NamedNode} document -  where to record the data\n * @param {NamedNode} me - the logged in user\n *\n */\nexport function participationObject (subject: NamedNode, padDoc: NamedNode, me: NamedNode) {\n  return new Promise(function (resolve, reject) {\n    if (!me) {\n      throw new Error('No user id')\n    }\n\n    const parps = store.each(subject, ns.wf('participation')).filter(function (pn) {\n      return store.holds(pn, ns.wf('participant'), me)\n    })\n    if (parps.length > 1) { // This can happen. https://github.com/solidos/chat-pane/issues/71\n      const candidates: (string | NamedNode) [][] = []\n      for (const participation of parps) {\n        const date = store.anyValue(participation as NamedNode, ns.cal('dtstart'))\n        if (date) {\n          candidates.push([date, participation as NamedNode])\n        }\n      }\n      candidates.sort() // Pick the earliest\n      // @@ Possibly, for extra credit, delete the others, if we have write access\n      debug.warn('Multiple particpation objects, picking earliest, in ' + padDoc)\n      resolve(candidates[0][1])\n      // throw new Error('Multiple records of your participation')\n    }\n    if (parps.length) {\n      // If I am not already recorded\n      resolve(parps[0]) // returns the particpation object\n    } else {\n      const participation = newThing(padDoc)\n      const ins = [\n        st(subject, ns.wf('participation'), participation, padDoc),\n\n        st(participation, ns.wf('participant'), me, padDoc),\n        st(participation, ns.cal('dtstart'), new Date() as any, padDoc),\n        st(\n          participation,\n          ns.ui('backgroundColor'),\n          lightColorHash(me) as any,\n          padDoc\n        )\n      ];\n      (store.updater as UpdateManager).update([], ins, function (uri: string | null | undefined, ok: boolean, errorMessage?: string) {\n        if (!ok) {\n          reject(new Error('Error recording your partipation: ' + errorMessage))\n        } else {\n          resolve(participation)\n        }\n      })\n      resolve(participation)\n    }\n  })\n}\n\n/** Record my participation and display participants\n *\n * @param {NamedNode} subject - the thing in which participation is happening\n * @param {NamedNode} padDoc - the document into which the particpation should be recorded\n * @param {DOMNode} refreshable - a DOM element whose refresh() is to be called if the change works\n *\n */\nexport function recordParticipation (subject: NamedNode, padDoc: NamedNode, refreshable: any) {\n  const me = authn.currentUser()\n  if (!me) return // Not logged in\n\n  const parps = store.each(subject, ns.wf('participation')).filter(function (pn) {\n    return store.holds(pn, ns.wf('participant'), me)\n  })\n  if (parps.length > 1) {\n    throw new Error('Multiple records of your participation')\n  }\n  if (parps.length) {\n    // If I am not already recorded\n    return parps[0] // returns the particpation object\n  } else {\n    if (!(store.updater as UpdateManager).editable(padDoc)) {\n      debug.log('Not recording participation, as no write acesss as ' + me + ' to ' + padDoc)\n      return null\n    }\n    const participation = newThing(padDoc)\n    const ins = [\n      st(subject, ns.wf('participation'), participation, padDoc),\n\n      st(participation, ns.wf('participant'), me, padDoc),\n      st(participation, ns.cal('dtstart'), new Date() as any, padDoc),\n      st(\n        participation,\n        ns.ui('backgroundColor'),\n        lightColorHash(me) as any,\n        padDoc\n      )\n    ];\n    (store.updater as UpdateManager).update([], ins, function (uri: string | null | undefined, ok: boolean, errorMessage?: string) {\n      if (!ok) {\n        throw new Error('Error recording your partipation: ' + errorMessage)\n      }\n      if (refreshable && refreshable.refresh) {\n        refreshable.refresh()\n      }\n      // UI.pad.renderPartipants(dom, table, padDoc, subject, me, options)\n    })\n    return participation\n  }\n}\n\n/**  Record my participation and display participants\n*\n*   @param {Document} dom  - the web page loaded into the browser\n*   @param {HTMLDivElement} container - the container element where the participants should be displayed\n*   @param {NamedNode} document - the document into which the particpation should be shown\n*   @param {NamedNode} subject - the thing in which participation is happening\n*   @param {NamedNode} me - the logged in user\n*   @param {ParticipationOptions} options - the options that can be passed in are deleteFunction, link, and draggable these are used by the personTR button\n*\n*/\nexport function manageParticipation (\n  dom: Document,\n  container: HTMLDivElement,\n  padDoc: NamedNode,\n  subject: NamedNode,\n  me: NamedNode,\n  options: ParticipationOptions\n) {\n  const table = dom.createElement('table')\n  container.appendChild(table)\n  renderPartipants(dom, table, padDoc, subject, me, options)\n  let _participation\n  try {\n    _participation = recordParticipation(subject, padDoc, table)\n  } catch (e) {\n    container.appendChild(\n      errorMessageBlock(\n        dom,\n        'Error recording your partipation: ' + e\n      )\n    ) // Clean up?\n  }\n  return table\n}\n"],"mappings":"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"}