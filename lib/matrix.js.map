{"version":3,"sources":["../src/matrix.js"],"names":["UI","icons","require","ns","rdf","store","solidLogicSingleton","widgets","utils","kb","module","exports","matrixForQuery","dom","query","vx","vy","vvalue","options","whenDone","matrix","createElement","header","corner","appendChild","setAttribute","lastHeader","columns","rows","setCell","cell","x","y","value","firstChild","removeChild","style","textAlign","cellFunction","textContent","label","old","rowFor","y1","toNT","tr","termType","fetcher","nowOrWhenFetched","uri","split","undefined","ok","_body","_response","i","length","fromNT","dataValueNT","ele","nextSibling","yDecreasing","insertBefore","columnNumberFor","x1","xNT","col","xDecreasing","slice","concat","push","row","td","t","j","markOldCells","children","clearOldCells","colsUsed","rowsUsed","set_y","k","set_x","newcolumns","refresh","addCellFromBindings","bindings","colNo"],"mappings":"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","sourcesContent":["//      Build a 2D matrix of values\n//\n//  dom      AKA document\n//  query    a Query object of rdflib.js with a valid pattern\n//  vx       A variable object, the one to be used for the X variable (horiz)\n//  vy       A variable object, the one to be used for the Y variable (vertical)\n//  vvalue       A variable object, the one to be used for the cell value\n//  returns  A DOM element with the matrix in it, which has a .refresh() function.\n//\n// Options:\n//     cellFunction(td, x, y, value)  fill the TD element of a single cell\n//     xDecreasing  set true for x axis to be in decreasiong order.\n//     yDecreasing  set true for y axis to be in decreasiong order.\n//     set_x        array of X values to be define initial rows (order irrelevant)\n//     set_y        array of Y values to be define initial columns\n//\n// Features:\n//   Header row at top (x axis) and left (y-axis) generated automatically.\n//   Extra rows and columns are inserted as needed to hold new data points\n//   matrix.refresh() will re-run the query and adjust the display\n\nconst UI = {\n  icons: require('./iconBase'),\n  ns: require('./ns'),\n  rdf: require('rdflib'),\n  store: require('./logic').solidLogicSingleton.store,\n  widgets: require('./widgets')\n}\n\nconst utils = require('./utils')\nconst kb = UI.store\n\nmodule.exports.matrixForQuery = function (\n  dom,\n  query,\n  vx,\n  vy,\n  vvalue,\n  options,\n  whenDone\n) {\n  const matrix = dom.createElement('table')\n  const header = dom.createElement('tr')\n  const corner = header.appendChild(dom.createElement('td'))\n  corner.setAttribute('class', 'MatrixCorner')\n  matrix.appendChild(header) // just one for now\n  matrix.lastHeader = header // Element before data\n  let columns = [] // Vector\n  const rows = [] // Associative array\n\n  const setCell = function (cell, x, y, value) {\n    while (cell.firstChild) {\n      // Empty any previous\n      cell.removeChild(cell.firstChild)\n    }\n    cell.setAttribute('style', '')\n    cell.style.textAlign = 'center'\n\n    if (options.cellFunction) {\n      options.cellFunction(cell, x, y, value)\n    } else {\n      cell.textContent = utils.label(value)\n      cell.setAttribute('style', 'padding: 0.3em')\n    }\n    delete cell.old\n  }\n\n  const rowFor = function (y1) {\n    const y = y1.toNT()\n    if (rows[y]) return rows[y]\n    const tr = dom.createElement('tr')\n    const header = tr.appendChild(dom.createElement('td'))\n    header.setAttribute('style', 'padding: 0.3em;')\n    header.textContent = utils.label(y1) // first approximation\n    if (y1.termType === 'NamedNode') {\n      kb.fetcher.nowOrWhenFetched(y1.uri.split('#')[0], undefined, function (\n        ok,\n        _body,\n        _response\n      ) {\n        if (ok) header.textContent = utils.label(y1)\n      })\n    }\n    for (let i = 0; i < columns.length; i++) {\n      setCell(\n        tr.appendChild(dom.createElement('td')),\n        UI.rdf.fromNT(columns[i]),\n        y1,\n        null\n      )\n    }\n    tr.dataValueNT = y\n    rows[y] = tr\n    for (let ele = matrix.lastHeader.nextSibling; ele; ele = ele.nextSibling) {\n      // skip header\n      if (\n        (y > ele.dataValueNT && options && options.yDecreasing) ||\n        (y < ele.dataValueNT && !(options && options.yDecreasing))\n      ) {\n        return matrix.insertBefore(tr, ele) // return the tr\n      }\n    }\n    return matrix.appendChild(tr) // return the tr\n  }\n\n  const columnNumberFor = function (x1) {\n    const xNT = x1.toNT() // xNT is a NT string\n    let col = null\n    // These are data columns (not headings)\n    for (let i = 0; i < columns.length; i++) {\n      if (columns[i] === xNT) {\n        return i\n      }\n\n      if (\n        (xNT > columns[i] && options.xDecreasing) ||\n        (xNT < columns[i] && !options.xDecreasing)\n      ) {\n        columns = columns\n          .slice(0, i)\n          .concat([xNT])\n          .concat(columns.slice(i))\n        col = i\n        break\n      }\n    }\n\n    if (col === null) {\n      col = columns.length\n      columns.push(xNT)\n    }\n\n    // col is the number of the new column, starting from 0\n    for (let row = matrix.firstChild; row; row = row.nextSibling) {\n      // For every row header or not\n      const y = row.dataValueNT\n      const td = dom.createElement('td') // Add a new cell\n      td.style.textAlign = 'center'\n      if (row === matrix.firstChild) {\n        td.textContent = utils.label(x1)\n      } else {\n        setCell(td, x1, UI.rdf.fromNT(y), null)\n      }\n      if (col === columns.length - 1) {\n        row.appendChild(td)\n      } else {\n        let t = row.firstChild\n        for (let j = 0; j < col + 1; j++) {\n          // Skip header col too\n          t = t.nextSibling\n        }\n        row.insertBefore(td, t)\n      }\n    }\n    return col\n  }\n\n  const markOldCells = function () {\n    for (let i = 1; i < matrix.children.length; i++) {\n      const row = matrix.children[i]\n      for (let j = 1; j < row.children.length; j++) {\n        row.children[j].old = true\n      }\n    }\n  }\n\n  const clearOldCells = function () {\n    let row, cell\n    const colsUsed = []\n    const rowsUsed = []\n\n    if (options.set_y) {\n      // Knows y values create rows\n      for (var k = 0; k < options.set_y.length; k++) {\n        rowsUsed[options.set_y[k]] = true\n      }\n    }\n    if (options.set_x) {\n      for (k = 0; k < options.set_x.length; k++) {\n        colsUsed[columnNumberFor(options.set_x[k]) + 1] = true\n      }\n    }\n\n    for (let i = 1; i < matrix.children.length; i++) {\n      row = matrix.children[i]\n      for (let j = 1; j < row.children.length; j++) {\n        cell = row.children[j]\n        if (cell.old) {\n          const y = UI.rdf.fromNT(row.dataValueNT)\n          const x = UI.rdf.fromNT(columns[j - 1])\n          setCell(cell, x, y, null)\n        } else {\n          rowsUsed[row.dataValueNT] = true\n          colsUsed[j] = true\n        }\n      }\n    }\n\n    for (let i = 0; i < matrix.children.length; i++) {\n      row = matrix.children[i]\n      if (i > 0 && !rowsUsed[row.dataValueNT]) {\n        delete rows[row.dataValueNT]\n        matrix.removeChild(row)\n      } else {\n        for (let j = row.children.length - 1; j > 0; j--) {\n          // backwards\n          const cell = row.children[j]\n          if (!colsUsed[j]) {\n            row.removeChild(cell)\n          }\n        }\n      }\n    }\n    const newcolumns = []\n    for (let j = 0; j < columns.length; j++) {\n      if (colsUsed[j + 1]) {\n        newcolumns.push(columns[j])\n      }\n    }\n    columns = newcolumns\n  }\n\n  matrix.refresh = function () {\n    markOldCells()\n    kb.query(query, addCellFromBindings, undefined, clearOldCells)\n  }\n\n  var addCellFromBindings = function (bindings) {\n    const x = bindings[vx]\n    const y = bindings[vy]\n    const value = bindings[vvalue]\n    const row = rowFor(y)\n    const colNo = columnNumberFor(x)\n    const cell = row.children[colNo + 1] // number of Y axis headings\n    setCell(cell, x, y, value)\n  }\n\n  if (options.set_y) {\n    // Knows y values create rows\n    for (var k = 0; k < options.set_y.length; k++) {\n      rowFor(options.set_y[k])\n    }\n  }\n  if (options.set_x) {\n    for (k = 0; k < options.set_x.length; k++) {\n      columnNumberFor(options.set_x[k])\n    }\n  }\n\n  kb.query(query, addCellFromBindings, undefined, whenDone) // Populate the matrix\n  return matrix\n}\n"],"file":"matrix.js"}