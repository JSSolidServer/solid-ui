{"version":3,"sources":["../src/solid-logic-move-me.ts"],"names":["ACL_LINK","rdf","sym","ns","SolidLogic","fetcher","store","graph","updater","UpdateManager","url","doc","load","docNode","any","Error","value","profileDocument","withCredentials","cache","me","differentOrigin","window","location","origin","preferencesFile","site","uri","space","status","debug","log","UnauthorizedError","CrossOriginForbiddenError","SameOriginForbiddenError","NotFoundError","FetchError","message","isPublic","each","solid","undefined","cont","ldp","instance","theClass","filter","r","holds","comment","webOperation","data","Date","contentType","del","ins","Promise","resolve","reject","update","ok","errorBody","statements","slice","forEach","remove","bind","Object","setPrototypeOf","prototype","name"],"mappings":"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","sourcesContent":["\nimport * as rdf from 'rdflib'\nimport { NamedNode, Statement, IndexedFomula } from 'rdflib'\nimport solidNamespace from 'solid-namespace'\n\nimport * as debug from './debug'\n\nexport const ACL_LINK = rdf.sym('http://www.iana.org/assignments/link-relations/acl')\n\nconst ns = solidNamespace(rdf)\n\nexport class SolidLogic {\n  store: IndexedFomula\n  constructor (fetcher: { fetch: () => any }) {\n    this.store = rdf.graph() // Make a Quad store\n    rdf.fetcher(this.store, fetcher) // Attach a web I/O module, store.fetcher\n    this.store.updater = new rdf.UpdateManager(this.store) // Add real-time live updates store.updater\n  }\n\n  async findAclDocUrl (url: string | NamedNode) {\n    const doc = this.store.sym(url)\n    await this.store.fetcher.load(doc)\n    const docNode = this.store.any(doc, ACL_LINK)\n    if (!docNode) {\n      throw new Error(`No ACL link discovered for ${url}`)\n    }\n    return docNode.value\n  }\n\n  async loadDoc (profileDocument: NamedNode): Promise<void> {\n    // Load the profile into the knowledge base (fetcher.store)\n    //   withCredentials: Web arch should let us just load by turning off creds helps CORS\n    //   reload: Gets around a specific old Chrome bug caching/origin/cors\n    await this.store.fetcher\n      .load(profileDocument, { withCredentials: false, cache: 'reload' })\n  }\n\n  async loadPreferences (me: NamedNode): Promise<NamedNode> {\n    const preferencesFile = this.store.any(me, ns.space('preferencesFile'))\n\n    /**\n     * Are we working cross-origin?\n     * Returns True if we are in a webapp at an origin, and the file origin is different\n     */\n    function differentOrigin (): boolean {\n      return `${window.location.origin}/` !== preferencesFile.site().uri\n    }\n\n    if (!preferencesFile) {\n      throw new Error(`Can't find a preference file pointer in profile ${me.doc()}`)\n    }\n\n    // //// Load preference file\n    try {\n      this.store.fetcher\n        .load(preferencesFile, { withCredentials: true })\n    } catch (err) {\n      // Really important to look at why\n      const status = err.status\n      debug.log(\n        `HTTP status ${status} for preference file ${preferencesFile}`\n      )\n      if (status === 401) {\n        throw new UnauthorizedError()\n      }\n      if (status === 403) {\n        if (differentOrigin()) {\n          throw new CrossOriginForbiddenError()\n        }\n        throw new SameOriginForbiddenError()\n      }\n      if (status === 404) {\n        throw new NotFoundError(preferencesFile)\n      }\n      throw new FetchError(err.status, err.message)\n    }\n    return preferencesFile\n  }\n\n  getTypeIndex (me: NamedNode | string, preferencesFile: NamedNode | string, isPublic: boolean): NamedNode[] {\n    return this.store.each(\n      me,\n      (isPublic ? ns.solid('publicTypeIndex') : ns.solid('privateTypeIndex')),\n      undefined,\n      preferencesFile\n    )\n  }\n\n  getContainerElements (cont: NamedNode) {\n    return this.store.each(cont, ns.ldp('contains'))\n  }\n\n  getRegistrations (instance, theClass) {\n    return this.store\n      .each(undefined, ns.solid('instance'), instance)\n      .filter((r) => {\n        return this.store.holds(r, ns.solid('forClass'), theClass)\n      })\n  }\n\n  load (doc: NamedNode | string) {\n    return this.store.fetcher.load(doc)\n  }\n\n  async createEmptyRdfDoc (doc: NamedNode, comment: string) {\n    await this.store.fetcher.webOperation('PUT', doc.uri, {\n      data: `# ${new Date()} ${comment}\n`,\n      contentType: 'text/turtle'\n    })\n  }\n\n  // @@@@ use the one in rdflib.js when it is available and delete this\n  updatePromise (\n    del: Array<Statement>,\n    ins: Array<Statement> = []\n  ): Promise<void> {\n    return new Promise((resolve, reject) => {\n      this.store.updater.update(del, ins, function (uri, ok, errorBody) {\n        if (!ok) {\n          reject(new Error(errorBody))\n        } else {\n          resolve()\n        }\n      }) // callback\n    }) // promise\n  }\n\n  clearStore () {\n    this.store.statements.slice().forEach(this.store.remove.bind(this.store))\n  }\n}\n\nexport class UnauthorizedError extends Error {\n  constructor (message?: string) {\n    super(message)\n    // see: typescriptlang.org/docs/handbook/release-notes/typescript-2-2.html\n    Object.setPrototypeOf(this, new.target.prototype) // restore prototype chain\n    this.name = UnauthorizedError.name // stack traces display correctly now\n  }\n}\n\nexport class CrossOriginForbiddenError extends Error {\n  constructor (message?: string) {\n    super(message)\n    // see: typescriptlang.org/docs/handbook/release-notes/typescript-2-2.html\n    Object.setPrototypeOf(this, new.target.prototype) // restore prototype chain\n    this.name = CrossOriginForbiddenError.name // stack traces display correctly now\n  }\n}\n\nexport class SameOriginForbiddenError extends Error {\n  constructor (message?: string) {\n    super(message)\n    // see: typescriptlang.org/docs/handbook/release-notes/typescript-2-2.html\n    Object.setPrototypeOf(this, new.target.prototype) // restore prototype chain\n    this.name = SameOriginForbiddenError.name // stack traces display correctly now\n  }\n}\n\nexport class NotFoundError extends Error {\n  preferencesFile: string\n  constructor (preferencesFile: string, message?: string) {\n    super(message)\n    // see: typescriptlang.org/docs/handbook/release-notes/typescript-2-2.html\n    Object.setPrototypeOf(this, new.target.prototype) // restore prototype chain\n    this.name = NotFoundError.name // stack traces display correctly now\n    this.preferencesFile = preferencesFile\n  }\n}\n\nexport class FetchError extends Error {\n  status: number\n  constructor (status: number, message?: string) {\n    super(message)\n    // see: typescriptlang.org/docs/handbook/release-notes/typescript-2-2.html\n    Object.setPrototypeOf(this, new.target.prototype) // restore prototype chain\n    this.name = FetchError.name // stack traces display correctly now\n    this.status = status\n  }\n}\n"],"file":"solid-logic-move-me.js"}